<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4a90e2">
    <title>SA Crash Data Map 2012-2024</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="saroadcrashmap-icon.svg">
    <link rel="apple-touch-icon" href="saroadcrashmap-icon.svg">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <!-- noUiSlider CSS -->
    <link rel="stylesheet" href="https://unpkg.com/nouislider@15.7.1/dist/nouislider.min.css">

    <!-- Leaflet Draw CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css" />

    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- First Visit Disclaimer Acknowledgment -->
    <div id="firstVisitOverlay" class="first-visit-overlay" style="display: none;">
        <div class="first-visit-popup">
            <h2>Welcome to SA Crash Data Map</h2>
            <p>Before using this application, please acknowledge that you have read and understood the disclaimer.</p>
            <p>This tool provides crash data visualization for educational and informational purposes only.</p>
            <div class="first-visit-actions">
                <a href="#" onclick="openInfoModal('disclaimerModal'); return false;" class="view-disclaimer-link">View Full Disclaimer</a>
                <button onclick="acknowledgeDisclaimer()" class="acknowledge-btn">I Acknowledge</button>
            </div>
        </div>
    </div>

    <div id="map"></div>
    <!-- Draw-mode hint ‚Äî shown via .draw-mode-active on <body> -->
    <div id="drawModeHint" class="draw-mode-hint">
        <span class="draw-mode-hint-text"></span>
        <button class="draw-mode-cancel-btn" onclick="cancelDrawMode()">Cancel</button>
    </div>

    <!-- No results overlay (shown when active filters produce 0 crashes) -->
    <div id="noResultsOverlay" class="no-results-overlay" style="display:none;">
        <div class="no-results-content">
            <div class="no-results-icon">&#9906;</div>
            <div class="no-results-title">No crashes found</div>
            <div class="no-results-sub">Try broadening your filters or clearing the search.</div>
        </div>
    </div>

    <button class="toggle-panel-btn" onclick="togglePanel()">‚ò∞ Filters</button>

    <!-- Active Filters Badge -->
    <div class="active-filters-bar" id="activeFiltersBar">
        <div class="active-filters-bar-header">
            <span class="active-filters-bar-title">üîç No filters</span>
        </div>
        <div class="active-filters-bar-content" id="activeFiltersContent">
            <div class="no-active-filters">Hover to see filter details</div>
        </div>
    </div>

    <div class="controls-panel" id="controlsPanel">
        <div class="panel-header">
            <span>Explorer</span>
            <div class="flex-gap-small">
                <button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle Light/Dark Mode">
                    <span id="themeIcon">‚òÄÔ∏è</span>
                </button>
                <button class="collapse-btn" onclick="togglePanelCollapse()" title="Collapse/Expand">
                    <span id="collapseIcon">‚ñ≤</span>
                </button>
            </div>
        </div>

        <div class="panel-content">
        <!-- Spatial Filters - Side by Side -->
        <div class="spatial-filters-row section-divider">
            <!-- Location Search -->
            <div class="filter-group spatial-filter-col">
                <div class="location-search-header" onclick="toggleLocationSearch()">
                    <span class="header-text">üîç Search</span>
                    <span class="toggle-icon">‚ñº</span>
                </div>
                <div class="location-search-content" id="locationSearchContent">
                    <div class="location-search-inner">
                        <input type="text" id="locationSearch" placeholder="Enter suburb, street, or landmark..."
                            autocomplete="off"
                            oninput="handleLocationInput(this.value)"
                            onkeydown="handleLocationKeydown(event)"
                            class="location-search-input">
                        <div class="location-suggestions" id="locationSuggestions"></div>
                        <div class="radius-container">
                            <label class="radius-label">Radius:</label>
                            <select id="searchRadius" class="radius-select">
                                <option value="0.5">0.5 km</option>
                                <option value="1">1 km</option>
                                <option value="2" selected>2 km</option>
                                <option value="3">3 km</option>
                                <option value="5">5 km</option>
                                <option value="7">7 km</option>
                                <option value="10">10 km</option>
                                <option value="15">15 km</option>
                                <option value="20">20 km</option>
                                <option value="25">25 km</option>
                                <option value="50">50 km</option>
                            </select>
                        </div>
                        <div class="button-row">
                            <button onclick="searchByLocation()" class="apply-filters-btn button-row-item">Search</button>
                            <button onclick="clearLocationSearch()" class="clear-filters-btn button-row-item">Clear</button>
                        </div>
                        <div id="searchResults" class="search-results-box hidden"></div>
                    </div>
                </div>
            </div>

            <!-- Draw Area -->
            <div class="filter-group spatial-filter-col">
                <div class="location-search-header" onclick="toggleDrawAreaSection()">
                    <span class="header-text">&#128208; Draw Area</span>
                    <span class="toggle-icon" id="drawAreaToggleIcon">&#9660;</span>
                </div>
                <div class="location-search-content" id="drawAreaContent">
                    <div class="location-search-inner">
                        <p class="help-text-small" style="margin:0 0 10px;color:var(--text-secondary);">Draw a custom area</p>
                        <div class="button-row" style="gap:6px;">
                            <button onclick="startDrawArea('rectangle')" class="draw-area-btn button-row-item" id="drawRectBtn">
                                <span style="font-size:14px;">&#9645;</span> Rectangle
                            </button>
                            <button onclick="startDrawArea('polygon')" class="draw-area-btn button-row-item" id="drawPolyBtn">
                                <span style="font-size:14px;">&#9651;</span> Polygon
                            </button>
                        </div>
                        <div id="drawAreaStatus" class="draw-area-status" style="display:none;"></div>
                        <button id="drawAreaClearBtn" onclick="clearDrawArea()" class="clear-filters-btn" style="display:none;width:100%;margin-top:8px;">Clear Area</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Basic Filters Group -->
        <div class="basic-filters-group">
            <div class="filter-group">
                <label class="filter-label">Year Range: <span id="yearRangeDisplay">2012 - 2024</span></label>
                <div id="yearRangeSlider" class="year-range-slider-container"></div>
            </div>

            <div class="filter-group">
                <label class="filter-label">Crash Severity</label>
                <div class="checkbox-dropdown" id="severityDropdown">
                    <div class="checkbox-dropdown-trigger" onclick="toggleCheckboxDropdown('severity')">
                        <span id="severityDisplay">All Severities</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </div>
                    <div class="checkbox-dropdown-menu" id="severityMenu">
                        <div class="dropdown-search-wrap">
                            <input type="text" class="dropdown-search" placeholder="Search..." oninput="filterDropdownItems('severity', this.value)">
                        </div>
                        <div class="dropdown-items-list" id="severityItemsList">
                            <div class="checkbox-dropdown-item">
                                <input type="checkbox" id="severity-pdo" value="1: PDO" checked onchange="updateCheckboxDropdownDisplay('severity')">
                                <label for="severity-pdo">PDO (Property Damage Only)</label>
                            </div>
                            <div class="checkbox-dropdown-item">
                                <input type="checkbox" id="severity-mi" value="2: MI" checked onchange="updateCheckboxDropdownDisplay('severity')">
                                <label for="severity-mi">Minor Injury</label>
                            </div>
                            <div class="checkbox-dropdown-item">
                                <input type="checkbox" id="severity-si" value="3: SI" checked onchange="updateCheckboxDropdownDisplay('severity')">
                                <label for="severity-si">Serious Injury</label>
                            </div>
                            <div class="checkbox-dropdown-item">
                                <input type="checkbox" id="severity-fatal" value="4: Fatal" checked onchange="updateCheckboxDropdownDisplay('severity')">
                                <label for="severity-fatal">Fatal</label>
                            </div>
                        </div>
                        <div class="checkbox-dropdown-controls">
                            <button class="checkbox-select-all" onclick="selectAllDropdownItems('severity')">Select All</button>
                            <button class="checkbox-clear-all" onclick="clearAllDropdownItems('severity')">Clear All</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label class="filter-label">Crash Type</label>
                <div class="checkbox-dropdown" id="crashTypeDropdown">
                    <div class="checkbox-dropdown-trigger" onclick="toggleCheckboxDropdown('crashType')">
                        <span id="crashTypeDisplay">All Types</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </div>
                    <div class="checkbox-dropdown-menu" id="crashTypeMenu">
                        <!-- Options will be populated by app.js -->
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label class="filter-label">Area</label>
                <div class="checkbox-dropdown" id="areaDropdown">
                    <div class="checkbox-dropdown-trigger" onclick="toggleCheckboxDropdown('area')">
                        <span id="areaDisplay">All Areas</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </div>
                    <div class="checkbox-dropdown-menu" id="areaMenu">
                        <!-- Options will be populated by app.js -->
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label class="filter-label">Suburb</label>
                <div class="checkbox-dropdown" id="suburbDropdown">
                    <div class="checkbox-dropdown-trigger" onclick="toggleCheckboxDropdown('suburb')">
                        <span id="suburbDisplay">All Suburbs</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </div>
                    <div class="checkbox-dropdown-menu" id="suburbMenu">
                        <!-- Options will be populated by app.js -->
                    </div>
                </div>
            </div>

            <button class="advanced-filters-btn" onclick="openAdvancedFilters()">
                üîß Advanced Filters
                <span id="advancedFilterBadge" class="filter-badge hidden">0</span>
            </button>
        </div>

        <button class="apply-filters-btn" id="applyFilters" onclick="applyFilters()">Apply Filters</button>

        <button class="clear-filters-btn" onclick="clearFilters()">Clear Filters</button>

        <button onclick="shareCurrentView()" class="share-view-btn">
            üîó Share Current View
        </button>

        <div class="layer-controls">
            <div class="filter-label map-layers-label">Map Layers</div>
            <div class="layer-toggle active" id="markersToggle" onclick="toggleLayer('markers')">
                <span>üéØ Markers</span>
                <span id="markersStatus">ON</span>
            </div>
            <div class="layer-toggle" id="densityToggle" onclick="toggleLayer('density')">
                <div class="layer-label-container">
                    <span>üí† Point Density</span>
                    <div class="layer-info-icon" onclick="event.stopPropagation()">
                        ‚ìò
                        <div class="layer-info-tooltip">
                            Best viewed on <strong>Dark</strong> basemap
                        </div>
                    </div>
                </div>
                <span id="densityStatus">OFF</span>
            </div>
            <div class="layer-toggle" id="choroplethToggle">
                <div class="layer-label-container layer-label-flex" onclick="toggleLayer('choropleth')">
                    <span>üó∫Ô∏è Choropleth</span>
                </div>
                <div class="choropleth-mode-pill">
                    <button id="choroplethModeLGA" class="choropleth-mode-btn active" onclick="switchChoroplethMode('lga')">LGA</button>
                    <button id="choroplethModeSuburb" class="choropleth-mode-btn" onclick="switchChoroplethMode('suburb')" disabled title="Loading suburb boundaries...">Suburb</button>
                </div>
                <span id="choroplethStatus" onclick="toggleLayer('choropleth')">OFF</span>
            </div>
        </div>

        <!-- Marker Colour Mode -->
        <div class="filter-group" style="margin-top:8px;">
            <label class="filter-label">Colour Markers By</label>
            <select id="markerColorModeSelect" onchange="setMarkerColorMode(this.value)" style="width:100%;margin-bottom:6px;">
                <option value="severity">Severity</option>
                <option value="crashtype">Crash Type</option>
                <option value="daynight">Day / Night</option>
            </select>
            <div id="markerColorLegend" class="marker-color-legend"></div>
        </div>

        <div class="stats-panel">
            <h3>Statistics</h3>
            <div class="stat-item">
                <span>Total Crashes:</span>
                <span class="stat-value" id="totalCrashes">0</span>
            </div>
            <div class="stat-item">
                <span>Fatalities:</span>
                <span class="stat-value" id="totalFatalities">0</span>
            </div>
            <div class="stat-item">
                <span>Serious Injuries:</span>
                <span class="stat-value" id="totalSerious">0</span>
            </div>
            <div class="stat-item">
                <span>Minor Injuries:</span>
                <span class="stat-value" id="totalMinor">0</span>
            </div>
            <button class="export-btn" onclick="exportFilteredData()" title="Export filtered crash data to CSV">
                Export to CSV
            </button>
            <button class="export-btn" onclick="toggleDataTable()" title="View filtered crashes as a sortable table" style="margin-top:6px;background:var(--bg-secondary);color:var(--text-primary);border:1px solid var(--border);">
                View Data Table
            </button>
        </div>
        </div><!-- End panel-content -->
    </div>

    <!-- Advanced Filters Modal -->
    <div id="advancedFiltersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Advanced Filters</h2>
                <button class="modal-close" onclick="closeAdvancedFilters()">&times;</button>
            </div>

            <div class="modal-tabs">
                <button class="tab-btn active" onclick="switchTab('conditions')">Crash Conditions</button>
                <button class="tab-btn" onclick="switchTab('casualties')">Casualties</button>
                <button class="tab-btn" onclick="switchTab('vehicles')">Vehicles & Units</button>
            </div>

            <div class="modal-body">
                <!-- Crash Conditions Tab -->
                <div id="conditionsTab" class="tab-content active">
                    <div class="filter-group">
                        <label class="filter-label">Weather Condition</label>
                        <select id="weather">
                            <option value="all" selected>All Weather</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Day/Night</label>
                        <select id="dayNight">
                            <option value="all" selected>All</option>
                            <option value="Day">Day</option>
                            <option value="Night">Night</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Time of Day (Optional)</label>
                        <div class="time-range-container">
                            <div class="time-range-field">
                                <label class="time-range-label">From:</label>
                                <input type="time" id="timeFrom">
                            </div>
                            <div class="time-range-field">
                                <label class="time-range-label">To:</label>
                                <input type="time" id="timeTo">
                            </div>
                        </div>
                        <div class="help-text-small">Leave empty for all times</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Date Range (Optional)</label>
                        <div class="time-range-container">
                            <div class="time-range-field">
                                <label class="time-range-label">From:</label>
                                <input type="date" id="dateFrom">
                            </div>
                            <div class="time-range-field">
                                <label class="time-range-label">To:</label>
                                <input type="date" id="dateTo">
                            </div>
                        </div>
                        <div class="help-text-small">Leave empty to use year range only</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">DUI Involved</label>
                        <select id="duiInvolved">
                            <option value="all" selected>All</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Road Surface</label>
                        <select id="roadSurface" multiple size="4">
                            <option value="all" selected>All Surfaces</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Moisture Condition</label>
                        <select id="moistureCond" multiple size="4">
                            <option value="all" selected>All Conditions</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Drugs Involved</label>
                        <select id="drugsInvolved">
                            <option value="all" selected>All</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Speed Zone</label>
                        <select id="speedZoneFilter" multiple size="4">
                            <option value="all" selected>All Speed Zones</option>
                        </select>
                        <div class="help-text-small">Speed limit at crash location (km/h)</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Month of Year</label>
                        <select id="monthFilter" multiple size="4">
                            <option value="all" selected>All Months</option>
                            <option value="1">January</option>
                            <option value="2">February</option>
                            <option value="3">March</option>
                            <option value="4">April</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                            <option value="9">September</option>
                            <option value="10">October</option>
                            <option value="11">November</option>
                            <option value="12">December</option>
                        </select>
                    </div>
                </div>

                <!-- Casualties Tab -->
                <div id="casualtiesTab" class="tab-content">
                    <div class="filter-group">
                        <label class="filter-label">Road User Type</label>
                        <select id="roadUserType" multiple size="4">
                            <option value="all" selected>All Road Users</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Age Group</label>
                        <select id="ageGroup" multiple size="4">
                            <option value="all" selected>All Ages</option>
                            <option value="0-17">0-17 (Youth)</option>
                            <option value="18-25">18-25 (Young Adult)</option>
                            <option value="26-35">26-35</option>
                            <option value="36-50">36-50</option>
                            <option value="51-65">51-65</option>
                            <option value="66+">66+ (Senior)</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Casualty Sex</label>
                        <select id="casualtySex" multiple size="3">
                            <option value="all" selected>All</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Injury Extent</label>
                        <select id="injuryExtent" multiple size="4">
                            <option value="all" selected>All Injuries</option>
                            <option value="Fatal">Fatal</option>
                            <option value="Serious injury">Serious Injury</option>
                            <option value="Minor injury">Minor Injury</option>
                            <option value="Not injured">Not Injured</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Seat Belt Usage</label>
                        <select id="seatBelt" multiple size="3">
                            <option value="all" selected>All</option>
                            <option value="Yes">Worn</option>
                            <option value="No">Not Worn</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Helmet Usage</label>
                        <select id="helmet" multiple size="3">
                            <option value="all" selected>All</option>
                            <option value="Worn">Worn</option>
                            <option value="Not Worn">Not Worn</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>
                </div>

                <!-- Vehicles & Units Tab -->
                <div id="vehiclesTab" class="tab-content">
                    <div class="filter-group">
                        <label class="filter-label">Heavy Vehicle Involved</label>
                        <select id="heavyVehicle">
                            <option value="all" selected>All Vehicles</option>
                            <option value="yes">Heavy Vehicles Only</option>
                            <option value="no">No Heavy Vehicles</option>
                        </select>
                        <div class="help-text-small">
                            Heavy vehicles: Trucks (‚â•4.5T), Semi-trailers, B-doubles, Road trains, Buses
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Involved Entities</label>
                        <select id="vehicleType" multiple size="4">
                            <option value="all" selected>All Entities</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Vehicle Year</label>
                        <select id="vehicleYear" multiple size="4">
                            <option value="all" selected>All Years</option>
                            <option value="pre-2000">Before 2000</option>
                            <option value="2000-2010">2000-2010</option>
                            <option value="2011-2020">2011-2020</option>
                            <option value="2021+">2021 or Newer</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Number of Occupants</label>
                        <select id="occupants" multiple size="5">
                            <option value="all" selected>All</option>
                            <option value="1">1 Occupant</option>
                            <option value="2">2 Occupants</option>
                            <option value="3">3 Occupants</option>
                            <option value="4">4 Occupants</option>
                            <option value="5+">5+ Occupants</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Towing</label>
                        <select id="towing">
                            <option value="all" selected>All</option>
                            <option value="Yes">Towing</option>
                            <option value="No">Not Towing</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Rollover Involved</label>
                        <select id="rollover">
                            <option value="all" selected>All</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Fire Involved</label>
                        <select id="fire">
                            <option value="all" selected>All</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">License Type</label>
                        <select id="licenseType" multiple size="4">
                            <option value="all" selected>All License Types</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Vehicle Reg State</label>
                        <select id="vehRegState" multiple size="4">
                            <option value="all" selected>All States</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Direction of Travel</label>
                        <select id="directionTravel" multiple size="4">
                            <option value="all" selected>All Directions</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Unit Movement</label>
                        <select id="unitMovement" multiple size="4">
                            <option value="all" selected>All Movements</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="modal-apply-btn" onclick="applyAdvancedFilters()">Apply Filters</button>
                <button class="modal-cancel-btn" onclick="closeAdvancedFilters()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div>Loading crash data...</div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet MarkerCluster -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <!-- Leaflet Heat (for Density Map) -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <!-- Leaflet Draw (for draw-area spatial filter) -->
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>

    <!-- noUiSlider JS -->
    <script src="https://unpkg.com/nouislider@15.7.1/dist/nouislider.min.js"></script>

    <!-- Pako for gzip decompression -->
    <script src="https://unpkg.com/pako@2.1.0/dist/pako.min.js"></script>

    <!-- Proj4js for coordinate conversion -->
    <script src="https://unpkg.com/proj4@2.9.0/dist/proj4.js"></script>

    <!-- Turf.js for geospatial operations (point-in-polygon) -->
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Service Worker Registration -->
    <script src="sw-register.js"></script>

    <!-- Main Application -->
    <script src="app.js"></script>

    <!-- Analytics Panel -->
    <div class="analytics-panel collapsed" id="analyticsPanel">
        <div class="analytics-header" onclick="toggleAnalyticsPanel()">
            <h3>üìä Analytics</h3>
            <button class="analytics-close-btn" onclick="closeAnalyticsPanel(event)" title="Close">‚úï</button>
        </div>
        <div class="analytics-content">
            <div class="chart-container">
                <div class="chart-header">
                    <h4>Crashes Over Time <span class="chart-info-icon">i<span class="chart-info-tooltip">Total crashes per year or month. In Yearly mode, click a point to filter to that year. Toggle between Yearly and Monthly views using the buttons.</span></span></h4>
                    <div class="chart-header-right">
                        <div class="chart-toggle-btns">
                            <button id="btnYearly" class="chart-toggle-btn active" onclick="setOverTimeMode('yearly')">Yearly</button>
                            <button id="btnMonthly" class="chart-toggle-btn" onclick="setOverTimeMode('monthly')">Monthly</button>
                        </div>
                    </div>
                </div>
                <div id="yearFilterBanner" class="year-filter-banner" style="display:none">
                    <span><strong id="yearBannerLabel"></strong> only</span>
                    <button onclick="clearYearChip()">Remove Filter &times;</button>
                </div>
                <div class="chart-wrapper">
                    <canvas id="crashesOverTimeChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <h4>Crashes by Day of Week <span class="chart-info-icon">i<span class="chart-info-tooltip">Total crashes for each day of the week. Orange bars highlight weekends (Sat &amp; Sun). The dashed line shows the daily average.</span></span></h4>
                </div>
                <div class="chart-wrapper">
                    <canvas id="crashesByDayChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <h4>Crashes by Hour <span class="chart-info-icon">i<span class="chart-info-tooltip">Total crashes by hour of day (12am‚Äì11pm). Bars graduate from blue (fewer) to red (more). The dashed line shows the hourly average.</span></span></h4>
                </div>
                <div class="chart-wrapper">
                    <canvas id="crashesByHourChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <h4>Severity Distribution <span class="chart-info-icon">i<span class="chart-info-tooltip">Breakdown of crashes by severity. Click a segment to filter the map and graphs to that severity only. Click the same segment again to restore.</span></span></h4>
                </div>
                <div class="chart-wrapper">
                    <canvas id="severityDistributionChart"></canvas>
                </div>
                <p class="chart-click-hint">Click a segment to filter by severity</p>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h4>Top Crash Types <span class="chart-info-icon">i<span class="chart-info-tooltip">Top 10 crash types by frequency in the filtered data. Click a bar to solo-filter by that crash type. Click again to restore all types.</span></span></h4>
                </div>
                <div class="chart-wrapper chart-wrapper--tall">
                    <canvas id="crashTypeChart"></canvas>
                </div>
                <p class="chart-click-hint">Click a bar to filter by crash type</p>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h4>Top Areas (LGA) <span class="chart-info-icon">i<span class="chart-info-tooltip">Top 10 Local Government Areas by crash count in the filtered data. Click a bar to filter the map to that LGA. Click again to restore all areas.</span></span></h4>
                </div>
                <div class="chart-wrapper chart-wrapper--tall">
                    <canvas id="topLGAChart"></canvas>
                </div>
                <p class="chart-click-hint">Click a bar to filter by LGA</p>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h4>Weather Conditions <span class="chart-info-icon">i<span class="chart-info-tooltip">Crash count by weather condition. Click a bar to filter the map to that weather condition. Click again to restore all conditions.</span></span></h4>
                </div>
                <div class="chart-wrapper chart-wrapper--tall">
                    <canvas id="weatherChart"></canvas>
                </div>
                <p class="chart-click-hint">Click a bar to filter by weather</p>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h4>Day &times; Hour Heatmap <span class="chart-info-icon">i<span class="chart-info-tooltip">Crash intensity by day of week and hour of day. Darker red = more crashes. Reveals high-risk time windows such as Friday afternoon rush hour or Saturday night.</span></span></h4>
                </div>
                <div id="dayHourHeatmap" class="heatmap-wrap"></div>
            </div>

            <div class="chart-container chart-container--wide">
                <div class="chart-header">
                    <h4>Severity Trend Over Time <span class="chart-info-icon">i<span class="chart-info-tooltip">Fatal crashes, serious injury crashes and minor injury crashes per year. Reveals whether road safety outcomes are improving even when overall crash volumes stay flat.</span></span></h4>
                </div>
                <div class="chart-wrapper">
                    <canvas id="severityTrendChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h4>Crashes by Speed Zone <span class="chart-info-icon">i<span class="chart-info-tooltip">Total crashes grouped by the posted speed limit at the crash location. Reveals whether crashes are concentrated on high-speed rural roads or in lower-speed urban environments.</span></span></h4>
                </div>
                <div class="chart-wrapper chart-wrapper--tall">
                    <canvas id="speedZoneChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h4>Casualties by Road User Type <span class="chart-info-icon">i<span class="chart-info-tooltip">Distribution of casualties by road user category ‚Äî drivers, passengers, pedestrians, cyclists and more. Based on casualty records linked to each crash.</span></span></h4>
                </div>
                <div class="chart-wrapper">
                    <canvas id="roadUserChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h4>Casualty Age Distribution <span class="chart-info-icon">i<span class="chart-info-tooltip">Number of casualties in each age group. Highlights which age groups are most at risk in road crashes.</span></span></h4>
                </div>
                <div class="chart-wrapper">
                    <canvas id="casualtyAgeChart"></canvas>
                </div>
            </div>

            <div class="chart-container chart-container--wide">
                <div class="chart-header">
                    <h4>Crash Type &times; Severity Matrix <span class="chart-info-icon">i<span class="chart-info-tooltip">Each cell shows the proportion of crashes of that type resulting in each severity level. Darker shading means a higher proportion. Identifies which crash types are most likely to cause serious harm.</span></span></h4>
                </div>
                <div id="crashTypeSeverityMatrix" class="heatmap-wrap"></div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h4>Seat Belt Compliance <span class="chart-info-icon">i<span class="chart-info-tooltip">Whether casualties were wearing a seat belt at the time of the crash. Based on casualty records linked to each crash.</span></span></h4>
                </div>
                <div class="chart-wrapper">
                    <canvas id="seatBeltChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h4>Helmet Usage <span class="chart-info-icon">i<span class="chart-info-tooltip">Whether casualties (motorcyclists, cyclists) were wearing a helmet at the time of the crash.</span></span></h4>
                </div>
                <div class="chart-wrapper">
                    <canvas id="helmetChart"></canvas>
                </div>
            </div>

            <div class="chart-container">
                <div class="chart-header">
                    <h4>Casualty Sex Breakdown <span class="chart-info-icon">i<span class="chart-info-tooltip">Number of casualties by sex across all crashes in the filtered data.</span></span></h4>
                </div>
                <div class="chart-wrapper">
                    <canvas id="casualtySexChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Table Panel -->
    <div id="dataTablePanel" class="data-table-panel" style="display:none;">
        <div class="data-table-header">
            <span class="data-table-title">Crash Data Table</span>
            <div class="data-table-controls">
                <span id="dataTableInfo" class="data-table-info"></span>
                <button class="data-table-nav-btn" id="dtPrevBtn" onclick="dtChangePage(-1)">&#8249; Prev</button>
                <button class="data-table-nav-btn" id="dtNextBtn" onclick="dtChangePage(1)">Next &#8250;</button>
                <button class="data-table-close-btn" onclick="toggleDataTable()">&#10005;</button>
            </div>
        </div>
        <div class="data-table-scroll">
            <table id="dataTable" class="data-table">
                <thead>
                    <tr>
                        <th id="dt-th-Year" onclick="dtSort('Year')" class="dt-sortable">Year <span class="dt-sort-icon">&#8597;</span></th>
                        <th id="dt-th-Crash_Date_Time" onclick="dtSort('Crash Date Time')" class="dt-sortable">Date/Time <span class="dt-sort-icon">&#8597;</span></th>
                        <th id="dt-th-Suburb" onclick="dtSort('Suburb')" class="dt-sortable">Suburb <span class="dt-sort-icon">&#8597;</span></th>
                        <th id="dt-th-LGA" onclick="dtSort('LGA')" class="dt-sortable">LGA <span class="dt-sort-icon">&#8597;</span></th>
                        <th id="dt-th-CSEF_Severity" onclick="dtSort('CSEF Severity')" class="dt-sortable">Severity <span class="dt-sort-icon">&#8597;</span></th>
                        <th id="dt-th-Crash_Type" onclick="dtSort('Crash Type')" class="dt-sortable">Crash Type <span class="dt-sort-icon">&#8597;</span></th>
                        <th id="dt-th-Area_Speed" onclick="dtSort('Area Speed')" class="dt-sortable">Speed Zone <span class="dt-sort-icon">&#8597;</span></th>
                        <th id="dt-th-Total_Fats" onclick="dtSort('Total Fats')" class="dt-sortable">Fatal <span class="dt-sort-icon">&#8597;</span></th>
                        <th id="dt-th-Total_SI" onclick="dtSort('Total SI')" class="dt-sortable">SI <span class="dt-sort-icon">&#8597;</span></th>
                        <th id="dt-th-Total_MI" onclick="dtSort('Total MI')" class="dt-sortable">MI <span class="dt-sort-icon">&#8597;</span></th>
                    </tr>
                </thead>
                <tbody id="dataTableBody"></tbody>
            </table>
        </div>
    </div>

    <!-- Disclaimer Modal -->
    <div id="disclaimerModal" class="info-modal">
        <div class="info-modal-header">
            <h1>Disclaimer</h1>
            <button class="info-modal-close" onclick="closeInfoModal('disclaimerModal')">Close</button>
        </div>
        <div class="info-modal-container">
            <div class="important-notice">
                <h3>‚ö†Ô∏è Important Notice</h3>
                <p><strong>This website is provided for informational and visualisation purposes only. It must not be relied upon for legal, insurance, regulatory, enforcement, property, safety, or emergency decision-making.</strong></p>
            </div>

            <div class="info-modal-section">
                <h2>Data Source</h2>
                <p>All crash data displayed on this website is sourced from publicly available datasets published by <strong>Data SA</strong> (Government of South Australia).</p>
                <p>The original datasets can be accessed at: <a href="https://data.sa.gov.au" target="_blank" rel="noopener noreferrer">data.sa.gov.au</a></p>
            </div>

            <div class="info-modal-section">
                <h2>Data Processing</h2>
                <p>The datasets have been cleaned and standardised across yearly releases (2012‚Äì2024) to ensure consistent formatting and comparability. No material alterations have been made to the original published records beyond necessary formatting and structural adjustments.</p>
            </div>

            <div class="info-modal-section">
                <h2>Accuracy & Limitations</h2>
                <p>While reasonable care has been taken to ensure accurate representation of the source data, <strong>no guarantee is provided</strong> regarding the completeness, accuracy, reliability, or timeliness of the information displayed.</p>
                <p>Users should verify information against official government sources where required. The data may contain errors, omissions, or outdated information.</p>
                <p>Geographic coordinates and location information may be approximate and should not be considered precise.</p>
            </div>

            <div class="info-modal-section">
                <h2>Informational Use Only</h2>
                <p>This website is provided for <strong>informational and visualisation purposes only</strong>. The information presented here must not be relied upon for:</p>
                <ul>
                    <li>Legal proceedings or decisions</li>
                    <li>Insurance claims or assessments</li>
                    <li>Regulatory compliance or reporting</li>
                    <li>Law enforcement activities</li>
                    <li>Property valuations or real estate decisions</li>
                    <li>Safety assessments or emergency planning</li>
                    <li>Any other critical or official purpose</li>
                </ul>
                <p>For official information, please consult the relevant South Australian Government agencies and authorities.</p>
            </div>

            <div class="info-modal-section">
                <h2>No Government Affiliation</h2>
                <p>This is an <strong>independent project</strong> and is not affiliated with, endorsed by, or representing the Government of South Australia, Data SA, or any other government agency.</p>
                <p>This website is not an official government resource. All official inquiries should be directed to the appropriate South Australian Government departments.</p>
            </div>

            <div class="info-modal-section">
                <h2>Privacy & Data Protection</h2>
                <p>This website only displays aggregated crash statistics from publicly available datasets. No personal information or identifiable data about individuals involved in crashes is displayed or stored.</p>
                <p>The website does not collect personal information from users beyond standard web server logs.</p>
            </div>

            <div class="info-modal-section">
                <h2>Limitation of Liability</h2>
                <p><strong>Use of this website is at your own risk.</strong> The site owner, contributors, and data providers accept no liability for any loss, damage, injury, or consequences arising directly or indirectly from:</p>
                <ul>
                    <li>The use of this website or its content</li>
                    <li>Reliance on information displayed on this website</li>
                    <li>Errors, omissions, or inaccuracies in the data</li>
                    <li>Unavailability or interruption of service</li>
                    <li>Any decisions made based on information from this website</li>
                </ul>
                <p>To the maximum extent permitted by law, all warranties, express or implied, are excluded.</p>
            </div>

            <div class="info-modal-section">
                <h2>Third-Party Services</h2>
                <p>This website uses third-party services and libraries including Leaflet (mapping), OpenStreetMap (map tiles), and various JavaScript libraries. The site owner is not responsible for the availability, accuracy, or content provided by these third-party services.</p>
            </div>

            <div class="info-modal-section">
                <h2>Changes to This Disclaimer</h2>
                <p>This disclaimer may be updated from time to time without notice. Continued use of this website constitutes acceptance of any changes to this disclaimer.</p>
                <p class="last-updated-text">Last Updated: February 2026</p>
            </div>
        </div>
    </div>

    <!-- Methodology Modal -->
    <div id="methodologyModal" class="info-modal">
        <div class="info-modal-header">
            <h1>Data Processing Methodology</h1>
            <button class="info-modal-close" onclick="closeInfoModal('methodologyModal')">Close</button>
        </div>
        <div class="info-modal-container">
            <div class="info-modal-section">
                <h2>Overview</h2>
                <p>This page documents the data processing methodology used to prepare the South Australian crash data for visualization on this website. The goal is to provide transparency about how the raw data has been transformed and to help users understand any limitations or considerations when interpreting the visualizations.</p>
            </div>

            <div class="info-modal-section">
                <h2>Data Sources</h2>
                <p>All data is sourced from publicly available datasets published by <strong>Data SA</strong> (Government of South Australia):</p>
                <ul>
                    <li><strong>Primary Dataset:</strong> Road Crash Data (2012-2024)</li>
                    <li><strong>Source URL:</strong> <a href="https://data.sa.gov.au" target="_blank" rel="noopener noreferrer">data.sa.gov.au</a></li>
                    <li><strong>Data Format:</strong> CSV (Comma-Separated Values)</li>
                    <li><strong>Update Frequency:</strong> Periodically updated by Data SA</li>
                    <li><strong>Coverage Period:</strong> January 1, 2012 to December 31, 2024</li>
                </ul>
                <div class="info-box">
                    <strong>Note:</strong> The datasets are published by the South Australian Government under open data licensing terms. Please refer to Data SA for the most current and official data.
                </div>
            </div>

            <div class="info-modal-section">
                <h2>Data Processing Steps</h2>

                <h3>1. Data Collection & Consolidation</h3>
                <p>Yearly crash data files (2012-2024) were collected from Data SA and consolidated into a single unified dataset. This process involved:</p>
                <ul>
                    <li>Downloading individual yearly CSV files from Data SA</li>
                    <li>Merging multiple datasets while preserving all original records</li>
                    <li>Creating a combined dataset for efficient querying and visualization</li>
                </ul>

                <h3>2. Data Cleaning & Standardization</h3>
                <p>To ensure consistency across different yearly releases, the following standardization procedures were applied:</p>

                <h4>Column Name Standardization</h4>
                <ul>
                    <li>Inconsistent column names across years were normalized to a common schema</li>
                    <li>Whitespace and special characters in column headers were standardized</li>
                    <li>Column names were made case-consistent for reliable programmatic access</li>
                </ul>

                <h4>Data Type Validation</h4>
                <ul>
                    <li>Numeric fields (e.g., year, casualty counts) validated and converted to appropriate types</li>
                    <li>Date and time fields parsed and standardized to ISO 8601 format where applicable</li>
                    <li>Text fields trimmed of leading/trailing whitespace</li>
                </ul>

                <h4>Missing Data Handling</h4>
                <ul>
                    <li>Empty fields preserved as empty strings (not converted to null/undefined arbitrarily)</li>
                    <li>No imputation or artificial data generation performed</li>
                    <li>Missing geographic coordinates excluded from mapping visualizations</li>
                </ul>

                <h3>3. Geographic Coordinate Processing</h3>
                <p>The crash data includes geographic coordinates that enable map-based visualization:</p>
                <ul>
                    <li><strong>Coordinate System:</strong> Original data uses GDA2020 / MGA Zone 54 (EPSG:7854)</li>
                    <li><strong>Conversion:</strong> Coordinates converted to WGS84 (latitude/longitude) using Proj4js library for web mapping compatibility</li>
                    <li><strong>Validation:</strong> Records with missing or invalid coordinates excluded from map layers</li>
                    <li><strong>Precision:</strong> Coordinates displayed with standard precision; exact crash locations may be approximate</li>
                </ul>

                <div class="info-box">
                    <strong>Important:</strong> Geographic coordinates should be considered approximate. They are suitable for visualization and general analysis but not for precise location-based decisions.
                </div>

                <h3>4. Categorical Data Harmonization</h3>
                <p>Categorical fields (e.g., crash severity, weather conditions, crash type) were standardized:</p>
                <ul>
                    <li>Consistent encoding of categories across years</li>
                    <li>Removal of redundant or duplicate category labels</li>
                    <li>Preservation of original category meanings without reclassification</li>
                </ul>

                <h3>5. Temporal Data Processing</h3>
                <ul>
                    <li>Crash dates and times preserved in original form where available</li>
                    <li>Year extracted and validated for filtering purposes</li>
                    <li>Time-of-day filters support 24-hour format</li>
                </ul>
            </div>

            <div class="info-modal-section">
                <h2>Data Schema</h2>
                <p>The consolidated dataset includes the following key fields:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Field Category</th>
                            <th>Example Fields</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Temporal</strong></td>
                            <td>Year, Date, Time, Day/Night</td>
                            <td>When the crash occurred</td>
                        </tr>
                        <tr>
                            <td><strong>Geographic</strong></td>
                            <td>Latitude, Longitude, Area/LGA, Suburb</td>
                            <td>Where the crash occurred</td>
                        </tr>
                        <tr>
                            <td><strong>Severity</strong></td>
                            <td>Crash Severity, Casualties, Fatalities</td>
                            <td>Impact and outcomes</td>
                        </tr>
                        <tr>
                            <td><strong>Crash Characteristics</strong></td>
                            <td>Crash Type, Weather, Road Surface</td>
                            <td>Conditions and type of crash</td>
                        </tr>
                        <tr>
                            <td><strong>Vehicles & Units</strong></td>
                            <td>Vehicle Type, Heavy Vehicle, Unit Count</td>
                            <td>Vehicles involved in crash</td>
                        </tr>
                        <tr>
                            <td><strong>Casualties</strong></td>
                            <td>Road User Type, Age, Sex, Injury Extent</td>
                            <td>People affected by crash</td>
                        </tr>
                        <tr>
                            <td><strong>Contributing Factors</strong></td>
                            <td>DUI, Drugs, Speed, Seat Belt</td>
                            <td>Factors related to crash occurrence</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="info-modal-section">
                <h2>Visualization Processing</h2>

                <h3>Marker Clustering</h3>
                <ul>
                    <li>Individual crash points clustered using Leaflet MarkerCluster library</li>
                    <li>Clustering performed client-side for responsive interaction</li>
                    <li>Cluster size indicates number of crashes in geographic proximity</li>
                </ul>

                <h3>Density Map Visualization</h3>
                <ul>
                    <li>Point density layer generated using Leaflet.heat library with tight radius settings</li>
                    <li>Individual crashes rendered with minimal blur for precise location visualization</li>
                    <li>Color intensity represents both crash density and severity weighting</li>
                    <li>Severity-weighted: Fatal (4x), Serious Injury (3x), Minor Injury (2x), PDO (1x)</li>
                    <li>Radius and blur scale with zoom level for optimal viewing at all scales</li>
                    <li>Follows road patterns naturally, creating linear density corridors</li>
                </ul>

                <h3>Choropleth Mapping</h3>
                <ul>
                    <li>LGA (Local Government Area) boundaries used for choropleth visualization</li>
                    <li>Crash counts aggregated by geographic region</li>
                    <li>Color intensity proportional to crash frequency</li>
                </ul>
            </div>

            <div class="info-modal-section">
                <h2>Filtering & Aggregation</h2>
                <p>The website provides extensive filtering capabilities. All filters are applied client-side:</p>
                <ul>
                    <li><strong>Temporal Filters:</strong> Year range, date range, time of day</li>
                    <li><strong>Severity Filters:</strong> Crash severity levels, injury extent</li>
                    <li><strong>Geographic Filters:</strong> LGA/area, location search with radius</li>
                    <li><strong>Condition Filters:</strong> Weather, road surface, day/night</li>
                    <li><strong>Vehicle Filters:</strong> Vehicle type, heavy vehicle involvement</li>
                    <li><strong>Casualty Filters:</strong> Age group, road user type, safety equipment usage</li>
                </ul>
                <p>Statistics are recalculated dynamically based on active filters to show relevant totals and counts.</p>
            </div>

            <div class="info-modal-section">
                <h2>Data Integrity & Quality Assurance</h2>

                <h3>Validation Checks</h3>
                <ul>
                    <li>Record count verification against source datasets</li>
                    <li>Coordinate validity checks (within South Australia bounds)</li>
                    <li>Date and time range validation</li>
                    <li>Categorical value consistency checks</li>
                </ul>

                <h3>Known Limitations</h3>
                <ul>
                    <li>Some records may have incomplete data fields</li>
                    <li>Geographic coordinates are approximate and may not reflect exact crash locations</li>
                    <li>Data is dependent on reporting accuracy and completeness in source datasets</li>
                    <li>Historical data may have different collection or reporting standards than recent data</li>
                    <li>Not all crashes may be represented in the dataset</li>
                </ul>
            </div>

            <div class="info-modal-section">
                <h2>Tools & Technologies</h2>
                <p>The following tools and libraries were used in data processing and visualization:</p>
                <ul>
                    <li><strong>Python:</strong> Data cleaning and consolidation (pandas, csv libraries)</li>
                    <li><strong>Leaflet.js:</strong> Interactive mapping library</li>
                    <li><strong>Proj4js:</strong> Coordinate system transformation</li>
                    <li><strong>Turf.js:</strong> Geospatial analysis and calculations</li>
                    <li><strong>noUiSlider:</strong> Range filter controls</li>
                </ul>
            </div>

            <div class="info-modal-section">
                <h2>Updates & Versioning</h2>
                <p>As new data becomes available from Data SA, the dataset may be updated. Major updates will be documented here with version information and change notes.</p>
                <p><strong>Current Version:</strong> 2012-2024 Dataset (February 2026)</p>
            </div>

            <div class="info-modal-section">
                <h2>Reproducibility & Transparency</h2>
                <p>This project aims to maintain transparency in data processing. Users who wish to verify the processing methodology or reproduce the dataset can:</p>
                <ul>
                    <li>Access the original source data from Data SA</li>
                    <li>Review the processing scripts (available in project repository if open-sourced)</li>
                    <li>Contact the project maintainer with questions or concerns</li>
                </ul>
                <p class="last-updated-text">Last Updated: February 2026</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="page-footer">
        <div class="footer-links">
            <a href="#" onclick="openInfoModal('disclaimerModal'); return false;">Disclaimer</a>
            <a href="#" onclick="openInfoModal('methodologyModal'); return false;">Data Methodology</a>
            <a href="LICENSE" target="_blank">MIT License</a>
        </div>
        <div class="footer-center">
            Developed by <a href="https://github.com/jameson-dev" target="_blank" rel="noopener noreferrer">Jameson Bell</a>
        </div>
        <div class="footer-attribution">
            Data: <a href="https://data.sa.gov.au" target="_blank" rel="noopener noreferrer">Data SA</a> | &copy; 2026
        </div>
    </footer>

    <script>
        // Info modal functions
        function openInfoModal(modalId) {
            document.getElementById(modalId).classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeInfoModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('info-modal')) {
                closeInfoModal(event.target.id);
            }
        });

        // Close modal with Escape key
        window.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                document.querySelectorAll('.info-modal.show').forEach(modal => {
                    closeInfoModal(modal.id);
                });
                // Also close analytics fullscreen
                const analyticsPanel = document.getElementById('analyticsPanel');
                if (analyticsPanel && analyticsPanel.classList.contains('fullscreen')) {
                    analyticsPanel.classList.remove('fullscreen');
                    analyticsPanel.classList.add('collapsed');
                }
            }
        });

        // Checkbox filter functions
        function selectAllCheckboxes(groupName) {
            const checkboxes = document.querySelectorAll(`#${groupName}Checkboxes input[type="checkbox"]`);
            checkboxes.forEach(cb => {
                cb.checked = true;
            });
        }

        function clearAllCheckboxes(groupName) {
            const checkboxes = document.querySelectorAll(`#${groupName}Checkboxes input[type="checkbox"]`);
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
        }

        // Checkbox dropdown functions
        function toggleCheckboxDropdown(dropdownId) {
            const menu = document.getElementById(`${dropdownId}Menu`);
            const trigger = menu.previousElementSibling;
            const arrow = trigger.querySelector('.dropdown-arrow');

            // Close all other dropdowns and clear their searches
            document.querySelectorAll('.checkbox-dropdown-menu').forEach(m => {
                if (m !== menu && m.classList.contains('show')) {
                    m.classList.remove('show');
                    const otherArrow = m.previousElementSibling.querySelector('.dropdown-arrow');
                    if (otherArrow) otherArrow.style.transform = 'rotate(0deg)';
                    // Clear search in the closed dropdown
                    const otherSearch = m.querySelector('.dropdown-search');
                    if (otherSearch && otherSearch.value) {
                        otherSearch.value = '';
                        m.querySelectorAll('.checkbox-dropdown-item').forEach(item => item.style.display = '');
                    }
                }
            });

            // Toggle current dropdown
            if (menu.classList.contains('show')) {
                menu.classList.remove('show');
                arrow.style.transform = 'rotate(0deg)';
                // Clear search when closing
                const search = menu.querySelector('.dropdown-search');
                if (search && search.value) {
                    search.value = '';
                    menu.querySelectorAll('.checkbox-dropdown-item').forEach(item => item.style.display = '');
                }
            } else {
                menu.classList.add('show');
                arrow.style.transform = 'rotate(180deg)';
                // Focus search input when opening
                const search = menu.querySelector('.dropdown-search');
                if (search) setTimeout(() => search.focus(), 50);
            }
        }

        function filterDropdownItems(dropdownId, query) {
            const menu = document.getElementById(`${dropdownId}Menu`);
            if (!menu) return;
            const q = query.trim().toLowerCase();
            menu.querySelectorAll('.checkbox-dropdown-item').forEach(function(item) {
                const label = item.querySelector('label');
                const text = label ? label.textContent.toLowerCase() : '';
                item.style.display = (q === '' || text.includes(q)) ? '' : 'none';
            });
        }

        function updateCheckboxDropdownDisplay(dropdownId) {
            const menu = document.getElementById(`${dropdownId}Menu`);
            const display = document.getElementById(`${dropdownId}Display`);
            const checkboxes = menu.querySelectorAll('input[type="checkbox"]:checked');

            if (checkboxes.length === 0 || checkboxes.length === menu.querySelectorAll('input[type="checkbox"]').length) {
                if (dropdownId === 'crashType') {
                    display.textContent = 'All Types';
                } else if (dropdownId === 'area') {
                    display.textContent = 'All Areas';
                } else if (dropdownId === 'severity') {
                    display.textContent = 'All Severities';
                }
            } else if (checkboxes.length === 1) {
                display.textContent = checkboxes[0].nextElementSibling.textContent;
            } else {
                display.textContent = `${checkboxes.length} selected`;
            }
        }

        function selectAllDropdownItems(dropdownId) {
            const menu = document.getElementById(`${dropdownId}Menu`);
            const checkboxes = menu.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = true;
            });
            updateCheckboxDropdownDisplay(dropdownId);
        }

        function clearAllDropdownItems(dropdownId) {
            const menu = document.getElementById(`${dropdownId}Menu`);
            const checkboxes = menu.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            updateCheckboxDropdownDisplay(dropdownId);
        }

        // Close dropdowns on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key !== 'Escape') return;
            document.querySelectorAll('.checkbox-dropdown-menu').forEach(menu => {
                if (menu.classList.contains('show')) {
                    menu.classList.remove('show');
                    const arrow = menu.previousElementSibling.querySelector('.dropdown-arrow');
                    if (arrow) arrow.style.transform = 'rotate(0deg)';
                    const search = menu.querySelector('.dropdown-search');
                    if (search && search.value) {
                        search.value = '';
                        menu.querySelectorAll('.checkbox-dropdown-item').forEach(item => item.style.display = '');
                    }
                }
            });
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.checkbox-dropdown')) {
                document.querySelectorAll('.checkbox-dropdown-menu').forEach(menu => {
                    if (menu.classList.contains('show')) {
                        menu.classList.remove('show');
                        const arrow = menu.previousElementSibling.querySelector('.dropdown-arrow');
                        if (arrow) arrow.style.transform = 'rotate(0deg)';
                        // Clear search on close
                        const search = menu.querySelector('.dropdown-search');
                        if (search && search.value) {
                            search.value = '';
                            menu.querySelectorAll('.checkbox-dropdown-item').forEach(item => item.style.display = '');
                        }
                    }
                });
            }
        });

        // Placeholder for updateResultCount (can be implemented in app.js if needed)
        function updateResultCount() {
            // This can be implemented in app.js when crash data is loaded
        }

        // Analytics panel toggle - opens fullscreen
        function toggleAnalyticsPanel() {
            const panel = document.getElementById('analyticsPanel');
            if (panel.classList.contains('fullscreen')) return; // Click on header in fullscreen does nothing

            panel.classList.remove('collapsed');
            panel.classList.add('fullscreen');

            // Resize all charts after transition to fit new dimensions
            setTimeout(() => {
                Object.values(charts).forEach(chart => {
                    if (chart) chart.resize();
                });
            }, 50);
        }

        // Close analytics panel back to collapsed state
        function closeAnalyticsPanel(event) {
            event.stopPropagation(); // Prevent triggering toggleAnalyticsPanel
            const panel = document.getElementById('analyticsPanel');
            panel.classList.remove('fullscreen');
            panel.classList.add('collapsed');
        }

        // Chart instances
        let charts = {
            crashesOverTime: null,
            crashesByDay: null,
            crashesByHour: null,
            severityDistribution: null,
            crashType: null,
            topLGA: null,
            weather: null,
            severityTrend: null,
            speedZone: null,
            roadUser: null,
            casualtyAge: null
        };

        // Solo-select one checkbox value in a dropdown (or restore all if already solo)
        function soloSelectDropdown(menuId, displayId, value) {
            var menu = document.getElementById(menuId);
            if (!menu) return;
            var checkboxes = Array.from(menu.querySelectorAll('input[type="checkbox"]'));
            var checked = checkboxes.filter(function(cb) { return cb.checked; });
            var alreadySolo = checked.length === 1 && checked[0].value === value;
            checkboxes.forEach(function(cb) { cb.checked = alreadySolo || (cb.value === value); });
            if (typeof updateCheckboxDropdownDisplay === 'function') updateCheckboxDropdownDisplay(displayId);
            if (typeof applyFilters === 'function') applyFilters();
        }

        // Current aggregation mode for Crashes Over Time
        let crashesOverTimeMode = 'yearly';

        // Show/hide the year filter banner based on whether the slider is on a single year
        function updateYearChip() {
            var banner = document.getElementById('yearFilterBanner');
            var label = document.getElementById('yearBannerLabel');
            if (!banner) return;
            var sliderEl = document.getElementById('yearRangeSlider');
            var slider = sliderEl && sliderEl.noUiSlider;
            if (!slider) { banner.style.display = 'none'; return; }
            var vals = slider.get();
            var from = parseInt(vals[0]), to = parseInt(vals[1]);
            if (from === to) {
                label.textContent = from;
                banner.style.display = 'flex';
            } else {
                banner.style.display = 'none';
            }
        }

        // Clear the year chip and restore full year range
        function clearYearChip() {
            var sliderEl = document.getElementById('yearRangeSlider');
            var slider = sliderEl && sliderEl.noUiSlider;
            if (slider) {
                slider.set([2012, 2024]);
                if (typeof applyFilters === 'function') applyFilters();
            }
        }

        // Toggle Crashes Over Time between yearly and monthly
        function setOverTimeMode(mode) {
            crashesOverTimeMode = mode;
            document.getElementById('btnYearly').classList.toggle('active', mode === 'yearly');
            document.getElementById('btnMonthly').classList.toggle('active', mode === 'monthly');
            if (window._lastCrashData) updateChartsWithData(window._lastCrashData);
        }

        // Format hour as "12am", "1am", "12pm", "1pm" etc.
        function formatHourLabel(h) {
            if (h === 0) return '12am';
            if (h < 12) return h + 'am';
            if (h === 12) return '12pm';
            return (h - 12) + 'pm';
        }

        // Interpolate between two hex colours (ratio 0‚Üí1)
        function interpolateColor(hex1, hex2, ratio) {
            const r1 = parseInt(hex1.slice(1,3),16), g1 = parseInt(hex1.slice(3,5),16), b1 = parseInt(hex1.slice(5,7),16);
            const r2 = parseInt(hex2.slice(1,3),16), g2 = parseInt(hex2.slice(3,5),16), b2 = parseInt(hex2.slice(5,7),16);
            return 'rgb(' + Math.round(r1+(r2-r1)*ratio) + ',' + Math.round(g1+(g2-g1)*ratio) + ',' + Math.round(b1+(b2-b1)*ratio) + ')';
        }

        // Gradient colour array from low‚Üíhigh colour based on relative values
        function gradientColors(data, lowHex, highHex) {
            const max = Math.max.apply(null, data) || 1;
            return data.map(function(v) { return interpolateColor(lowHex, highHex, v / max); });
        }

        // Convert hex colour + alpha to rgba string
        function hexToRgba(hex, alpha) {
            var r = parseInt(hex.slice(1,3),16), g = parseInt(hex.slice(3,5),16), b = parseInt(hex.slice(5,7),16);
            return 'rgba(' + r + ',' + g + ',' + b + ',' + alpha + ')';
        }

        // Tooltip callback: show count + % of dataset total (skip avg reference line)
        function pctTooltip(context) {
            if (context.dataset.label === 'Avg') {
                return ' Avg: ' + Math.round(context.raw).toLocaleString() + ' crashes';
            }
            const value = context.raw;
            const total = context.dataset.data.reduce(function(a, b) { return a + b; }, 0);
            const pct = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
            return ' ' + value.toLocaleString() + ' crashes (' + pct + '%)';
        }

        const MONTH_ABBR = ['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

        // Initialize charts
        function initializeCharts() {
            // Theme-aware tooltip colours ‚Äî re-read CSS vars at render time so they
            // automatically switch when the user toggles light/dark mode.
            const tooltipPlugin = {
                tooltip: {
                    callbacks: { label: pctTooltip },
                    backgroundColor: function() {
                        return getComputedStyle(document.documentElement)
                            .getPropertyValue('--bg-secondary').trim() || '#f5f5f5';
                    },
                    titleColor: function() {
                        return getComputedStyle(document.documentElement)
                            .getPropertyValue('--text-primary').trim() || '#2a2a2a';
                    },
                    bodyColor: function() {
                        return getComputedStyle(document.documentElement)
                            .getPropertyValue('--text-secondary').trim() || '#666666';
                    },
                    borderColor: function() {
                        return getComputedStyle(document.documentElement)
                            .getPropertyValue('--border').trim() || 'rgba(0,0,0,0.1)';
                    },
                    borderWidth: 1
                }
            };
            const baseScales  = { y: { beginAtZero: true } };

            // Crashes Over Time - line chart (click point in yearly mode ‚Üí jump to that year)
            const ctxTime = document.getElementById('crashesOverTimeChart');
            if (ctxTime) {
                charts.crashesOverTime = new Chart(ctxTime, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Crashes',
                            data: [],
                            borderColor: '#4a90e2',
                            backgroundColor: 'rgba(74,144,226,0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, ...tooltipPlugin },
                        scales: baseScales,
                        interaction: { mode: 'nearest', intersect: false },
                        onHover: function(event, elements) {
                            event.native.target.style.cursor = (elements.length > 0 && crashesOverTimeMode === 'yearly') ? 'pointer' : 'default';
                        },
                        onClick: function(event, elements, chart) {
                            if (crashesOverTimeMode !== 'yearly') return;
                            // Use nearest-point detection so click doesn't have to land exactly on the dot
                            var nearest = chart.getElementsAtEventForMode(event, 'nearest', { intersect: false }, true);
                            if (nearest.length === 0) return;
                            var year = parseInt(chart.data.labels[nearest[0].index]);
                            if (isNaN(year)) return;
                            // Access the noUiSlider instance via the element's .noUiSlider property
                            // (window.yearRangeSlider would be the DOM element, not the slider API)
                            var sliderEl = document.getElementById('yearRangeSlider');
                            var slider = sliderEl && sliderEl.noUiSlider;
                            if (slider) {
                                if (currentYearRange[0] === year && currentYearRange[1] === year) {
                                    slider.set([2012, 2024]);
                                } else {
                                    slider.set([year, year]);
                                }
                                // Slider update event only refreshes the display ‚Äî trigger the filter manually
                                if (typeof applyFilters === 'function') applyFilters();
                            }
                        }
                    }
                });
            }

            // Crashes by Day of Week - weekend bars in amber, weekdays in blue
            const ctxDay = document.getElementById('crashesByDayChart');
            if (ctxDay) {
                const dayColors = ['#ffa726','#4a90e2','#4a90e2','#4a90e2','#4a90e2','#4a90e2','#ffa726'];
                const avgLineStyle = {
                    type: 'line', label: 'Avg',
                    data: Array(7).fill(0),
                    borderColor: 'rgba(140,140,140,0.65)',
                    borderDash: [5, 4], borderWidth: 1.5,
                    pointRadius: 0, fill: false, tension: 0
                };
                charts.crashesByDay = new Chart(ctxDay, {
                    type: 'bar',
                    data: {
                        labels: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                        datasets: [
                            { label: 'Crashes', data: [0,0,0,0,0,0,0], backgroundColor: dayColors },
                            avgLineStyle
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    generateLabels: function() {
                                        return [
                                            { text: 'Weekday', fillStyle: '#4a90e2', strokeStyle: '#4a90e2', lineWidth: 0 },
                                            { text: 'Weekend', fillStyle: '#ffa726', strokeStyle: '#ffa726', lineWidth: 0 }
                                        ];
                                    }
                                }
                            },
                            ...tooltipPlugin
                        },
                        scales: baseScales
                    }
                });
            }

            // Crashes by Hour - gradient blue‚Üíred, 12-hour labels, avg reference line
            const ctxHour = document.getElementById('crashesByHourChart');
            if (ctxHour) {
                charts.crashesByHour = new Chart(ctxHour, {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: 24}, function(_, i) { return formatHourLabel(i); }),
                        datasets: [
                            { label: 'Crashes', data: Array(24).fill(0), backgroundColor: Array(24).fill('#4a90e2') },
                            { type: 'line', label: 'Avg', data: Array(24).fill(0),
                              borderColor: 'rgba(140,140,140,0.65)', borderDash: [5,4],
                              borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, ...tooltipPlugin },
                        scales: baseScales
                    }
                });
            }

            // Severity Distribution - doughnut with legend + click-to-filter
            const ctxSeverity = document.getElementById('severityDistributionChart');
            if (ctxSeverity) {
                charts.severityDistribution = new Chart(ctxSeverity, {
                    type: 'doughnut',
                    data: {
                        labels: ['PDO', 'Minor Injury', 'Serious Injury', 'Fatal'],
                        datasets: [{ data: [0,0,0,0], backgroundColor: ['#90caf9','#ffa726','#ef5350','#ab47bc'] }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: true, position: 'bottom' }, ...tooltipPlugin },
                        onClick: function(event, elements) {
                            if (elements.length === 0) return;
                            var severityMap = ['1: Property Damage Only', '2: Minor Inj.', '3: Severe Inj.', '4: Fatal'];
                            var severityIds = ['severity-pdo', 'severity-mi', 'severity-si', 'severity-fatal'];
                            var clickedValue = severityMap[elements[0].index];
                            var checkboxes = severityIds.map(function(id) { return document.getElementById(id); }).filter(Boolean);
                            var checkedValues = checkboxes.filter(function(cb) { return cb.checked; }).map(function(cb) { return cb.value; });
                            // Toggle: if already solo-selected, restore all; otherwise solo-select
                            if (checkedValues.length === 1 && checkedValues[0] === clickedValue) {
                                checkboxes.forEach(function(cb) { cb.checked = true; });
                            } else {
                                checkboxes.forEach(function(cb) { cb.checked = (cb.value === clickedValue); });
                            }
                            if (typeof updateCheckboxDropdownDisplay === 'function') updateCheckboxDropdownDisplay('severity');
                            if (typeof applyFilters === 'function') applyFilters();
                        }
                    }
                });
            }

            // Shared options for horizontal bar charts (click-to-filter)
            var hBarOpts = function(menuId, displayId, isWeather) {
                return {
                    responsive: true, maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: { legend: { display: false }, tooltip: { callbacks: { label: function(ctx) { return ' ' + ctx.raw.toLocaleString() + ' crashes'; } } } },
                    scales: { x: { beginAtZero: true, ticks: { font: { size: 10 } } }, y: { ticks: { font: { size: 10 } } } },
                    onHover: function(event) { event.native.target.style.cursor = 'pointer'; },
                    onClick: function(event, elements, chart) {
                        if (elements.length === 0) return;
                        var label = chart.data.labels[elements[0].index];
                        if (isWeather) {
                            var sel = document.getElementById('weather');
                            if (!sel) return;
                            if (sel.value === label) { sel.value = 'all'; } else { sel.value = label; }
                            if (typeof applyFilters === 'function') applyFilters();
                        } else {
                            soloSelectDropdown(menuId, displayId, label);
                        }
                    }
                };
            };

            // Crash Type horizontal bar
            var ctxCT = document.getElementById('crashTypeChart');
            if (ctxCT) {
                charts.crashType = new Chart(ctxCT, {
                    type: 'bar',
                    data: { labels: [], datasets: [{ label: 'Crashes', data: [], backgroundColor: '#4a90e2' }] },
                    options: hBarOpts('crashTypeMenu', 'crashType', false)
                });
            }

            // Top LGA horizontal bar
            var ctxLGA = document.getElementById('topLGAChart');
            if (ctxLGA) {
                charts.topLGA = new Chart(ctxLGA, {
                    type: 'bar',
                    data: { labels: [], datasets: [{ label: 'Crashes', data: [], backgroundColor: '#26c6da' }] },
                    options: hBarOpts('areaMenu', 'area', false)
                });
            }

            // Weather horizontal bar
            var ctxWx = document.getElementById('weatherChart');
            if (ctxWx) {
                charts.weather = new Chart(ctxWx, {
                    type: 'bar',
                    data: { labels: [], datasets: [{ label: 'Crashes', data: [], backgroundColor: '#66bb6a' }] },
                    options: hBarOpts(null, null, true)
                });
            }

            // Severity Trend Over Time ‚Äî multi-line
            var ctxTrend = document.getElementById('severityTrendChart');
            if (ctxTrend) {
                var mkLine = function(label, color) {
                    return {
                        label: label, data: [],
                        borderColor: color, backgroundColor: hexToRgba(color, '0.12'),
                        borderWidth: 2, pointRadius: 4, tension: 0.3, fill: false
                    };
                };
                charts.severityTrend = new Chart(ctxTrend, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [
                            mkLine('Fatal',          '#8B0000'),
                            mkLine('Serious Injury', '#ef5350'),
                            mkLine('Minor Injury',   '#ffa726')
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'top', labels: { font: { size: 10 }, boxWidth: 12 } },
                            tooltip: { callbacks: { label: function(ctx) { return ' ' + ctx.dataset.label + ': ' + ctx.raw.toLocaleString() + ' crashes'; } } }
                        },
                        scales: { x: { ticks: { font: { size: 10 } } }, y: { beginAtZero: true } }
                    }
                });
            }

            // Speed Zone ‚Äî horizontal bar
            var ctxSpeed = document.getElementById('speedZoneChart');
            if (ctxSpeed) {
                charts.speedZone = new Chart(ctxSpeed, {
                    type: 'bar',
                    data: { labels: [], datasets: [{ label: 'Crashes', data: [], backgroundColor: '#4a90e2' }] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        indexAxis: 'y',
                        plugins: {
                            legend: { display: false },
                            tooltip: { callbacks: { label: function(ctx) { return ' ' + ctx.raw.toLocaleString() + ' crashes'; } } }
                        },
                        scales: { x: { beginAtZero: true, ticks: { font: { size: 10 } } }, y: { ticks: { font: { size: 10 } } } }
                    }
                });
            }

            // Road User Type ‚Äî doughnut
            var ctxRU = document.getElementById('roadUserChart');
            if (ctxRU) {
                charts.roadUser = new Chart(ctxRU, {
                    type: 'doughnut',
                    data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'right', labels: { font: { size: 10 }, boxWidth: 12, padding: 8 } },
                            tooltip: { callbacks: { label: function(ctx) {
                                var total = ctx.dataset.data.reduce(function(a, b) { return a + b; }, 0);
                                var pct = total > 0 ? ((ctx.raw / total) * 100).toFixed(1) : '0.0';
                                return ' ' + ctx.raw.toLocaleString() + ' (' + pct + '%)';
                            }}}
                        }
                    }
                });
            }

            // Casualty Age Distribution ‚Äî bar
            var ctxAge = document.getElementById('casualtyAgeChart');
            if (ctxAge) {
                charts.casualtyAge = new Chart(ctxAge, {
                    type: 'bar',
                    data: {
                        labels: ['0\u201317', '18\u201325', '26\u201335', '36\u201350', '51\u201365', '66+'],
                        datasets: [{ label: 'Casualties', data: [0,0,0,0,0,0], backgroundColor: '#4a90e2' }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: { callbacks: { label: function(ctx) { return ' ' + ctx.raw.toLocaleString() + ' casualties'; } } }
                        },
                        scales: { x: { ticks: { font: { size: 10 } } }, y: { beginAtZero: true } }
                    }
                });
            }

            // Seat Belt Compliance ‚Äî doughnut
            var ctxSB = document.getElementById('seatBeltChart');
            if (ctxSB) {
                charts.seatBelt = new Chart(ctxSB, {
                    type: 'doughnut',
                    data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'bottom', labels: { font: { size: 10 }, boxWidth: 12, padding: 8 } },
                            tooltip: { callbacks: { label: function(ctx) {
                                var total = ctx.dataset.data.reduce(function(a, b) { return a + b; }, 0);
                                var pct = total > 0 ? ((ctx.raw / total) * 100).toFixed(1) : '0.0';
                                return ' ' + ctx.raw.toLocaleString() + ' (' + pct + '%)';
                            }}}
                        }
                    }
                });
            }

            // Helmet Compliance ‚Äî doughnut
            var ctxHlm = document.getElementById('helmetChart');
            if (ctxHlm) {
                charts.helmet = new Chart(ctxHlm, {
                    type: 'doughnut',
                    data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'bottom', labels: { font: { size: 10 }, boxWidth: 12, padding: 8 } },
                            tooltip: { callbacks: { label: function(ctx) {
                                var total = ctx.dataset.data.reduce(function(a, b) { return a + b; }, 0);
                                var pct = total > 0 ? ((ctx.raw / total) * 100).toFixed(1) : '0.0';
                                return ' ' + ctx.raw.toLocaleString() + ' (' + pct + '%)';
                            }}}
                        }
                    }
                });
            }

            // Casualty Sex Breakdown ‚Äî doughnut
            var ctxSex = document.getElementById('casualtySexChart');
            if (ctxSex) {
                charts.casualtySex = new Chart(ctxSex, {
                    type: 'doughnut',
                    data: { labels: [], datasets: [{ data: [], backgroundColor: [] }] },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: { display: true, position: 'bottom', labels: { font: { size: 10 }, boxWidth: 12, padding: 8 } },
                            tooltip: { callbacks: { label: function(ctx) {
                                var total = ctx.dataset.data.reduce(function(a, b) { return a + b; }, 0);
                                var pct = total > 0 ? ((ctx.raw / total) * 100).toFixed(1) : '0.0';
                                return ' ' + ctx.raw.toLocaleString() + ' (' + pct + '%)';
                            }}}
                        }
                    }
                });
            }

        }

        // Initialize charts when page loads
        window.addEventListener('load', function() {
            if (typeof Chart !== 'undefined') initializeCharts();
        });

        // Update charts with filtered data (called from app.js)
        function updateChartsWithData(crashData) {
            if (!crashData || crashData.length === 0) return;
            window._lastCrashData = crashData; // cache for toggle re-render
            updateYearChip(); // keep chip in sync with current slider state

            // ‚îÄ‚îÄ Crashes Over Time ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (crashesOverTimeMode === 'yearly') {
                const yearCounts = {};
                crashData.forEach(function(crash) {
                    var y = String(crash['Year']);
                    if (y) yearCounts[y] = (yearCounts[y] || 0) + 1;
                });
                var sortedYears = Object.keys(yearCounts).sort();
                if (charts.crashesOverTime && sortedYears.length > 0) {
                    charts.crashesOverTime.data.labels = sortedYears;
                    charts.crashesOverTime.data.datasets[0].data = sortedYears.map(function(y) { return yearCounts[y]; });
                    charts.crashesOverTime.update();
                }
            } else {
                // Monthly - zero-pad month so "2012-01" sorts before "2012-10"
                var monthCounts = {};
                crashData.forEach(function(crash) {
                    var dt = crash['Crash Date Time'];
                    if (dt) {
                        var dp = dt.split(' ')[0].split('/');
                        if (dp.length === 3) {
                            var key = dp[2] + '-' + String(parseInt(dp[1])).padStart(2, '0');
                            monthCounts[key] = (monthCounts[key] || 0) + 1;
                        }
                    }
                });
                var sortedKeys = Object.keys(monthCounts).sort();
                var labels = sortedKeys.map(function(k) {
                    var p = k.split('-');
                    return MONTH_ABBR[parseInt(p[1])] + " '" + p[0].slice(2);
                });
                if (charts.crashesOverTime && sortedKeys.length > 0) {
                    charts.crashesOverTime.data.labels = labels;
                    charts.crashesOverTime.data.datasets[0].data = sortedKeys.map(function(k) { return monthCounts[k]; });
                    charts.crashesOverTime.update();
                }
            }

            // ‚îÄ‚îÄ Crashes by Day of Week ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // Use 'Day' column directly ‚Äî accurate for all years
            var dayNameToIndex = { 'Sunday':0,'Monday':1,'Tuesday':2,'Wednesday':3,'Thursday':4,'Friday':5,'Saturday':6 };
            var dayCounts = [0,0,0,0,0,0,0];
            crashData.forEach(function(crash) {
                var d = crash['Day'];
                if (d && dayNameToIndex.hasOwnProperty(d)) dayCounts[dayNameToIndex[d]]++;
            });
            if (charts.crashesByDay) {
                charts.crashesByDay.data.datasets[0].data = dayCounts;
                var dayAvg = Math.round(dayCounts.reduce(function(a,b){return a+b;},0) / 7);
                charts.crashesByDay.data.datasets[1].data = Array(7).fill(dayAvg);
                charts.crashesByDay.update();
            }

            // ‚îÄ‚îÄ Crashes by Hour ‚Äî gradient blue‚Üíred ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            var hourCounts = Array(24).fill(0);
            crashData.forEach(function(crash) {
                var dt = crash['Crash Date Time'];
                if (dt) {
                    var tp = dt.split(' ')[1];
                    if (tp) {
                        var h = parseInt(tp.split(':')[0]);
                        if (!isNaN(h) && h >= 0 && h < 24) hourCounts[h]++;
                    }
                }
            });
            if (charts.crashesByHour) {
                charts.crashesByHour.data.datasets[0].data = hourCounts;
                charts.crashesByHour.data.datasets[0].backgroundColor = gradientColors(hourCounts, '#4a90e2', '#ef5350');
                var hourAvg = Math.round(hourCounts.reduce(function(a,b){return a+b;},0) / 24);
                charts.crashesByHour.data.datasets[1].data = Array(24).fill(hourAvg);
                charts.crashesByHour.update();
            }

            // ‚îÄ‚îÄ Severity Distribution ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            var sev = { PDO: 0, Minor: 0, Serious: 0, Fatal: 0 };
            crashData.forEach(function(crash) {
                var s = crash['CSEF Severity'] || '';
                if (s.includes('PDO') || s.includes('1:'))        sev.PDO++;
                else if (s.includes('MI') || s.includes('2:'))  sev.Minor++;
                else if (s.includes('SI') || s.includes('3:'))  sev.Serious++;
                else if (s.includes('Fatal') || s.includes('4:')) sev.Fatal++;
            });
            if (charts.severityDistribution) {
                charts.severityDistribution.data.datasets[0].data = [sev.PDO, sev.Minor, sev.Serious, sev.Fatal];
                charts.severityDistribution.update();
            }

            // ‚îÄ‚îÄ Top Crash Types ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            var typeCounts = {};
            crashData.forEach(function(crash) {
                var t = crash['Crash Type'];
                if (t) typeCounts[t] = (typeCounts[t] || 0) + 1;
            });
            var sortedTypes = Object.keys(typeCounts).sort(function(a, b) { return typeCounts[b] - typeCounts[a]; }).slice(0, 10).reverse();
            if (charts.crashType) {
                charts.crashType.data.labels = sortedTypes;
                charts.crashType.data.datasets[0].data = sortedTypes.map(function(t) { return typeCounts[t]; });
                charts.crashType.data.datasets[0].backgroundColor = gradientColors(sortedTypes.map(function(t) { return typeCounts[t]; }), '#90caf9', '#1565c0');
                charts.crashType.update();
            }

            // ‚îÄ‚îÄ Top LGAs ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            var lgaCounts = {};
            crashData.forEach(function(crash) {
                var l = crash['LGA'];
                if (l) lgaCounts[l] = (lgaCounts[l] || 0) + 1;
            });
            var sortedLGAs = Object.keys(lgaCounts).sort(function(a, b) { return lgaCounts[b] - lgaCounts[a]; }).slice(0, 10).reverse();
            if (charts.topLGA) {
                charts.topLGA.data.labels = sortedLGAs;
                charts.topLGA.data.datasets[0].data = sortedLGAs.map(function(l) { return lgaCounts[l]; });
                charts.topLGA.data.datasets[0].backgroundColor = gradientColors(sortedLGAs.map(function(l) { return lgaCounts[l]; }), '#80deea', '#006064');
                charts.topLGA.update();
            }

            // ‚îÄ‚îÄ Weather Conditions ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            var wxCounts = {};
            crashData.forEach(function(crash) {
                var w = crash['Weather Cond'];
                if (w) wxCounts[w] = (wxCounts[w] || 0) + 1;
            });
            var sortedWx = Object.keys(wxCounts).sort(function(a, b) { return wxCounts[b] - wxCounts[a]; }).reverse();
            if (charts.weather) {
                charts.weather.data.labels = sortedWx;
                charts.weather.data.datasets[0].data = sortedWx.map(function(w) { return wxCounts[w]; });
                charts.weather.data.datasets[0].backgroundColor = gradientColors(sortedWx.map(function(w) { return wxCounts[w]; }), '#a5d6a7', '#1b5e20');
                charts.weather.update();
            }

            // ‚îÄ‚îÄ Day √ó Hour Heatmap ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            (function() {
                var container = document.getElementById('dayHourHeatmap');
                if (!container) return;
                var dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                var dayNameToIdx = { 'Sunday':0,'Monday':1,'Tuesday':2,'Wednesday':3,'Thursday':4,'Friday':5,'Saturday':6 };
                var matrix = Array.from({length: 7}, function() { return Array(24).fill(0); });
                crashData.forEach(function(crash) {
                    var d = crash['Day'], dt = crash['Crash Date Time'];
                    if (d && dayNameToIdx.hasOwnProperty(d) && dt) {
                        var tp = dt.split(' ')[1];
                        if (tp) { var h = parseInt(tp.split(':')[0]); if (!isNaN(h) && h >= 0 && h < 24) matrix[dayNameToIdx[d]][h]++; }
                    }
                });
                var max = 1;
                matrix.forEach(function(row) { row.forEach(function(v) { if (v > max) max = v; }); });

                var html = '<div class="heatmap-table">';
                // Column headers (every 3 hours)
                html += '<div class="heatmap-row"><div class="heatmap-row-label"></div>';
                for (var h = 0; h < 24; h++) {
                    html += '<div class="heatmap-col-hdr">' + (h % 3 === 0 ? formatHourLabel(h) : '') + '</div>';
                }
                html += '</div>';
                // Data rows
                matrix.forEach(function(row, di) {
                    html += '<div class="heatmap-row"><div class="heatmap-row-label">' + dayNames[di] + '</div>';
                    row.forEach(function(v, h) {
                        var alpha = (v / max).toFixed(2);
                        var tip = dayNames[di] + ' ' + formatHourLabel(h) + ': ' + v.toLocaleString() + ' crashes';
                        html += '<div class="heatmap-cell" title="' + tip + '" style="background:rgba(239,83,80,' + alpha + ')"></div>';
                    });
                    html += '</div>';
                });
                html += '</div>';
                container.innerHTML = html;
            })();

            // ‚îÄ‚îÄ Severity Trend Over Time ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            (function() {
                if (!charts.severityTrend) return;
                var yearFatal = {}, yearSI = {}, yearMI = {};
                crashData.forEach(function(crash) {
                    var y = String(crash['Year']); if (!y) return;
                    var sev = crash['CSEF Severity'];
                    if      (sev === '4: Fatal') yearFatal[y] = (yearFatal[y] || 0) + 1;
                    else if (sev === '3: SI')    yearSI[y]    = (yearSI[y]    || 0) + 1;
                    else if (sev === '2: MI')    yearMI[y]    = (yearMI[y]    || 0) + 1;
                });
                var sortedYears = [...new Set(crashData.map(function(c) { return String(c['Year']); }).filter(function(y) { return y; }))].sort();
                charts.severityTrend.data.labels = sortedYears;
                charts.severityTrend.data.datasets[0].data = sortedYears.map(function(y) { return yearFatal[y] || 0; });
                charts.severityTrend.data.datasets[1].data = sortedYears.map(function(y) { return yearSI[y]    || 0; });
                charts.severityTrend.data.datasets[2].data = sortedYears.map(function(y) { return yearMI[y]    || 0; });
                charts.severityTrend.update();
            })();

            // ‚îÄ‚îÄ Crashes by Speed Zone ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            (function() {
                if (!charts.speedZone) return;
                var speedCounts = {};
                crashData.forEach(function(crash) {
                    var s = crash['Area Speed'];
                    if (s) {
                        var sStr = String(s).trim();
                        if (sStr) speedCounts[sStr] = (speedCounts[sStr] || 0) + 1;
                    }
                });
                var sortedSpeeds = Object.keys(speedCounts).sort(function(a, b) { return parseInt(a) - parseInt(b); });
                charts.speedZone.data.labels = sortedSpeeds.map(function(s) { return s + ' km/h'; });
                charts.speedZone.data.datasets[0].data = sortedSpeeds.map(function(s) { return speedCounts[s]; });
                charts.speedZone.data.datasets[0].backgroundColor = gradientColors(sortedSpeeds.map(function(s) { return speedCounts[s]; }), '#90caf9', '#1565c0');
                charts.speedZone.update();
            })();

            // ‚îÄ‚îÄ Casualties by Road User Type ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            (function() {
                if (!charts.roadUser) return;
                var ruCounts = {};
                crashData.forEach(function(crash) {
                    if (!crash._casualties) return;
                    crash._casualties.forEach(function(c) {
                        var t = c['Casualty Type'];
                        if (t) {
                            var tStr = String(t).trim();
                            if (tStr) ruCounts[tStr] = (ruCounts[tStr] || 0) + 1;
                        }
                    });
                });
                var sorted = Object.entries(ruCounts).sort(function(a, b) { return b[1] - a[1]; });
                var palette = ['#4a90e2','#26c6da','#66bb6a','#ffa726','#ef5350','#ab47bc','#78909c','#26a69a','#ec407a','#7e57c2'];
                charts.roadUser.data.labels = sorted.map(function(e) { return e[0]; });
                charts.roadUser.data.datasets[0].data = sorted.map(function(e) { return e[1]; });
                charts.roadUser.data.datasets[0].backgroundColor = sorted.map(function(_, i) { return palette[i % palette.length]; });
                charts.roadUser.update();
            })();

            // ‚îÄ‚îÄ Casualty Age Distribution ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            (function() {
                if (!charts.casualtyAge) return;
                var ageBuckets = [0, 0, 0, 0, 0, 0]; // 0-17, 18-25, 26-35, 36-50, 51-65, 66+
                crashData.forEach(function(crash) {
                    if (!crash._casualties) return;
                    crash._casualties.forEach(function(c) {
                        var age = parseInt(c['AGE']);
                        if (isNaN(age)) return;
                        if      (age <= 17) ageBuckets[0]++;
                        else if (age <= 25) ageBuckets[1]++;
                        else if (age <= 35) ageBuckets[2]++;
                        else if (age <= 50) ageBuckets[3]++;
                        else if (age <= 65) ageBuckets[4]++;
                        else                ageBuckets[5]++;
                    });
                });
                charts.casualtyAge.data.datasets[0].data = ageBuckets;
                charts.casualtyAge.data.datasets[0].backgroundColor = gradientColors(ageBuckets, '#90caf9', '#1565c0');
                charts.casualtyAge.update();
            })();

            // ‚îÄ‚îÄ Crash Type √ó Severity Matrix ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            (function() {
                var container = document.getElementById('crashTypeSeverityMatrix');
                if (!container) return;
                var sevKeys   = ['1: PDO', '2: MI', '3: SI', '4: Fatal'];
                var sevLabels = ['PDO', 'Minor Injury', 'Serious Injury', 'Fatal'];
                var sevColors = ['#808080', '#ffa726', '#ef5350', '#8B0000'];

                var typeSevCounts = {};
                crashData.forEach(function(crash) {
                    var ct  = crash['Crash Type'];
                    var sev = crash['CSEF Severity'];
                    if (!ct || !sev) return;
                    if (!typeSevCounts[ct]) typeSevCounts[ct] = {'1: PDO': 0, '2: MI': 0, '3: SI': 0, '4: Fatal': 0};
                    if (typeSevCounts[ct][sev] !== undefined) typeSevCounts[ct][sev]++;
                });

                var types = Object.keys(typeSevCounts).sort(function(a, b) {
                    var tA = sevKeys.reduce(function(s, k) { return s + (typeSevCounts[a][k] || 0); }, 0);
                    var tB = sevKeys.reduce(function(s, k) { return s + (typeSevCounts[b][k] || 0); }, 0);
                    return tB - tA;
                });

                var html = '<div class="ct-matrix">';
                // Header row
                html += '<div class="ct-matrix-row ct-matrix-hdr"><div class="ct-matrix-label"></div>';
                sevLabels.forEach(function(l) { html += '<div class="ct-matrix-cell">' + l + '</div>'; });
                html += '</div>';
                // Data rows
                types.forEach(function(type) {
                    var counts = typeSevCounts[type];
                    var total  = sevKeys.reduce(function(s, k) { return s + (counts[k] || 0); }, 0);
                    html += '<div class="ct-matrix-row"><div class="ct-matrix-label" title="' + type + '">' + type + '</div>';
                    sevKeys.forEach(function(sk, si) {
                        var v    = counts[sk] || 0;
                        var pct  = total > 0 ? v / total : 0;
                        var tip  = type + ' / ' + sevLabels[si] + ': ' + v.toLocaleString() + ' (' + (pct * 100).toFixed(1) + '%)';
                        var alpha = (0.1 + pct * 0.9).toFixed(2);
                        html += '<div class="ct-matrix-cell" title="' + tip + '" style="background:' + hexToRgba(sevColors[si], alpha) + '">' + (pct * 100).toFixed(0) + '%</div>';
                    });
                    html += '</div>';
                });
                html += '</div>';
                container.innerHTML = html;
            })();

            // ‚îÄ‚îÄ Seat Belt Compliance ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            (function() {
                if (!charts.seatBelt) return;
                var sbCounts = {};
                crashData.forEach(function(crash) {
                    if (!crash._casualties) return;
                    crash._casualties.forEach(function(c) {
                        var v = (c['Seat Belt'] || 'Unknown').trim();
                        sbCounts[v] = (sbCounts[v] || 0) + 1;
                    });
                });
                // Keyword-based classifier (case-insensitive) so any data phrasing works
                function classifyWorn(label) {
                    var l = label.toLowerCase();
                    if (l === 'worn' || l === 'yes')                          return '#43a047'; // green
                    if (l.indexOf('not worn') !== -1 || l === 'no')           return '#e53935'; // red
                    if (l.indexOf('not applic') !== -1 ||
                        l.indexOf('not req') !== -1  || l === 'n/a')          return '#039be5'; // blue
                    if (l.indexOf('unknown') !== -1  || l === 'unk')          return '#fb8c00'; // amber
                    return '#8e24aa'; // purple fallback for anything else
                }
                var sbSorted = Object.entries(sbCounts).sort(function(a, b) { return b[1] - a[1]; });
                charts.seatBelt.data.labels = sbSorted.map(function(e) { return e[0]; });
                charts.seatBelt.data.datasets[0].data = sbSorted.map(function(e) { return e[1]; });
                charts.seatBelt.data.datasets[0].backgroundColor = sbSorted.map(function(e) { return classifyWorn(e[0]); });
                charts.seatBelt.update();
            })();

            // ‚îÄ‚îÄ Helmet Compliance ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            (function() {
                if (!charts.helmet) return;
                var hmCounts = {};
                crashData.forEach(function(crash) {
                    if (!crash._casualties) return;
                    crash._casualties.forEach(function(c) {
                        var v = (c['Helmet'] || 'Unknown').trim();
                        hmCounts[v] = (hmCounts[v] || 0) + 1;
                    });
                });
                function classifyHelmet(label) {
                    var l = label.toLowerCase();
                    if (l === 'worn' || l === 'yes')                          return '#43a047';
                    if (l.indexOf('not worn') !== -1 || l === 'no')           return '#e53935';
                    if (l.indexOf('not applic') !== -1 ||
                        l.indexOf('not req') !== -1  || l === 'n/a')          return '#039be5';
                    if (l.indexOf('unknown') !== -1  || l === 'unk')          return '#fb8c00';
                    return '#8e24aa';
                }
                var hmSorted = Object.entries(hmCounts).sort(function(a, b) { return b[1] - a[1]; });
                charts.helmet.data.labels = hmSorted.map(function(e) { return e[0]; });
                charts.helmet.data.datasets[0].data = hmSorted.map(function(e) { return e[1]; });
                charts.helmet.data.datasets[0].backgroundColor = hmSorted.map(function(e) { return classifyHelmet(e[0]); });
                charts.helmet.update();
            })();

            // ‚îÄ‚îÄ Casualty Sex Breakdown ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            (function() {
                if (!charts.casualtySex) return;
                var sexCounts = {};
                crashData.forEach(function(crash) {
                    if (!crash._casualties) return;
                    crash._casualties.forEach(function(c) {
                        var v = (c['Sex'] || 'Unknown').trim();
                        sexCounts[v] = (sexCounts[v] || 0) + 1;
                    });
                });
                function classifySex(label) {
                    var l = label.toLowerCase();
                    if (l === 'male'   || l === 'm') return '#5c6bc0'; // indigo
                    if (l === 'female' || l === 'f') return '#26a69a'; // teal
                    if (l.indexOf('unknown') !== -1 || l === 'unk') return '#fb8c00'; // amber
                    return '#8e24aa'; // purple fallback
                }
                var sexSorted = Object.entries(sexCounts).sort(function(a, b) { return b[1] - a[1]; });
                charts.casualtySex.data.labels = sexSorted.map(function(e) { return e[0]; });
                charts.casualtySex.data.datasets[0].data = sexSorted.map(function(e) { return e[1]; });
                charts.casualtySex.data.datasets[0].backgroundColor = sexSorted.map(function(e) { return classifySex(e[0]); });
                charts.casualtySex.update();
            })();
        }

        // ‚îÄ‚îÄ Per-chart maximise / restore ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
        var _focusedChartId = null;

        function maximizeChart(containerId) {
            var content = document.querySelector('.analytics-content');
            if (!content) return;

            // Clicking the already-focused chart toggles back to normal
            if (_focusedChartId === containerId) {
                restoreCharts();
                return;
            }

            // Clear any existing focus first
            document.querySelectorAll('.chart-container').forEach(function(c) { c.classList.remove('chart-focused'); });
            document.querySelectorAll('.chart-maximize-btn').forEach(function(b) {
                b.textContent = '‚§¢'; b.title = 'Maximise'; b.classList.remove('is-active');
            });

            // Apply focus ‚Äî the focused container overlays via CSS (position: absolute; inset: 0)
            var container = document.getElementById(containerId);
            if (!container) return;
            container.classList.add('chart-focused');
            content.classList.add('chart-zoomed');
            _focusedChartId = containerId;

            var btn = container.querySelector('.chart-maximize-btn');
            if (btn) { btn.textContent = '‚§°'; btn.title = 'Restore'; btn.classList.add('is-active'); }

            // Reflow the focused chart canvas at its new (larger) size
            setTimeout(function() {
                Object.values(charts).forEach(function(c) { if (c && typeof c.resize === 'function') c.resize(); });
            }, 50);
        }

        function restoreCharts() {
            var content = document.querySelector('.analytics-content');
            if (content) content.classList.remove('chart-zoomed');
            document.querySelectorAll('.chart-container').forEach(function(c) { c.classList.remove('chart-focused'); });
            document.querySelectorAll('.chart-maximize-btn').forEach(function(b) {
                b.textContent = '‚§¢'; b.title = 'Maximise'; b.classList.remove('is-active');
            });
            _focusedChartId = null;

            // Double rAF ensures the browser fully reflows the grid before Chart.js
            // measures parent dimensions and resizes canvases back to grid-cell size
            requestAnimationFrame(function() {
                requestAnimationFrame(function() {
                    Object.values(charts).forEach(function(c) { if (c && typeof c.resize === 'function') c.resize(); });
                });
            });
        }

        // Inject maximise buttons into every chart-container at load time
        window.addEventListener('load', function() {
            document.querySelectorAll('.chart-container').forEach(function(container, idx) {
                if (!container.id) container.id = 'chart-container-' + idx;
                var btn = document.createElement('button');
                btn.className = 'chart-maximize-btn';
                btn.textContent = '‚§¢';
                btn.title = 'Maximise';
                btn.setAttribute('aria-label', 'Maximise chart');
                btn.onclick = (function(id) { return function() { maximizeChart(id); }; })(container.id);
                // Insert inline into the chart-header so it sits alongside the info icon
                var header = container.querySelector('.chart-header');
                if (header) {
                    header.appendChild(btn);
                } else {
                    container.appendChild(btn);
                }
            });
        });

        // Make functions available globally for app.js
        window.updateChartsWithData = updateChartsWithData;
        window.updateResultCount = updateResultCount;
    </script>
</body>
</html>
