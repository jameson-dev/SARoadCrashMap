<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SA Crash Data Map 2012-2024</title>

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <!-- noUiSlider CSS -->
    <link rel="stylesheet" href="https://unpkg.com/nouislider@15.7.1/dist/nouislider.min.css">

    <style>
        /* CSS Variables for Theming */
        :root {
            /* Light Mode Colors (default) */
            --bg-primary: #ffffff;
            --bg-secondary: #f5f5f5;
            --bg-panel: rgba(255, 255, 255, 0.95);
            --text-primary: #2a2a2a;
            --text-secondary: #666666;
            --accent: #4a90e2;
            --accent-hover: #3a7bc8;
            --border: rgba(0, 0, 0, 0.1);
            --border-light: rgba(0, 0, 0, 0.05);
            --shadow: rgba(0, 0, 0, 0.1);
            --input-bg: #ffffff;
            --input-border: rgba(0, 0, 0, 0.2);
            --scrollbar-track: rgba(0, 0, 0, 0.05);
            --scrollbar-thumb: rgba(0, 0, 0, 0.2);
            --scrollbar-thumb-hover: rgba(0, 0, 0, 0.3);
        }

        [data-theme="dark"] {
            /* Dark Mode Colors */
            --bg-primary: #1a1a1a;
            --bg-secondary: #2a2a2a;
            --bg-panel: rgba(42, 42, 42, 0.95);
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --accent: #4a90e2;
            --accent-hover: #5a9ff0;
            --border: rgba(255, 255, 255, 0.1);
            --border-light: rgba(255, 255, 255, 0.05);
            --shadow: rgba(0, 0, 0, 0.4);
            --input-bg: #2a2a2a;
            --input-border: rgba(255, 255, 255, 0.2);
            --scrollbar-track: rgba(255, 255, 255, 0.05);
            --scrollbar-thumb: rgba(255, 255, 255, 0.2);
            --scrollbar-thumb-hover: rgba(255, 255, 255, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            height: 100vh;
            overflow: hidden;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }

        #map {
            height: 100vh;
            width: 100%;
            z-index: 1;
        }

        .controls-panel {
            position: absolute;
            top: 5px;
            right: 5px;
            background: var(--bg-panel);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 15px;
            padding-top: 5px;
            width: 280px;
            max-width: 280px;
            min-width: 280px;
            max-height: calc(100vh - 47.5px);
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 0 8px 32px var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
        }

        .controls-panel.collapsed {
            max-width: 280px;
            min-width: 280px;
            width: 280px;
            padding: 15px;
            padding-bottom: 15px;
            overflow: hidden;
        }

        .controls-panel.collapsed .panel-content {
            display: none;
        }

        .controls-panel.collapsed .panel-header {
            margin-bottom: 0;
        }

        .controls-panel::-webkit-scrollbar {
            width: 8px;
        }

        .controls-panel::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 4px;
        }

        .controls-panel::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 4px;
        }

        .controls-panel::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }

        .panel-header {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 10px;
            color: var(--accent);
            border-bottom: 2px solid var(--border);
            padding-bottom: 6px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .collapse-btn {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            border-radius: 4px;
        }

        .collapse-btn:hover {
            background: var(--border);
            transform: scale(1.1);
        }

        .theme-toggle-btn {
            background: none;
            border: none;
            color: var(--accent);
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s;
            border-radius: 4px;
            margin-right: 5px;
        }

        .theme-toggle-btn:hover {
            background: var(--border);
            transform: scale(1.1);
        }

        .filter-group {
            margin-bottom: 8px;
        }

        .filter-label {
            display: block;
            margin-bottom: 3px;
            font-weight: 600;
            font-size: 11px;
            color: var(--accent);
        }

        select, input[type="number"] {
            width: 100%;
            padding: 5px 6px;
            border-radius: 4px;
            border: 1px solid var(--input-border);
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
        }

        select:hover, input[type="number"]:hover {
            border-color: var(--accent);
        }

        select:focus, input[type="number"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--border);
        }

        input[type="date"], input[type="time"] {
            width: 100%;
            padding: 4px 6px;
            border-radius: 4px;
            border: 1px solid var(--input-border);
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 11px;
            cursor: pointer;
            transition: all 0.3s;
            color-scheme: light dark;
        }

        input[type="date"]:hover, input[type="time"]:hover {
            border-color: var(--accent);
        }

        input[type="date"]:focus, input[type="time"]:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--border);
        }

        input[type="range"] {
            width: 100%;
            height: 6px;
            background: var(--border);
            border-radius: 3px;
            outline: none;
            -webkit-appearance: none;
            cursor: pointer;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s;
        }

        input[type="range"]::-webkit-slider-thumb:hover {
            background: var(--accent-hover);
            transform: scale(1.2);
        }

        input[type="range"]::-moz-range-thumb {
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
        }

        input[type="range"]::-moz-range-thumb:hover {
            background: var(--accent-hover);
            transform: scale(1.2);
        }

        select option {
            background: var(--input-bg);
            color: var(--text-primary);
        }

        /* Multi-select specific styling */
        select[multiple] {
            padding: 2px;
        }

        select[multiple] option {
            padding: 3px 5px;
            border-radius: 3px;
            margin: 1px 0;
            font-size: 11px;
        }

        select[multiple] option:checked {
            background: var(--accent);
            color: #fff;
        }

        /* Helper text for multi-select - hidden now that we have controls */
        .multi-select-hint {
            display: none;
        }

        /* Multi-select enhancements */
        .multi-select-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 4px;
            gap: 6px;
        }

        .multi-select-count {
            font-size: 10px;
            color: var(--accent);
            font-weight: 600;
        }

        .multi-select-buttons {
            display: flex;
            gap: 4px;
        }

        .select-all-btn, .clear-selection-btn {
            font-size: 9px;
            padding: 2px 6px;
            border: 1px solid var(--border);
            background: var(--border-light);
            color: var(--text-secondary);
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .select-all-btn:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .clear-selection-btn:hover {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
            border-color: #ff4444;
        }

        .selected-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
            margin-top: 4px;
            min-height: 20px;
        }

        .chip {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 2px 6px;
            background: var(--accent);
            color: white;
            border-radius: 12px;
            font-size: 9px;
            font-weight: 600;
            animation: chipAppear 0.2s ease;
        }

        @keyframes chipAppear {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .chip .chip-remove {
            cursor: pointer;
            padding: 0 2px;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .chip .chip-remove:hover {
            opacity: 1;
        }

        /* Area search box */
        .area-search-box {
            margin-bottom: 4px;
        }

        .area-search-input {
            width: 100%;
            padding: 4px 6px;
            border: 1px solid var(--input-border);
            background: var(--input-bg);
            color: var(--text-primary);
            border-radius: 4px;
            font-size: 10px;
            transition: all 0.3s;
        }

        .area-search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 2px var(--border);
        }

        .area-search-input::placeholder {
            color: var(--text-secondary);
            font-style: italic;
        }

        /* Collapsible Location Search */
        .location-search-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px;
            background: var(--border-light);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }

        .location-search-header:hover {
            background: var(--border);
        }

        .location-search-header .header-text {
            font-size: 11px;
            font-weight: 600;
            color: var(--accent);
        }

        .location-search-header .toggle-icon {
            font-size: 12px;
            color: var(--text-secondary);
            transition: transform 0.3s;
        }

        .location-search-header.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .location-search-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }

        .location-search-content.expanded {
            max-height: 500px;
            overflow: visible;
        }

        .location-search-inner {
            padding-top: 8px;
            position: relative;
        }

        /* Location autocomplete suggestions */
        .location-suggestions {
            position: absolute;
            top: 28px;
            left: 0;
            right: 0;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10000;
            box-shadow: 0 4px 12px var(--shadow);
            display: none;
            margin-top: 2px;
        }

        .location-suggestions.show {
            display: block !important;
        }

        .suggestion-item {
            padding: 6px 8px;
            font-size: 11px;
            color: var(--text-primary);
            cursor: pointer;
            transition: all 0.2s;
            border-bottom: 1px solid var(--border-light);
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-item:hover,
        .suggestion-item.selected {
            background: var(--accent);
            color: white;
        }

        .suggestion-item .match {
            font-weight: 600;
            color: var(--accent);
        }

        .suggestion-item:hover .match,
        .suggestion-item.selected .match {
            color: white;
        }

        .suggestion-category {
            font-size: 9px;
            color: var(--text-secondary);
            padding: 4px 8px;
            background: var(--border-light);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 10px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .checkbox-item label {
            font-size: 13px;
            cursor: pointer;
        }

        .layer-controls {
            margin-top: 15px;
            padding-top: 12px;
            border-top: 1px solid var(--border);
        }

        .layer-toggle {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px;
            margin-bottom: 6px;
            background: var(--border-light);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 12px;
        }

        .layer-toggle:hover {
            background: var(--border);
            transform: translateX(-2px);
        }

        .layer-toggle.active {
            background: var(--border);
            border-left: 3px solid var(--accent);
        }

        .stats-panel {
            margin-top: 12px;
            padding: 10px;
            background: var(--border-light);
            border-radius: 6px;
            border-left: 3px solid var(--accent);
        }

        .stats-panel h3 {
            font-size: 12px;
            margin-bottom: 6px;
            color: var(--accent);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: 3px 0;
            font-size: 11px;
        }

        .stat-value {
            font-weight: 700;
            color: var(--accent);
        }

        .attribution-disclaimer {
            font-size: 9px;
            color: var(--text-secondary);
            font-style: italic;
            margin-top: 6px;
            padding-top: 6px;
            border-top: 1px solid var(--border);
        }

        .loading {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            z-index: 10000;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .loading-content {
            background: var(--bg-panel);
            padding: 30px 50px;
            border-radius: 12px;
            box-shadow: 0 8px 32px var(--shadow);
            text-align: center;
            min-width: 400px;
            width: 400px;
        }

        .loading-spinner {
            border: 4px solid var(--border);
            border-top: 4px solid var(--accent);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .hidden {
            display: none;
        }

        .apply-filters-btn {
            width: 100%;
            padding: 6px;
            margin-top: 6px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .apply-filters-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 16px var(--border);
        }

        .apply-filters-btn:active {
            transform: translateY(0);
        }

        .clear-filters-btn {
            width: 100%;
            padding: 6px;
            margin-top: 4px;
            background: var(--border-light);
            color: var(--text-primary);
            border: 1px solid var(--border);
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
        }

        .clear-filters-btn:hover {
            background: rgba(255, 68, 68, 0.2);
            border-color: #ff4444;
            color: #ff4444;
            transform: translateY(-2px);
        }

        .clear-filters-btn:active {
            transform: translateY(0);
        }

        /* Auto-apply toggle */
        .auto-apply-container {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px;
            margin: 8px 0;
            background: var(--border-light);
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .auto-apply-container input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--accent);
        }

        .auto-apply-container label {
            font-size: 11px;
            color: var(--text-primary);
            cursor: pointer;
            user-select: none;
        }

        /* Applying state animation */
        .apply-filters-btn.applying {
            position: relative;
            color: transparent;
        }

        .apply-filters-btn.applying::after {
            content: 'Applying...';
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            color: white;
            animation: pulse 1s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        /* Changed filters indicator */
        .filter-changed {
            position: relative;
        }

        .filter-changed::before {
            content: '';
            position: absolute;
            left: -8px;
            top: 50%;
            transform: translateY(-50%);
            width: 4px;
            height: 4px;
            background: var(--accent);
            border-radius: 50%;
            animation: blip 2s infinite;
        }

        @keyframes blip {
            0%, 100% { opacity: 1; transform: translateY(-50%) scale(1); }
            50% { opacity: 0.5; transform: translateY(-50%) scale(1.3); }
        }

        .toggle-panel-btn {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1001;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            color: var(--accent);
            padding: 12px 18px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            display: none;
        }

        /* Layer info icon and tooltip */
        .layer-label-container {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .layer-info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 14px;
            height: 14px;
            background: transparent;
            color: var(--text-secondary);
            font-size: 10px;
            font-weight: bold;
            cursor: help;
            transition: all 0.2s;
            position: relative;
            flex-shrink: 0;
        }

        .layer-info-icon:hover {
            border-color: var(--accent);
            color: var(--accent);
            transform: scale(1.15);
        }

        .layer-info-tooltip {
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            margin-bottom: 8px;
            background: var(--bg-panel);
            border: 2px solid var(--accent);
            border-radius: 6px;
            padding: 6px 10px;
            width: max-content;
            max-width: 150px;
            font-size: 10px;
            line-height: 1.3;
            color: var(--text-primary);
            box-shadow: 0 4px 16px var(--shadow);
            z-index: 10000;
            pointer-events: none;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s;
            white-space: normal;
            text-align: center;
        }

        .layer-info-icon:hover .layer-info-tooltip {
            opacity: 1;
            visibility: visible;
        }

        .layer-info-tooltip strong {
            color: var(--accent);
        }

        @media (max-width: 768px) {
            .controls-panel {
                right: -100%;
                transition: right 0.3s;
                max-width: 90%;
            }

            .controls-panel.visible {
                right: 20px;
            }

            .toggle-panel-btn {
                display: block;
            }
        }

        /* Advanced Filters Button */
        .advanced-filters-btn {
            width: 100%;
            padding: 12px;
            margin: 10px 0;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .advanced-filters-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .filter-badge {
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ff4444;
            color: white;
            border-radius: 12px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .modal-content {
            background: var(--bg-secondary);
            margin: 3% auto;
            border-radius: 12px;
            width: 90%;
            max-width: 700px;
            max-height: 85vh;
            box-shadow: 0 10px 40px var(--shadow);
            display: flex;
            flex-direction: column;
            animation: slideIn 0.3s;
            border: 1px solid var(--border);
        }

        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h2 {
            margin: 0;
            color: var(--accent);
            font-size: 20px;
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 32px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            line-height: 32px;
            transition: color 0.2s;
        }

        .modal-close:hover {
            color: var(--text-primary);
        }

        .modal-tabs {
            display: flex;
            padding: 0 24px;
            border-bottom: 1px solid var(--border);
            background: var(--bg-primary);
        }

        .tab-btn {
            padding: 12px 20px;
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
        }

        .tab-btn:hover {
            color: var(--accent);
        }

        .tab-btn.active {
            color: var(--accent);
            border-bottom-color: var(--accent);
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            flex: 1;
            min-height: 300px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .modal-apply-btn, .modal-cancel-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }

        .modal-apply-btn {
            background: var(--accent);
            color: white;
        }

        .modal-apply-btn:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px var(--shadow);
        }

        .modal-cancel-btn {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border: 1px solid var(--border);
        }

        .modal-cancel-btn:hover {
            background: var(--border-light);
        }

        /* Mobile responsive modal */
        @media (max-width: 768px) {
            .modal-content {
                width: 95%;
                margin: 5% auto;
                max-height: 90vh;
            }

            .modal-tabs {
                overflow-x: auto;
            }

            .tab-btn {
                font-size: 12px;
                padding: 10px 16px;
            }
        }

        /* noUiSlider Custom Styling */
        .noUi-target {
            background: var(--bg-secondary);
            border: none;
            box-shadow: inset 0 1px 3px var(--shadow);
            border-radius: 3px;
            height: 6px;
        }

        .noUi-horizontal {
            height: 10px;
        }

        .noUi-horizontal .noUi-handle {
            width: 16px;
            height: 16px;
            right: -8px;
            top: -5px;
        }

        .noUi-horizontal .noUi-tooltip {
            transform: 0;
            -webkit-transform: translate(-50%, 100%)
        }

        .noUi-connect {
            background: var(--accent);
        }

        .noUi-handle {
            background: var(--accent);
            border: 2px solid var(--bg-primary);
            border-radius: 50%;
            box-shadow: 0 2px 6px var(--shadow);
            cursor: pointer;
        }

        .noUi-handle:before,
        .noUi-handle:after {
            display: none;
        }

        .noUi-handle:hover {
            background: var(--accent-hover);
            box-shadow: 0 2px 8px var(--shadow);
        }

        .noUi-handle:active {
            transform: scale(1.15);
        }

        .noUi-tooltip {
            background: var(--bg-secondary);
            border: 1px solid var(--accent);
            color: var(--accent);
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 3px;
            bottom: 130%;
        }

        /* Leaflet Layer Control Styling */
        .leaflet-control-layers {
            background: var(--bg-panel);
            border: 1px solid var(--border);
            border-radius: 8px;
            box-shadow: 0 4px 12px var(--shadow);
        }

        .leaflet-control-layers-toggle {
            background-image: none;
            width: 36px;
            height: 36px;
            background: var(--bg-panel);
            border-radius: 8px;
        }

        .leaflet-control-layers-toggle::before {
            content: "üó∫Ô∏è";
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
        }

        .leaflet-control-layers-expanded {
            padding: 10px;
            color: var(--text-primary);
        }

        .leaflet-control-layers-base label {
            color: var(--text-primary);
            font-size: 13px;
            padding: 4px 0;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: color 0.2s;
        }

        .leaflet-control-layers-base label:hover {
            color: var(--accent);
        }

        .leaflet-control-layers-base input[type="radio"] {
            accent-color: var(--accent);
            margin-right: 8px;
            cursor: pointer;
        }

        .leaflet-control-layers-separator {
            border-top: 1px solid var(--border);
            margin: 8px 0;
        }

        /* Footer Styles */
        .page-footer {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-panel);
            backdrop-filter: blur(10px);
            border-top: 1px solid var(--border);
            padding: 10px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 999;
            font-size: 12px;
            box-shadow: 0 -4px 12px var(--shadow);
        }

        .footer-links {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .footer-links a {
            color: var(--accent);
            text-decoration: none;
            transition: all 0.2s;
            font-weight: 500;
        }

        .footer-links a:hover {
            color: var(--accent-hover);
            text-decoration: underline;
        }

        .footer-attribution {
            color: var(--text-secondary);
            font-size: 11px;
        }

        .footer-attribution a {
            color: var(--accent);
            text-decoration: none;
        }

        .footer-attribution a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .page-footer {
                flex-direction: column;
                gap: 8px;
                padding: 12px 15px;
                text-align: center;
            }

            .footer-links {
                justify-content: center;
                gap: 10px;
            }

            .footer-links a {
                font-size: 11px;
            }

            .footer-attribution {
                font-size: 10px;
            }
        }

        /* Fullscreen Info Modals */
        .info-modal {
            display: none;
            position: fixed;
            z-index: 20000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: var(--bg-primary);
            overflow-y: auto;
            animation: fadeIn 0.3s;
        }

        .info-modal.show {
            display: block;
        }

        .info-modal-header {
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            border-bottom: 3px solid var(--accent);
            padding: 20px;
            z-index: 100;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .info-modal-header h1 {
            color: var(--accent);
            font-size: 24px;
            margin: 0;
        }

        .info-modal-close {
            background: var(--accent);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .info-modal-close:hover {
            background: var(--accent-hover);
            transform: scale(1.05);
        }

        .info-modal-container {
            max-width: 900px;
            margin: 0 auto;
            padding: 30px 20px 60px 20px;
        }

        .info-modal-section {
            background: var(--bg-secondary);
            border-left: 4px solid var(--accent);
            padding: 18px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow);
        }

        .info-modal h2 {
            color: var(--accent);
            font-size: 18px;
            margin-bottom: 12px;
        }

        .info-modal h3 {
            color: var(--accent);
            font-size: 15px;
            margin: 15px 0 8px 0;
        }

        .info-modal h4 {
            color: var(--accent);
            font-size: 13px;
            margin: 12px 0 6px 0;
        }

        .info-modal p {
            margin-bottom: 10px;
            color: var(--text-primary);
            font-size: 13px;
            line-height: 1.5;
        }

        .info-modal ul, .info-modal ol {
            margin-left: 25px;
            margin-bottom: 12px;
            font-size: 13px;
        }

        .info-modal li {
            margin-bottom: 6px;
            line-height: 1.4;
        }

        .info-modal table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
            background: var(--bg-primary);
            box-shadow: 0 2px 6px var(--shadow);
            font-size: 12px;
        }

        .info-modal th, .info-modal td {
            padding: 8px;
            text-align: left;
            border-bottom: 1px solid var(--border);
        }

        .info-modal th {
            background: var(--accent);
            color: white;
            font-weight: 600;
            font-size: 12px;
        }

        .info-modal tr:hover {
            background: var(--bg-secondary);
        }

        .info-modal code {
            background: var(--input-bg);
            padding: 2px 5px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
        }

        .info-modal .important-notice {
            background: rgba(255, 68, 68, 0.1);
            border-left: 4px solid #ff4444;
            padding: 15px;
            margin: 20px 0;
            border-radius: 8px;
        }

        .info-modal .important-notice h3 {
            color: #ff4444;
            margin-bottom: 8px;
            font-size: 15px;
        }

        .info-modal .info-box {
            background: rgba(74, 144, 226, 0.1);
            border-left: 4px solid var(--accent);
            padding: 12px;
            margin: 15px 0;
            border-radius: 8px;
            font-size: 13px;
        }

        .info-modal .info-box strong {
            color: var(--accent);
        }

        .info-modal a {
            color: var(--accent);
            text-decoration: none;
        }

        .info-modal a:hover {
            text-decoration: underline;
        }

        @media (max-width: 768px) {
            .info-modal-header h1 {
                font-size: 20px;
            }

            .info-modal-container {
                padding: 20px 15px 50px 15px;
            }

            .info-modal h2 {
                font-size: 16px;
            }

            .info-modal p, .info-modal ul, .info-modal ol {
                font-size: 12px;
            }
        }

        /* Checkbox Groups */
        .checkbox-filter-group {
            display: flex;
            flex-direction: column;
            max-height: 200px;
            overflow-y: auto;
            padding: 4px;
            background: var(--bg-secondary);
            border-radius: 6px;
            border: 1px solid var(--border);
        }

        .checkbox-filter-group::-webkit-scrollbar {
            width: 6px;
        }

        .checkbox-filter-group::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 3px;
        }

        .checkbox-filter-group::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 3px;
        }

        .checkbox-filter-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 4px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .checkbox-filter-item:hover {
            background: var(--border-light);
        }

        .checkbox-filter-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--accent);
            flex-shrink: 0;
        }

        .checkbox-filter-item label {
            font-size: 12px;
            cursor: pointer;
            flex: 1;
            user-select: none;
        }

        .checkbox-select-controls {
            display: flex;
            gap: 4px;
            margin-top: 4px;
        }

        .checkbox-select-all, .checkbox-clear-all {
            flex: 1;
            font-size: 9px;
            padding: 3px 6px;
            border: 1px solid var(--border);
            background: var(--border-light);
            color: var(--text-secondary);
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkbox-select-all:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .checkbox-clear-all:hover {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
            border-color: #ff4444;
        }

        /* Custom Checkbox Dropdown */
        .checkbox-dropdown {
            position: relative;
            width: 100%;
        }

        .checkbox-dropdown-trigger {
            width: 100%;
            padding: 5px 30px 5px 6px;
            border-radius: 4px;
            border: 1px solid var(--input-border);
            background: var(--input-bg);
            color: var(--text-primary);
            font-size: 13px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: left;
            position: relative;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .checkbox-dropdown-trigger:hover {
            border-color: var(--accent);
        }

        .checkbox-dropdown-trigger.open {
            border-color: var(--accent);
            box-shadow: 0 0 0 3px var(--border);
        }

        .checkbox-dropdown-arrow {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
            color: var(--text-secondary);
            font-size: 10px;
            transition: transform 0.3s;
        }

        .checkbox-dropdown-trigger.open .checkbox-dropdown-arrow {
            transform: translateY(-50%) rotate(180deg);
        }

        .checkbox-dropdown-menu {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            margin-top: 4px;
            background: var(--input-bg);
            border: 1px solid var(--accent);
            border-radius: 6px;
            box-shadow: 0 4px 12px var(--shadow);
            z-index: 1000;
            max-height: 250px;
            overflow-y: auto;
            display: none;
            padding: 4px;
        }

        .checkbox-dropdown-menu.show {
            display: block;
        }

        .checkbox-dropdown-menu::-webkit-scrollbar {
            width: 6px;
        }

        .checkbox-dropdown-menu::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 3px;
        }

        .checkbox-dropdown-menu::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 3px;
        }

        .checkbox-dropdown-item {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 4px 6px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .checkbox-dropdown-item:hover {
            background: var(--border-light);
        }

        .checkbox-dropdown-item input[type="checkbox"] {
            width: 16px;
            height: 16px;
            cursor: pointer;
            accent-color: var(--accent);
            flex-shrink: 0;
        }

        .checkbox-dropdown-item label {
            font-size: 13px;
            cursor: pointer;
            flex: 1;
            user-select: none;
        }

        .checkbox-dropdown-controls {
            display: flex;
            gap: 4px;
            padding: 4px;
            border-top: 1px solid var(--border);
            margin-top: 4px;
        }

        .checkbox-dropdown-controls button {
            flex: 1;
            font-size: 9px;
            padding: 3px 6px;
            border: 1px solid var(--border);
            background: var(--border-light);
            color: var(--text-secondary);
            border-radius: 3px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .checkbox-dropdown-controls button:first-child:hover {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .checkbox-dropdown-controls button:last-child:hover {
            background: rgba(255, 68, 68, 0.2);
            color: #ff4444;
            border-color: #ff4444;
        }

        /* Analytics Panel */
        .analytics-panel {
            position: absolute;
            bottom: 45px;
            left: 5px;
            background: var(--bg-panel);
            backdrop-filter: blur(10px);
            border-radius: 12px;
            padding: 0;
            max-width: 600px;
            width: calc(100% - 40px);
            max-height: 400px;
            z-index: 1000;
            box-shadow: 0 8px 32px var(--shadow);
            border: 1px solid var(--border);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .analytics-panel.collapsed {
            max-height: 45px;
            max-width: 200px;
        }

        .analytics-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            user-select: none;
        }

        .analytics-header:hover {
            background: var(--border-light);
        }

        .analytics-header h3 {
            margin: 0;
            font-size: 13px;
            color: var(--accent);
            font-weight: 700;
        }

        .analytics-toggle {
            font-size: 12px;
            color: var(--text-secondary);
            transition: transform 0.3s;
        }

        .analytics-panel.collapsed .analytics-toggle {
            transform: rotate(180deg);
        }

        .analytics-content {
            padding: 15px;
            max-height: 340px;
            overflow-y: auto;
        }

        .analytics-content::-webkit-scrollbar {
            width: 8px;
        }

        .analytics-content::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 4px;
        }

        .analytics-content::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 4px;
        }

        .chart-container {
            margin-bottom: 20px;
            background: var(--bg-secondary);
            padding: 15px;
            border-radius: 8px;
            border: 1px solid var(--border);
        }

        .chart-container h4 {
            margin: 0 0 10px 0;
            font-size: 12px;
            color: var(--accent);
            font-weight: 600;
        }

        .chart-wrapper {
            position: relative;
            height: 200px;
        }

        @media (max-width: 768px) {
            .analytics-panel {
                left: 10px;
                width: calc(100% - 20px);
                bottom: 80px;
            }
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <button class="toggle-panel-btn" onclick="togglePanel()">‚ò∞ Filters</button>

    <div class="controls-panel" id="controlsPanel">
        <div class="panel-header">
            <span>Explorer</span>
            <div style="display: flex; gap: 5px;">
                <button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle Light/Dark Mode">
                    <span id="themeIcon">‚òÄÔ∏è</span>
                </button>
                <button class="collapse-btn" onclick="togglePanelCollapse()" title="Collapse/Expand">
                    <span id="collapseIcon">‚ñ≤</span>
                </button>
            </div>
        </div>

        <div class="panel-content">
        <!-- Location Search - Collapsible -->
        <div class="filter-group" style="border-bottom: 2px solid var(--border); padding-bottom: 12px; margin-bottom: 12px;">
            <div class="location-search-header" onclick="toggleLocationSearch()">
                <span class="header-text">üîç Search by Location</span>
                <span class="toggle-icon">‚ñº</span>
            </div>

            <div class="location-search-content" id="locationSearchContent">
                <div class="location-search-inner">
                    <input type="text" id="locationSearch" placeholder="Enter suburb, street, or landmark..."
                        autocomplete="off"
                        oninput="handleLocationInput(this.value)"
                        onkeydown="handleLocationKeydown(event)"
                        style="width: 100%; padding: 5px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-primary); font-size: 11px;">

                    <!-- Suggestions dropdown -->
                    <div class="location-suggestions" id="locationSuggestions"></div>

                    <div style="display: flex; gap: 4px; margin-top: 6px; align-items: center;">
                        <label style="font-size: 10px; color: var(--text-secondary); white-space: nowrap;">Radius:</label>
                        <select id="searchRadius" style="flex: 1; padding: 3px; font-size: 10px; border-radius: 4px; border: 1px solid var(--input-border); background: var(--input-bg); color: var(--text-primary);">
                            <option value="0.5">0.5 km</option>
                            <option value="1">1 km</option>
                            <option value="2" selected>2 km</option>
                            <option value="3">3 km</option>
                            <option value="5">5 km</option>
                            <option value="7">7 km</option>
                            <option value="10">10 km</option>
                            <option value="15">15 km</option>
                            <option value="20">20 km</option>
                            <option value="25">25 km</option>
                            <option value="50">50 km</option>
                        </select>
                    </div>

                    <div style="display: flex; gap: 4px; margin-top: 6px;">
                        <button onclick="searchByLocation()" class="apply-filters-btn" style="flex: 1; padding: 5px; font-size: 11px;">Search</button>
                        <button onclick="clearLocationSearch()" class="clear-filters-btn" style="flex: 1; padding: 5px; font-size: 11px;">Clear</button>
                    </div>

                    <div id="searchResults" style="display: none; margin-top: 6px; padding: 6px; background: var(--border-light); border-radius: 4px; font-size: 10px; color: var(--accent);"></div>
                </div>
            </div>
        </div>

        <div class="filter-group">
            <label class="filter-label">Year Range: <span id="yearRangeDisplay">2012 - 2024</span></label>
            <div id="yearRangeSlider" style="margin: 8px 5px 12px 5px;"></div>
        </div>

        <div class="filter-group">
            <label class="filter-label">Crash Severity</label>
            <div class="checkbox-dropdown" id="severityDropdown">
                <div class="checkbox-dropdown-trigger" onclick="toggleCheckboxDropdown('severity')">
                    <span id="severityDisplay">All Severities</span>
                    <span class="dropdown-arrow">‚ñº</span>
                </div>
                <div class="checkbox-dropdown-menu" id="severityMenu">
                    <div class="checkbox-dropdown-item">
                        <input type="checkbox" id="severity-pdo" value="1: PDO" checked onchange="updateCheckboxDropdownDisplay('severity')">
                        <label for="severity-pdo">PDO (Property Damage Only)</label>
                    </div>
                    <div class="checkbox-dropdown-item">
                        <input type="checkbox" id="severity-mi" value="2: MI" checked onchange="updateCheckboxDropdownDisplay('severity')">
                        <label for="severity-mi">Minor Injury</label>
                    </div>
                    <div class="checkbox-dropdown-item">
                        <input type="checkbox" id="severity-si" value="3: SI" checked onchange="updateCheckboxDropdownDisplay('severity')">
                        <label for="severity-si">Serious Injury</label>
                    </div>
                    <div class="checkbox-dropdown-item">
                        <input type="checkbox" id="severity-fatal" value="4: Fatal" checked onchange="updateCheckboxDropdownDisplay('severity')">
                        <label for="severity-fatal">Fatal</label>
                    </div>
                    <div class="checkbox-dropdown-controls">
                        <button class="checkbox-select-all" onclick="selectAllDropdownItems('severity')">Select All</button>
                        <button class="checkbox-clear-all" onclick="clearAllDropdownItems('severity')">Clear All</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="filter-group">
            <label class="filter-label">Crash Type</label>
            <div class="checkbox-dropdown" id="crashTypeDropdown">
                <div class="checkbox-dropdown-trigger" onclick="toggleCheckboxDropdown('crashType')">
                    <span id="crashTypeDisplay">All Types</span>
                    <span class="dropdown-arrow">‚ñº</span>
                </div>
                <div class="checkbox-dropdown-menu" id="crashTypeMenu">
                    <!-- Options will be populated by app.js -->
                </div>
            </div>
        </div>

        <div class="filter-group">
            <label class="filter-label">Area</label>
            <div class="checkbox-dropdown" id="areaDropdown">
                <div class="checkbox-dropdown-trigger" onclick="toggleCheckboxDropdown('area')">
                    <span id="areaDisplay">All Areas</span>
                    <span class="dropdown-arrow">‚ñº</span>
                </div>
                <div class="checkbox-dropdown-menu" id="areaMenu">
                    <!-- Options will be populated by app.js -->
                </div>
            </div>
        </div>

        <button class="advanced-filters-btn" onclick="openAdvancedFilters()">
            üîç Advanced Filters
            <span id="advancedFilterBadge" class="filter-badge" style="display: none;">0</span>
        </button>

        <!-- Auto-apply toggle -->
        <div class="auto-apply-container">
            <input type="checkbox" id="autoApplyCheckbox" onchange="toggleAutoApply(this.checked)">
            <label for="autoApplyCheckbox">‚ö° Auto-apply filters (500ms delay)</label>
        </div>

        <div style="display: flex; gap: 8px;">
            <button class="apply-filters-btn" id="applyFilters" onclick="applyFilters()" style="flex: 1;">Apply Filters</button>
            <button class="clear-filters-btn" onclick="clearFilters()" style="flex: 1;">Clear Filters</button>
        </div>

        <button onclick="shareCurrentView()" style="width: 100%; padding: 8px; margin-top: 8px; background: var(--border-light); color: var(--accent); border: 1px solid var(--accent); border-radius: 4px; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.3s;" onmouseover="this.style.background='var(--accent)'; this.style.color='#fff';" onmouseout="this.style.background='var(--border-light)'; this.style.color='var(--accent)';">
            üîó Share Current View
        </button>

        <div class="layer-controls">
            <div class="filter-label" style="margin-bottom: 6px; margin-top: 4px;">Map Layers</div>
            <div class="layer-toggle active" id="markersToggle" onclick="toggleLayer('markers')">
                <span>üéØ Clustered Markers</span>
                <span id="markersStatus">ON</span>
            </div>
            <div class="layer-toggle" id="densityToggle" onclick="toggleLayer('density')">
                <div class="layer-label-container">
                    <span>üí† Point Density Map</span>
                    <div class="layer-info-icon" onclick="event.stopPropagation()">
                        ‚ìò
                        <div class="layer-info-tooltip">
                            Best viewed on <strong>Dark</strong> basemap
                        </div>
                    </div>
                </div>
                <span id="densityStatus">OFF</span>
            </div>
            <div class="layer-toggle" id="choroplethToggle" onclick="toggleLayer('choropleth')">
                <span>üó∫Ô∏è Choropleth (by LGA)</span>
                <span id="choroplethStatus">OFF</span>
            </div>
        </div>

        <div class="stats-panel">
            <h3>Statistics</h3>
            <div class="stat-item">
                <span>Total Crashes:</span>
                <span class="stat-value" id="totalCrashes">0</span>
            </div>
            <div class="stat-item">
                <span>Fatalities:</span>
                <span class="stat-value" id="totalFatalities">0</span>
            </div>
            <div class="stat-item">
                <span>Serious Injuries:</span>
                <span class="stat-value" id="totalSerious">0</span>
            </div>
            <div class="stat-item">
                <span>Minor Injuries:</span>
                <span class="stat-value" id="totalMinor">0</span>
            </div>
        </div>
        </div><!-- End panel-content -->
    </div>

    <!-- Advanced Filters Modal -->
    <div id="advancedFiltersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Advanced Filters</h2>
                <button class="modal-close" onclick="closeAdvancedFilters()">&times;</button>
            </div>

            <div class="modal-tabs">
                <button class="tab-btn active" onclick="switchTab('conditions')">Crash Conditions</button>
                <button class="tab-btn" onclick="switchTab('casualties')">Casualties</button>
                <button class="tab-btn" onclick="switchTab('vehicles')">Vehicles & Units</button>
            </div>

            <div class="modal-body">
                <!-- Crash Conditions Tab -->
                <div id="conditionsTab" class="tab-content active">
                    <div class="filter-group">
                        <label class="filter-label">Weather Condition</label>
                        <select id="weather">
                            <option value="all" selected>All Weather</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Day/Night</label>
                        <select id="dayNight">
                            <option value="all" selected>All</option>
                            <option value="Day">Day</option>
                            <option value="Night">Night</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Time of Day (Optional)</label>
                        <div style="display: flex; gap: 8px; align-items: center; margin-top: 5px;">
                            <div style="flex: 1;">
                                <label style="font-size: 10px; color: var(--accent);">From:</label>
                                <input type="time" id="timeFrom">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 10px; color: var(--accent);">To:</label>
                                <input type="time" id="timeTo">
                            </div>
                        </div>
                        <div style="font-size: 9px; color: var(--text-secondary); margin-top: 3px;">Leave empty for all times</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Date Range (Optional)</label>
                        <div style="display: flex; gap: 8px; align-items: center; margin-top: 5px;">
                            <div style="flex: 1;">
                                <label style="font-size: 10px; color: var(--accent);">From:</label>
                                <input type="date" id="dateFrom">
                            </div>
                            <div style="flex: 1;">
                                <label style="font-size: 10px; color: var(--accent);">To:</label>
                                <input type="date" id="dateTo">
                            </div>
                        </div>
                        <div style="font-size: 9px; color: var(--text-secondary); margin-top: 3px;">Leave empty to use year range only</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">DUI Involved</label>
                        <select id="duiInvolved">
                            <option value="all" selected>All</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Road Surface</label>
                        <select id="roadSurface" multiple size="4">
                            <option value="all" selected>All Surfaces</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Moisture Condition</label>
                        <select id="moistureCond" multiple size="4">
                            <option value="all" selected>All Conditions</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Drugs Involved</label>
                        <select id="drugsInvolved">
                            <option value="all" selected>All</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                </div>

                <!-- Casualties Tab -->
                <div id="casualtiesTab" class="tab-content">
                    <div class="filter-group">
                        <label class="filter-label">Road User Type</label>
                        <select id="roadUserType" multiple size="4">
                            <option value="all" selected>All Road Users</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Age Group</label>
                        <select id="ageGroup" multiple size="4">
                            <option value="all" selected>All Ages</option>
                            <option value="0-17">0-17 (Youth)</option>
                            <option value="18-25">18-25 (Young Adult)</option>
                            <option value="26-35">26-35</option>
                            <option value="36-50">36-50</option>
                            <option value="51-65">51-65</option>
                            <option value="66+">66+ (Senior)</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Casualty Sex</label>
                        <select id="casualtySex" multiple size="3">
                            <option value="all" selected>All</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Injury Extent</label>
                        <select id="injuryExtent" multiple size="4">
                            <option value="all" selected>All Injuries</option>
                            <option value="Fatal">Fatal</option>
                            <option value="Serious injury">Serious Injury</option>
                            <option value="Minor injury">Minor Injury</option>
                            <option value="Not injured">Not Injured</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Seat Belt Usage</label>
                        <select id="seatBelt" multiple size="3">
                            <option value="all" selected>All</option>
                            <option value="Yes">Worn</option>
                            <option value="No">Not Worn</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Helmet Usage</label>
                        <select id="helmet" multiple size="3">
                            <option value="all" selected>All</option>
                            <option value="Worn">Worn</option>
                            <option value="Not Worn">Not Worn</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>
                </div>

                <!-- Vehicles & Units Tab -->
                <div id="vehiclesTab" class="tab-content">
                    <div class="filter-group">
                        <label class="filter-label">Heavy Vehicle Involved</label>
                        <select id="heavyVehicle">
                            <option value="all" selected>All Vehicles</option>
                            <option value="yes">Heavy Vehicles Only</option>
                            <option value="no">No Heavy Vehicles</option>
                        </select>
                        <div style="font-size: 9px; color: var(--text-secondary); margin-top: 3px;">
                            Heavy vehicles: Trucks (‚â•4.5T), Semi-trailers, B-doubles, Road trains, Buses
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Involved Entities</label>
                        <select id="vehicleType" multiple size="4">
                            <option value="all" selected>All Entities</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Vehicle Year</label>
                        <select id="vehicleYear" multiple size="4">
                            <option value="all" selected>All Years</option>
                            <option value="pre-2000">Before 2000</option>
                            <option value="2000-2010">2000-2010</option>
                            <option value="2011-2020">2011-2020</option>
                            <option value="2021+">2021 or Newer</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Number of Occupants</label>
                        <select id="occupants" multiple size="4">
                            <option value="all" selected>All</option>
                            <option value="1">1 Occupant</option>
                            <option value="2">2 Occupants</option>
                            <option value="3-4">3-4 Occupants</option>
                            <option value="5+">5+ Occupants</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Towing</label>
                        <select id="towing">
                            <option value="all" selected>All</option>
                            <option value="Yes">Towing</option>
                            <option value="No">Not Towing</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Rollover Involved</label>
                        <select id="rollover">
                            <option value="all" selected>All</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Fire Involved</label>
                        <select id="fire">
                            <option value="all" selected>All</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">License Type</label>
                        <select id="licenseType" multiple size="4">
                            <option value="all" selected>All License Types</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Vehicle Reg State</label>
                        <select id="vehRegState" multiple size="4">
                            <option value="all" selected>All States</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Direction of Travel</label>
                        <select id="directionTravel" multiple size="4">
                            <option value="all" selected>All Directions</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Unit Movement</label>
                        <select id="unitMovement" multiple size="4">
                            <option value="all" selected>All Movements</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="modal-apply-btn" onclick="applyAdvancedFilters()">Apply Filters</button>
                <button class="modal-cancel-btn" onclick="closeAdvancedFilters()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div>Loading crash data...</div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet MarkerCluster -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <!-- Leaflet Heat (for Density Map) -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <!-- noUiSlider JS -->
    <script src="https://unpkg.com/nouislider@15.7.1/dist/nouislider.min.js"></script>

    <!-- PapaParse for CSV -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- Proj4js for coordinate conversion -->
    <script src="https://unpkg.com/proj4@2.9.0/dist/proj4.js"></script>

    <!-- Turf.js for geospatial operations (point-in-polygon) -->
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script src="app.js"></script>

    <!-- Analytics Panel -->
    <div class="analytics-panel collapsed" id="analyticsPanel">
        <div class="analytics-header" onclick="toggleAnalyticsPanel()">
            <h3>üìä Analytics Dashboard</h3>
            <span class="analytics-toggle">‚ñº</span>
        </div>
        <div class="analytics-content">
            <div class="chart-container">
                <h4>Crashes Over Time</h4>
                <div class="chart-wrapper">
                    <canvas id="crashesOverTimeChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <h4>Crashes by Day of Week</h4>
                <div class="chart-wrapper">
                    <canvas id="crashesByDayChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <h4>Crashes by Hour</h4>
                <div class="chart-wrapper">
                    <canvas id="crashesByHourChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <h4>Severity Distribution</h4>
                <div class="chart-wrapper">
                    <canvas id="severityDistributionChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Disclaimer Modal -->
    <div id="disclaimerModal" class="info-modal">
        <div class="info-modal-header">
            <h1>Disclaimer</h1>
            <button class="info-modal-close" onclick="closeInfoModal('disclaimerModal')">Close</button>
        </div>
        <div class="info-modal-container">
            <div class="important-notice">
                <h3>‚ö†Ô∏è Important Notice</h3>
                <p><strong>This website is provided for informational and visualisation purposes only. It must not be relied upon for legal, insurance, regulatory, enforcement, property, safety, or emergency decision-making.</strong></p>
            </div>

            <div class="info-modal-section">
                <h2>Data Source</h2>
                <p>All crash data displayed on this website is sourced from publicly available datasets published by <strong>Data SA</strong> (Government of South Australia).</p>
                <p>The original datasets can be accessed at: <a href="https://data.sa.gov.au" target="_blank" rel="noopener noreferrer">data.sa.gov.au</a></p>
            </div>

            <div class="info-modal-section">
                <h2>Data Processing</h2>
                <p>The datasets have been cleaned and standardised across yearly releases (2012‚Äì2024) to ensure consistent formatting and comparability. No material alterations have been made to the original published records beyond necessary formatting and structural adjustments.</p>
            </div>

            <div class="info-modal-section">
                <h2>Accuracy & Limitations</h2>
                <p>While reasonable care has been taken to ensure accurate representation of the source data, <strong>no guarantee is provided</strong> regarding the completeness, accuracy, reliability, or timeliness of the information displayed.</p>
                <p>Users should verify information against official government sources where required. The data may contain errors, omissions, or outdated information.</p>
                <p>Geographic coordinates and location information may be approximate and should not be considered precise.</p>
            </div>

            <div class="info-modal-section">
                <h2>Informational Use Only</h2>
                <p>This website is provided for <strong>informational and visualisation purposes only</strong>. The information presented here must not be relied upon for:</p>
                <ul>
                    <li>Legal proceedings or decisions</li>
                    <li>Insurance claims or assessments</li>
                    <li>Regulatory compliance or reporting</li>
                    <li>Law enforcement activities</li>
                    <li>Property valuations or real estate decisions</li>
                    <li>Safety assessments or emergency planning</li>
                    <li>Any other critical or official purpose</li>
                </ul>
                <p>For official information, please consult the relevant South Australian Government agencies and authorities.</p>
            </div>

            <div class="info-modal-section">
                <h2>No Government Affiliation</h2>
                <p>This is an <strong>independent project</strong> and is not affiliated with, endorsed by, or representing the Government of South Australia, Data SA, or any other government agency.</p>
                <p>This website is not an official government resource. All official inquiries should be directed to the appropriate South Australian Government departments.</p>
            </div>

            <div class="info-modal-section">
                <h2>Privacy & Data Protection</h2>
                <p>This website only displays aggregated crash statistics from publicly available datasets. No personal information or identifiable data about individuals involved in crashes is displayed or stored.</p>
                <p>The website does not collect personal information from users beyond standard web server logs.</p>
            </div>

            <div class="info-modal-section">
                <h2>Limitation of Liability</h2>
                <p><strong>Use of this website is at your own risk.</strong> The site owner, contributors, and data providers accept no liability for any loss, damage, injury, or consequences arising directly or indirectly from:</p>
                <ul>
                    <li>The use of this website or its content</li>
                    <li>Reliance on information displayed on this website</li>
                    <li>Errors, omissions, or inaccuracies in the data</li>
                    <li>Unavailability or interruption of service</li>
                    <li>Any decisions made based on information from this website</li>
                </ul>
                <p>To the maximum extent permitted by law, all warranties, express or implied, are excluded.</p>
            </div>

            <div class="info-modal-section">
                <h2>Third-Party Services</h2>
                <p>This website uses third-party services and libraries including Leaflet (mapping), OpenStreetMap (map tiles), and various JavaScript libraries. The site owner is not responsible for the availability, accuracy, or content provided by these third-party services.</p>
            </div>

            <div class="info-modal-section">
                <h2>Changes to This Disclaimer</h2>
                <p>This disclaimer may be updated from time to time without notice. Continued use of this website constitutes acceptance of any changes to this disclaimer.</p>
                <p style="font-style: italic; color: var(--text-secondary); margin-top: 15px;">Last Updated: February 2026</p>
            </div>
        </div>
    </div>

    <!-- Methodology Modal -->
    <div id="methodologyModal" class="info-modal">
        <div class="info-modal-header">
            <h1>Data Processing Methodology</h1>
            <button class="info-modal-close" onclick="closeInfoModal('methodologyModal')">Close</button>
        </div>
        <div class="info-modal-container">
            <div class="info-modal-section">
                <h2>Overview</h2>
                <p>This page documents the data processing methodology used to prepare the South Australian crash data for visualization on this website. The goal is to provide transparency about how the raw data has been transformed and to help users understand any limitations or considerations when interpreting the visualizations.</p>
            </div>

            <div class="info-modal-section">
                <h2>Data Sources</h2>
                <p>All data is sourced from publicly available datasets published by <strong>Data SA</strong> (Government of South Australia):</p>
                <ul>
                    <li><strong>Primary Dataset:</strong> Road Crash Data (2012-2024)</li>
                    <li><strong>Source URL:</strong> <a href="https://data.sa.gov.au" target="_blank" rel="noopener noreferrer">data.sa.gov.au</a></li>
                    <li><strong>Data Format:</strong> CSV (Comma-Separated Values)</li>
                    <li><strong>Update Frequency:</strong> Periodically updated by Data SA</li>
                    <li><strong>Coverage Period:</strong> January 1, 2012 to December 31, 2024</li>
                </ul>
                <div class="info-box">
                    <strong>Note:</strong> The datasets are published by the South Australian Government under open data licensing terms. Please refer to Data SA for the most current and official data.
                </div>
            </div>

            <div class="info-modal-section">
                <h2>Data Processing Steps</h2>

                <h3>1. Data Collection & Consolidation</h3>
                <p>Yearly crash data files (2012-2024) were collected from Data SA and consolidated into a single unified dataset. This process involved:</p>
                <ul>
                    <li>Downloading individual yearly CSV files from Data SA</li>
                    <li>Merging multiple datasets while preserving all original records</li>
                    <li>Creating a combined dataset for efficient querying and visualization</li>
                </ul>

                <h3>2. Data Cleaning & Standardization</h3>
                <p>To ensure consistency across different yearly releases, the following standardization procedures were applied:</p>

                <h4>Column Name Standardization</h4>
                <ul>
                    <li>Inconsistent column names across years were normalized to a common schema</li>
                    <li>Whitespace and special characters in column headers were standardized</li>
                    <li>Column names were made case-consistent for reliable programmatic access</li>
                </ul>

                <h4>Data Type Validation</h4>
                <ul>
                    <li>Numeric fields (e.g., year, casualty counts) validated and converted to appropriate types</li>
                    <li>Date and time fields parsed and standardized to ISO 8601 format where applicable</li>
                    <li>Text fields trimmed of leading/trailing whitespace</li>
                </ul>

                <h4>Missing Data Handling</h4>
                <ul>
                    <li>Empty fields preserved as empty strings (not converted to null/undefined arbitrarily)</li>
                    <li>No imputation or artificial data generation performed</li>
                    <li>Missing geographic coordinates excluded from mapping visualizations</li>
                </ul>

                <h3>3. Geographic Coordinate Processing</h3>
                <p>The crash data includes geographic coordinates that enable map-based visualization:</p>
                <ul>
                    <li><strong>Coordinate System:</strong> Original data uses GDA2020 / MGA Zone 54 (EPSG:7854)</li>
                    <li><strong>Conversion:</strong> Coordinates converted to WGS84 (latitude/longitude) using Proj4js library for web mapping compatibility</li>
                    <li><strong>Validation:</strong> Records with missing or invalid coordinates excluded from map layers</li>
                    <li><strong>Precision:</strong> Coordinates displayed with standard precision; exact crash locations may be approximate</li>
                </ul>

                <div class="info-box">
                    <strong>Important:</strong> Geographic coordinates should be considered approximate. They are suitable for visualization and general analysis but not for precise location-based decisions.
                </div>

                <h3>4. Categorical Data Harmonization</h3>
                <p>Categorical fields (e.g., crash severity, weather conditions, crash type) were standardized:</p>
                <ul>
                    <li>Consistent encoding of categories across years</li>
                    <li>Removal of redundant or duplicate category labels</li>
                    <li>Preservation of original category meanings without reclassification</li>
                </ul>

                <h3>5. Temporal Data Processing</h3>
                <ul>
                    <li>Crash dates and times preserved in original form where available</li>
                    <li>Year extracted and validated for filtering purposes</li>
                    <li>Time-of-day filters support 24-hour format</li>
                </ul>
            </div>

            <div class="info-modal-section">
                <h2>Data Schema</h2>
                <p>The consolidated dataset includes the following key fields:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Field Category</th>
                            <th>Example Fields</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Temporal</strong></td>
                            <td>Year, Date, Time, Day/Night</td>
                            <td>When the crash occurred</td>
                        </tr>
                        <tr>
                            <td><strong>Geographic</strong></td>
                            <td>Latitude, Longitude, Area/LGA, Suburb</td>
                            <td>Where the crash occurred</td>
                        </tr>
                        <tr>
                            <td><strong>Severity</strong></td>
                            <td>Crash Severity, Casualties, Fatalities</td>
                            <td>Impact and outcomes</td>
                        </tr>
                        <tr>
                            <td><strong>Crash Characteristics</strong></td>
                            <td>Crash Type, Weather, Road Surface</td>
                            <td>Conditions and type of crash</td>
                        </tr>
                        <tr>
                            <td><strong>Vehicles & Units</strong></td>
                            <td>Vehicle Type, Heavy Vehicle, Unit Count</td>
                            <td>Vehicles involved in crash</td>
                        </tr>
                        <tr>
                            <td><strong>Casualties</strong></td>
                            <td>Road User Type, Age, Sex, Injury Extent</td>
                            <td>People affected by crash</td>
                        </tr>
                        <tr>
                            <td><strong>Contributing Factors</strong></td>
                            <td>DUI, Drugs, Speed, Seat Belt</td>
                            <td>Factors related to crash occurrence</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="info-modal-section">
                <h2>Visualization Processing</h2>

                <h3>Marker Clustering</h3>
                <ul>
                    <li>Individual crash points clustered using Leaflet MarkerCluster library</li>
                    <li>Clustering performed client-side for responsive interaction</li>
                    <li>Cluster size indicates number of crashes in geographic proximity</li>
                </ul>

                <h3>Density Map Visualization</h3>
                <ul>
                    <li>Point density layer generated using Leaflet.heat library with tight radius settings</li>
                    <li>Individual crashes rendered with minimal blur for precise location visualization</li>
                    <li>Color intensity represents both crash density and severity weighting</li>
                    <li>Severity-weighted: Fatal (4x), Serious Injury (3x), Minor Injury (2x), PDO (1x)</li>
                    <li>Radius and blur scale with zoom level for optimal viewing at all scales</li>
                    <li>Follows road patterns naturally, creating linear density corridors</li>
                </ul>

                <h3>Choropleth Mapping</h3>
                <ul>
                    <li>LGA (Local Government Area) boundaries used for choropleth visualization</li>
                    <li>Crash counts aggregated by geographic region</li>
                    <li>Color intensity proportional to crash frequency</li>
                </ul>
            </div>

            <div class="info-modal-section">
                <h2>Filtering & Aggregation</h2>
                <p>The website provides extensive filtering capabilities. All filters are applied client-side:</p>
                <ul>
                    <li><strong>Temporal Filters:</strong> Year range, date range, time of day</li>
                    <li><strong>Severity Filters:</strong> Crash severity levels, injury extent</li>
                    <li><strong>Geographic Filters:</strong> LGA/area, location search with radius</li>
                    <li><strong>Condition Filters:</strong> Weather, road surface, day/night</li>
                    <li><strong>Vehicle Filters:</strong> Vehicle type, heavy vehicle involvement</li>
                    <li><strong>Casualty Filters:</strong> Age group, road user type, safety equipment usage</li>
                </ul>
                <p>Statistics are recalculated dynamically based on active filters to show relevant totals and counts.</p>
            </div>

            <div class="info-modal-section">
                <h2>Data Integrity & Quality Assurance</h2>

                <h3>Validation Checks</h3>
                <ul>
                    <li>Record count verification against source datasets</li>
                    <li>Coordinate validity checks (within South Australia bounds)</li>
                    <li>Date and time range validation</li>
                    <li>Categorical value consistency checks</li>
                </ul>

                <h3>Known Limitations</h3>
                <ul>
                    <li>Some records may have incomplete data fields</li>
                    <li>Geographic coordinates are approximate and may not reflect exact crash locations</li>
                    <li>Data is dependent on reporting accuracy and completeness in source datasets</li>
                    <li>Historical data may have different collection or reporting standards than recent data</li>
                    <li>Not all crashes may be represented in the dataset</li>
                </ul>
            </div>

            <div class="info-modal-section">
                <h2>Tools & Technologies</h2>
                <p>The following tools and libraries were used in data processing and visualization:</p>
                <ul>
                    <li><strong>Python:</strong> Data cleaning and consolidation (pandas, csv libraries)</li>
                    <li><strong>Leaflet.js:</strong> Interactive mapping library</li>
                    <li><strong>Proj4js:</strong> Coordinate system transformation</li>
                    <li><strong>PapaParse:</strong> CSV parsing in browser</li>
                    <li><strong>Turf.js:</strong> Geospatial analysis and calculations</li>
                    <li><strong>noUiSlider:</strong> Range filter controls</li>
                </ul>
            </div>

            <div class="info-modal-section">
                <h2>Updates & Versioning</h2>
                <p>As new data becomes available from Data SA, the dataset may be updated. Major updates will be documented here with version information and change notes.</p>
                <p><strong>Current Version:</strong> 2012-2024 Dataset (February 2026)</p>
            </div>

            <div class="info-modal-section">
                <h2>Reproducibility & Transparency</h2>
                <p>This project aims to maintain transparency in data processing. Users who wish to verify the processing methodology or reproduce the dataset can:</p>
                <ul>
                    <li>Access the original source data from Data SA</li>
                    <li>Review the processing scripts (available in project repository if open-sourced)</li>
                    <li>Contact the project maintainer with questions or concerns</li>
                </ul>
                <p style="font-style: italic; color: var(--text-secondary); margin-top: 15px;">Last Updated: February 2026</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="page-footer">
        <div class="footer-links">
            <a href="#" onclick="openInfoModal('disclaimerModal'); return false;">Disclaimer</a>
            <a href="#" onclick="openInfoModal('methodologyModal'); return false;">Data Methodology</a>
            <a href="LICENSE" target="_blank">MIT License</a>
        </div>
        <div class="footer-attribution">
            Data: <a href="https://data.sa.gov.au" target="_blank" rel="noopener noreferrer">Data SA</a> |
            &copy; 2026 SA Crash Data Map
        </div>
    </footer>

    <script>
        // Info modal functions
        function openInfoModal(modalId) {
            document.getElementById(modalId).classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeInfoModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('info-modal')) {
                closeInfoModal(event.target.id);
            }
        });

        // Close modal with Escape key
        window.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                document.querySelectorAll('.info-modal.show').forEach(modal => {
                    closeInfoModal(modal.id);
                });
            }
        });

        // Checkbox filter functions
        function selectAllCheckboxes(groupName) {
            const checkboxes = document.querySelectorAll(`#${groupName}Checkboxes input[type="checkbox"]`);
            checkboxes.forEach(cb => {
                cb.checked = true;
            });
        }

        function clearAllCheckboxes(groupName) {
            const checkboxes = document.querySelectorAll(`#${groupName}Checkboxes input[type="checkbox"]`);
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
        }

        // Checkbox dropdown functions
        function toggleCheckboxDropdown(dropdownId) {
            const menu = document.getElementById(`${dropdownId}Menu`);
            const trigger = menu.previousElementSibling;
            const arrow = trigger.querySelector('.dropdown-arrow');

            // Close all other dropdowns
            document.querySelectorAll('.checkbox-dropdown-menu').forEach(m => {
                if (m !== menu && m.style.display === 'block') {
                    m.style.display = 'none';
                    const otherArrow = m.previousElementSibling.querySelector('.dropdown-arrow');
                    if (otherArrow) otherArrow.style.transform = 'rotate(0deg)';
                }
            });

            // Toggle current dropdown
            if (menu.style.display === 'block') {
                menu.style.display = 'none';
                arrow.style.transform = 'rotate(0deg)';
            } else {
                menu.style.display = 'block';
                arrow.style.transform = 'rotate(180deg)';
            }
        }

        function updateCheckboxDropdownDisplay(dropdownId) {
            const menu = document.getElementById(`${dropdownId}Menu`);
            const display = document.getElementById(`${dropdownId}Display`);
            const checkboxes = menu.querySelectorAll('input[type="checkbox"]:checked');

            if (checkboxes.length === 0 || checkboxes.length === menu.querySelectorAll('input[type="checkbox"]').length) {
                if (dropdownId === 'crashType') {
                    display.textContent = 'All Types';
                } else if (dropdownId === 'area') {
                    display.textContent = 'All Areas';
                } else if (dropdownId === 'severity') {
                    display.textContent = 'All Severities';
                }
            } else if (checkboxes.length === 1) {
                display.textContent = checkboxes[0].nextElementSibling.textContent;
            } else {
                display.textContent = `${checkboxes.length} selected`;
            }
        }

        function selectAllDropdownItems(dropdownId) {
            const menu = document.getElementById(`${dropdownId}Menu`);
            const checkboxes = menu.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = true;
            });
            updateCheckboxDropdownDisplay(dropdownId);
        }

        function clearAllDropdownItems(dropdownId) {
            const menu = document.getElementById(`${dropdownId}Menu`);
            const checkboxes = menu.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            updateCheckboxDropdownDisplay(dropdownId);
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.checkbox-dropdown')) {
                document.querySelectorAll('.checkbox-dropdown-menu').forEach(menu => {
                    if (menu.style.display === 'block') {
                        menu.style.display = 'none';
                        const arrow = menu.previousElementSibling.querySelector('.dropdown-arrow');
                        if (arrow) arrow.style.transform = 'rotate(0deg)';
                    }
                });
            }
        });

        // Placeholder for updateResultCount (can be implemented in app.js if needed)
        function updateResultCount() {
            // This can be implemented in app.js when crash data is loaded
        }

        // Analytics panel toggle
        function toggleAnalyticsPanel() {
            const panel = document.getElementById('analyticsPanel');
            panel.classList.toggle('collapsed');
        }

        // Chart instances
        let charts = {
            crashesOverTime: null,
            crashesByDay: null,
            crashesByHour: null,
            severityDistribution: null
        };

        // Initialize charts (placeholder - will be populated with real data from app.js)
        function initializeCharts() {
            const chartOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            };

            // Crashes Over Time
            const ctxTime = document.getElementById('crashesOverTimeChart');
            if (ctxTime) {
                charts.crashesOverTime = new Chart(ctxTime, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Crashes',
                            data: [],
                            borderColor: '#4a90e2',
                            backgroundColor: 'rgba(74, 144, 226, 0.1)',
                            tension: 0.4,
                            fill: true
                        }]
                    },
                    options: chartOptions
                });
            }

            // Crashes by Day
            const ctxDay = document.getElementById('crashesByDayChart');
            if (ctxDay) {
                charts.crashesByDay = new Chart(ctxDay, {
                    type: 'bar',
                    data: {
                        labels: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                        datasets: [{
                            label: 'Crashes',
                            data: [0, 0, 0, 0, 0, 0, 0],
                            backgroundColor: '#4a90e2'
                        }]
                    },
                    options: chartOptions
                });
            }

            // Crashes by Hour
            const ctxHour = document.getElementById('crashesByHourChart');
            if (ctxHour) {
                charts.crashesByHour = new Chart(ctxHour, {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: 24}, (_, i) => i + ':00'),
                        datasets: [{
                            label: 'Crashes',
                            data: Array(24).fill(0),
                            backgroundColor: '#4a90e2'
                        }]
                    },
                    options: chartOptions
                });
            }

            // Severity Distribution
            const ctxSeverity = document.getElementById('severityDistributionChart');
            if (ctxSeverity) {
                charts.severityDistribution = new Chart(ctxSeverity, {
                    type: 'doughnut',
                    data: {
                        labels: ['PDO', 'Minor Injury', 'Serious Injury', 'Fatal'],
                        datasets: [{
                            data: [0, 0, 0, 0],
                            backgroundColor: ['#90caf9', '#ffa726', '#ef5350', '#ab47bc']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                position: 'bottom'
                            }
                        }
                    }
                });
            }
        }

        // Initialize charts when page loads
        window.addEventListener('load', function() {
            if (typeof Chart !== 'undefined') {
                initializeCharts();
            }
        });

        // Update charts with filtered data (to be called from app.js)
        function updateChartsWithData(crashData) {
            if (!crashData || crashData.length === 0) return;

            // Crashes Over Time
            const monthCounts = {};
            crashData.forEach(crash => {
                const crashDateTime = crash['Crash Date Time'];
                if (crashDateTime) {
                    const parts = crashDateTime.split(' ');
                    if (parts[0]) {
                        const dateParts = parts[0].split('/');
                        if (dateParts.length === 3) {
                            const day = dateParts[0];
                            const month = dateParts[1];
                            const year = dateParts[2];
                            const monthKey = `${year}-${month}`;
                            monthCounts[monthKey] = (monthCounts[monthKey] || 0) + 1;
                        }
                    }
                }
            });
            const sortedMonths = Object.keys(monthCounts).sort();
            if (charts.crashesOverTime && sortedMonths.length > 0) {
                charts.crashesOverTime.data.labels = sortedMonths;
                charts.crashesOverTime.data.datasets[0].data = sortedMonths.map(m => monthCounts[m]);
                charts.crashesOverTime.update();
            }

            // Crashes by Day of Week
            const dayCounts = [0, 0, 0, 0, 0, 0, 0];
            crashData.forEach(crash => {
                const crashDateTime = crash['Crash Date Time'];
                if (crashDateTime) {
                    const parts = crashDateTime.split(' ');
                    if (parts[0]) {
                        const dateParts = parts[0].split('/');
                        if (dateParts.length === 3) {
                            // Format: DD/MM/YYYY
                            const day = parseInt(dateParts[0]);
                            const month = parseInt(dateParts[1]) - 1;
                            const year = parseInt(dateParts[2]);
                            const date = new Date(year, month, day);
                            const dayOfWeek = date.getDay();
                            dayCounts[dayOfWeek]++;
                        }
                    }
                }
            });
            if (charts.crashesByDay) {
                charts.crashesByDay.data.datasets[0].data = dayCounts;
                charts.crashesByDay.update();
            }

            // Crashes by Hour
            const hourCounts = Array(24).fill(0);
            crashData.forEach(crash => {
                const crashDateTime = crash['Crash Date Time'];
                if (crashDateTime) {
                    const parts = crashDateTime.split(' ');
                    if (parts[1]) {
                        const timeParts = parts[1].split(':');
                        const hour = parseInt(timeParts[0]);
                        if (!isNaN(hour) && hour >= 0 && hour < 24) {
                            hourCounts[hour]++;
                        }
                    }
                }
            });
            if (charts.crashesByHour) {
                charts.crashesByHour.data.datasets[0].data = hourCounts;
                charts.crashesByHour.update();
            }

            // Severity Distribution
            const severityCounts = {
                'PDO': 0,
                'Minor': 0,
                'Serious': 0,
                'Fatal': 0
            };
            crashData.forEach(crash => {
                const severity = crash['Crash Severity'] || crash['CSEF Severity'] || '';
                if (severity.includes('PDO') || severity.includes('1:')) severityCounts.PDO++;
                else if (severity.includes('MI') || severity.includes('2:')) severityCounts.Minor++;
                else if (severity.includes('SI') || severity.includes('3:')) severityCounts.Serious++;
                else if (severity.includes('Fatal') || severity.includes('4:')) severityCounts.Fatal++;
            });
            if (charts.severityDistribution) {
                charts.severityDistribution.data.datasets[0].data = [
                    severityCounts.PDO,
                    severityCounts.Minor,
                    severityCounts.Serious,
                    severityCounts.Fatal
                ];
                charts.severityDistribution.update();
            }
        }

        // Make functions available globally for app.js
        window.updateChartsWithData = updateChartsWithData;
        window.updateResultCount = updateResultCount;
    </script>
</body>
</html>
