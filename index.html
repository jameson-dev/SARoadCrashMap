<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="theme-color" content="#4a90e2">
    <title>SA Crash Data Map 2012-2024</title>

    <!-- Web App Manifest -->
    <link rel="manifest" href="manifest.json">

    <!-- Icons -->
    <link rel="icon" type="image/svg+xml" href="saroadcrashmap-icon.svg">
    <link rel="apple-touch-icon" href="saroadcrashmap-icon.svg">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <!-- Leaflet MarkerCluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />

    <!-- noUiSlider CSS -->
    <link rel="stylesheet" href="https://unpkg.com/nouislider@15.7.1/dist/nouislider.min.css">

    <!-- Custom Styles -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- First Visit Disclaimer Acknowledgment -->
    <div id="firstVisitOverlay" class="first-visit-overlay" style="display: none;">
        <div class="first-visit-popup">
            <h2>Welcome to SA Crash Data Map</h2>
            <p>Before using this application, please acknowledge that you have read and understood the disclaimer.</p>
            <p>This tool provides crash data visualization for educational and informational purposes only.</p>
            <div class="first-visit-actions">
                <a href="#" onclick="openInfoModal('disclaimerModal'); return false;" class="view-disclaimer-link">View Full Disclaimer</a>
                <button onclick="acknowledgeDisclaimer()" class="acknowledge-btn">I Acknowledge</button>
            </div>
        </div>
    </div>

    <div id="map"></div>

    <button class="toggle-panel-btn" onclick="togglePanel()">‚ò∞ Filters</button>

    <!-- Active Filters Badge -->
    <div class="active-filters-bar" id="activeFiltersBar">
        <div class="active-filters-bar-header">
            <span class="active-filters-bar-title">üîç No filters</span>
        </div>
        <div class="active-filters-bar-content" id="activeFiltersContent">
            <div class="no-active-filters">Hover to see filter details</div>
        </div>
    </div>

    <div class="controls-panel" id="controlsPanel">
        <div class="panel-header">
            <span>Explorer</span>
            <div class="flex-gap-small">
                <button class="theme-toggle-btn" onclick="toggleTheme()" title="Toggle Light/Dark Mode">
                    <span id="themeIcon">‚òÄÔ∏è</span>
                </button>
                <button class="collapse-btn" onclick="togglePanelCollapse()" title="Collapse/Expand">
                    <span id="collapseIcon">‚ñ≤</span>
                </button>
            </div>
        </div>

        <div class="panel-content">
        <!-- Location Search - Collapsible -->
        <div class="filter-group section-divider">
            <div class="location-search-header" onclick="toggleLocationSearch()">
                <span class="header-text">üîç Search by Location</span>
                <span class="toggle-icon">‚ñº</span>
            </div>

            <div class="location-search-content" id="locationSearchContent">
                <div class="location-search-inner">
                    <input type="text" id="locationSearch" placeholder="Enter suburb, street, or landmark..."
                        autocomplete="off"
                        oninput="handleLocationInput(this.value)"
                        onkeydown="handleLocationKeydown(event)"
                        class="location-search-input">

                    <!-- Suggestions dropdown -->
                    <div class="location-suggestions" id="locationSuggestions"></div>

                    <div class="radius-container">
                        <label class="radius-label">Radius:</label>
                        <select id="searchRadius" class="radius-select">
                            <option value="0.5">0.5 km</option>
                            <option value="1">1 km</option>
                            <option value="2" selected>2 km</option>
                            <option value="3">3 km</option>
                            <option value="5">5 km</option>
                            <option value="7">7 km</option>
                            <option value="10">10 km</option>
                            <option value="15">15 km</option>
                            <option value="20">20 km</option>
                            <option value="25">25 km</option>
                            <option value="50">50 km</option>
                        </select>
                    </div>

                    <div class="button-row">
                        <button onclick="searchByLocation()" class="apply-filters-btn button-row-item">Search</button>
                        <button onclick="clearLocationSearch()" class="clear-filters-btn button-row-item">Clear</button>
                    </div>

                    <div id="searchResults" class="search-results-box hidden"></div>
                </div>
            </div>
        </div>

        <!-- Basic Filters Group -->
        <div class="basic-filters-group">
            <div class="filter-group">
                <label class="filter-label">Year Range: <span id="yearRangeDisplay">2012 - 2024</span></label>
                <div id="yearRangeSlider" class="year-range-slider-container"></div>
            </div>

            <div class="filter-group">
                <label class="filter-label">Crash Severity</label>
                <div class="checkbox-dropdown" id="severityDropdown">
                    <div class="checkbox-dropdown-trigger" onclick="toggleCheckboxDropdown('severity')">
                        <span id="severityDisplay">All Severities</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </div>
                    <div class="checkbox-dropdown-menu" id="severityMenu">
                        <div class="dropdown-search-wrap">
                            <input type="text" class="dropdown-search" placeholder="Search..." oninput="filterDropdownItems('severity', this.value)">
                        </div>
                        <div class="dropdown-items-list" id="severityItemsList">
                            <div class="checkbox-dropdown-item">
                                <input type="checkbox" id="severity-pdo" value="1: PDO" checked onchange="updateCheckboxDropdownDisplay('severity')">
                                <label for="severity-pdo">PDO (Property Damage Only)</label>
                            </div>
                            <div class="checkbox-dropdown-item">
                                <input type="checkbox" id="severity-mi" value="2: MI" checked onchange="updateCheckboxDropdownDisplay('severity')">
                                <label for="severity-mi">Minor Injury</label>
                            </div>
                            <div class="checkbox-dropdown-item">
                                <input type="checkbox" id="severity-si" value="3: SI" checked onchange="updateCheckboxDropdownDisplay('severity')">
                                <label for="severity-si">Serious Injury</label>
                            </div>
                            <div class="checkbox-dropdown-item">
                                <input type="checkbox" id="severity-fatal" value="4: Fatal" checked onchange="updateCheckboxDropdownDisplay('severity')">
                                <label for="severity-fatal">Fatal</label>
                            </div>
                        </div>
                        <div class="checkbox-dropdown-controls">
                            <button class="checkbox-select-all" onclick="selectAllDropdownItems('severity')">Select All</button>
                            <button class="checkbox-clear-all" onclick="clearAllDropdownItems('severity')">Clear All</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label class="filter-label">Crash Type</label>
                <div class="checkbox-dropdown" id="crashTypeDropdown">
                    <div class="checkbox-dropdown-trigger" onclick="toggleCheckboxDropdown('crashType')">
                        <span id="crashTypeDisplay">All Types</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </div>
                    <div class="checkbox-dropdown-menu" id="crashTypeMenu">
                        <!-- Options will be populated by app.js -->
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label class="filter-label">Area</label>
                <div class="checkbox-dropdown" id="areaDropdown">
                    <div class="checkbox-dropdown-trigger" onclick="toggleCheckboxDropdown('area')">
                        <span id="areaDisplay">All Areas</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </div>
                    <div class="checkbox-dropdown-menu" id="areaMenu">
                        <!-- Options will be populated by app.js -->
                    </div>
                </div>
            </div>

            <div class="filter-group">
                <label class="filter-label">Suburb</label>
                <div class="checkbox-dropdown" id="suburbDropdown">
                    <div class="checkbox-dropdown-trigger" onclick="toggleCheckboxDropdown('suburb')">
                        <span id="suburbDisplay">All Suburbs</span>
                        <span class="dropdown-arrow">‚ñº</span>
                    </div>
                    <div class="checkbox-dropdown-menu" id="suburbMenu">
                        <!-- Options will be populated by app.js -->
                    </div>
                </div>
            </div>

            <button class="advanced-filters-btn" onclick="openAdvancedFilters()">
                üîß Advanced Filters
                <span id="advancedFilterBadge" class="filter-badge hidden">0</span>
            </button>
        </div>

        <button class="apply-filters-btn" id="applyFilters" onclick="applyFilters()">Apply Filters</button>

        <button class="clear-filters-btn" onclick="clearFilters()">Clear Filters</button>

        <button onclick="shareCurrentView()" class="share-view-btn">
            üîó Share Current View
        </button>

        <div class="layer-controls">
            <div class="filter-label map-layers-label">Map Layers</div>
            <div class="layer-toggle active" id="markersToggle" onclick="toggleLayer('markers')">
                <span>üéØ Markers</span>
                <span id="markersStatus">ON</span>
            </div>
            <div class="layer-toggle" id="densityToggle" onclick="toggleLayer('density')">
                <div class="layer-label-container">
                    <span>üí† Point Density</span>
                    <div class="layer-info-icon" onclick="event.stopPropagation()">
                        ‚ìò
                        <div class="layer-info-tooltip">
                            Best viewed on <strong>Dark</strong> basemap
                        </div>
                    </div>
                </div>
                <span id="densityStatus">OFF</span>
            </div>
            <div class="layer-toggle" id="choroplethToggle">
                <div class="layer-label-container layer-label-flex" onclick="toggleLayer('choropleth')">
                    <span>üó∫Ô∏è Choropleth</span>
                </div>
                <div class="choropleth-mode-pill">
                    <button id="choroplethModeLGA" class="choropleth-mode-btn active" onclick="switchChoroplethMode('lga')">LGA</button>
                    <button id="choroplethModeSuburb" class="choropleth-mode-btn" onclick="switchChoroplethMode('suburb')" disabled title="Loading suburb boundaries...">Suburb</button>
                </div>
                <span id="choroplethStatus" onclick="toggleLayer('choropleth')">OFF</span>
            </div>
        </div>

        <div class="stats-panel">
            <h3>Statistics</h3>
            <div class="stat-item">
                <span>Total Crashes:</span>
                <span class="stat-value" id="totalCrashes">0</span>
            </div>
            <div class="stat-item">
                <span>Fatalities:</span>
                <span class="stat-value" id="totalFatalities">0</span>
            </div>
            <div class="stat-item">
                <span>Serious Injuries:</span>
                <span class="stat-value" id="totalSerious">0</span>
            </div>
            <div class="stat-item">
                <span>Minor Injuries:</span>
                <span class="stat-value" id="totalMinor">0</span>
            </div>
            <button class="export-btn" onclick="exportFilteredData()" title="Export filtered crash data to CSV">
                Export to CSV
            </button>
        </div>
        </div><!-- End panel-content -->
    </div>

    <!-- Advanced Filters Modal -->
    <div id="advancedFiltersModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Advanced Filters</h2>
                <button class="modal-close" onclick="closeAdvancedFilters()">&times;</button>
            </div>

            <div class="modal-tabs">
                <button class="tab-btn active" onclick="switchTab('conditions')">Crash Conditions</button>
                <button class="tab-btn" onclick="switchTab('casualties')">Casualties</button>
                <button class="tab-btn" onclick="switchTab('vehicles')">Vehicles & Units</button>
            </div>

            <div class="modal-body">
                <!-- Crash Conditions Tab -->
                <div id="conditionsTab" class="tab-content active">
                    <div class="filter-group">
                        <label class="filter-label">Weather Condition</label>
                        <select id="weather">
                            <option value="all" selected>All Weather</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Day/Night</label>
                        <select id="dayNight">
                            <option value="all" selected>All</option>
                            <option value="Day">Day</option>
                            <option value="Night">Night</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Time of Day (Optional)</label>
                        <div class="time-range-container">
                            <div class="time-range-field">
                                <label class="time-range-label">From:</label>
                                <input type="time" id="timeFrom">
                            </div>
                            <div class="time-range-field">
                                <label class="time-range-label">To:</label>
                                <input type="time" id="timeTo">
                            </div>
                        </div>
                        <div class="help-text-small">Leave empty for all times</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Date Range (Optional)</label>
                        <div class="time-range-container">
                            <div class="time-range-field">
                                <label class="time-range-label">From:</label>
                                <input type="date" id="dateFrom">
                            </div>
                            <div class="time-range-field">
                                <label class="time-range-label">To:</label>
                                <input type="date" id="dateTo">
                            </div>
                        </div>
                        <div class="help-text-small">Leave empty to use year range only</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">DUI Involved</label>
                        <select id="duiInvolved">
                            <option value="all" selected>All</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Road Surface</label>
                        <select id="roadSurface" multiple size="4">
                            <option value="all" selected>All Surfaces</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Moisture Condition</label>
                        <select id="moistureCond" multiple size="4">
                            <option value="all" selected>All Conditions</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Drugs Involved</label>
                        <select id="drugsInvolved">
                            <option value="all" selected>All</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>
                </div>

                <!-- Casualties Tab -->
                <div id="casualtiesTab" class="tab-content">
                    <div class="filter-group">
                        <label class="filter-label">Road User Type</label>
                        <select id="roadUserType" multiple size="4">
                            <option value="all" selected>All Road Users</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Age Group</label>
                        <select id="ageGroup" multiple size="4">
                            <option value="all" selected>All Ages</option>
                            <option value="0-17">0-17 (Youth)</option>
                            <option value="18-25">18-25 (Young Adult)</option>
                            <option value="26-35">26-35</option>
                            <option value="36-50">36-50</option>
                            <option value="51-65">51-65</option>
                            <option value="66+">66+ (Senior)</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Casualty Sex</label>
                        <select id="casualtySex" multiple size="3">
                            <option value="all" selected>All</option>
                            <option value="Male">Male</option>
                            <option value="Female">Female</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Injury Extent</label>
                        <select id="injuryExtent" multiple size="4">
                            <option value="all" selected>All Injuries</option>
                            <option value="Fatal">Fatal</option>
                            <option value="Serious injury">Serious Injury</option>
                            <option value="Minor injury">Minor Injury</option>
                            <option value="Not injured">Not Injured</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Seat Belt Usage</label>
                        <select id="seatBelt" multiple size="3">
                            <option value="all" selected>All</option>
                            <option value="Yes">Worn</option>
                            <option value="No">Not Worn</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Helmet Usage</label>
                        <select id="helmet" multiple size="3">
                            <option value="all" selected>All</option>
                            <option value="Worn">Worn</option>
                            <option value="Not Worn">Not Worn</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>
                </div>

                <!-- Vehicles & Units Tab -->
                <div id="vehiclesTab" class="tab-content">
                    <div class="filter-group">
                        <label class="filter-label">Heavy Vehicle Involved</label>
                        <select id="heavyVehicle">
                            <option value="all" selected>All Vehicles</option>
                            <option value="yes">Heavy Vehicles Only</option>
                            <option value="no">No Heavy Vehicles</option>
                        </select>
                        <div class="help-text-small">
                            Heavy vehicles: Trucks (‚â•4.5T), Semi-trailers, B-doubles, Road trains, Buses
                        </div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Involved Entities</label>
                        <select id="vehicleType" multiple size="4">
                            <option value="all" selected>All Entities</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Vehicle Year</label>
                        <select id="vehicleYear" multiple size="4">
                            <option value="all" selected>All Years</option>
                            <option value="pre-2000">Before 2000</option>
                            <option value="2000-2010">2000-2010</option>
                            <option value="2011-2020">2011-2020</option>
                            <option value="2021+">2021 or Newer</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Number of Occupants</label>
                        <select id="occupants" multiple size="5">
                            <option value="all" selected>All</option>
                            <option value="1">1 Occupant</option>
                            <option value="2">2 Occupants</option>
                            <option value="3">3 Occupants</option>
                            <option value="4">4 Occupants</option>
                            <option value="5+">5+ Occupants</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Towing</label>
                        <select id="towing">
                            <option value="all" selected>All</option>
                            <option value="Yes">Towing</option>
                            <option value="No">Not Towing</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Rollover Involved</label>
                        <select id="rollover">
                            <option value="all" selected>All</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Fire Involved</label>
                        <select id="fire">
                            <option value="all" selected>All</option>
                            <option value="Yes">Yes</option>
                            <option value="No">No</option>
                        </select>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">License Type</label>
                        <select id="licenseType" multiple size="4">
                            <option value="all" selected>All License Types</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Vehicle Reg State</label>
                        <select id="vehRegState" multiple size="4">
                            <option value="all" selected>All States</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Direction of Travel</label>
                        <select id="directionTravel" multiple size="4">
                            <option value="all" selected>All Directions</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>

                    <div class="filter-group">
                        <label class="filter-label">Unit Movement</label>
                        <select id="unitMovement" multiple size="4">
                            <option value="all" selected>All Movements</option>
                        </select>
                        <div class="multi-select-hint">Hold Ctrl (or Cmd) to select multiple</div>
                    </div>
                </div>
            </div>

            <div class="modal-footer">
                <button class="modal-apply-btn" onclick="applyAdvancedFilters()">Apply Filters</button>
                <button class="modal-cancel-btn" onclick="closeAdvancedFilters()">Cancel</button>
            </div>
        </div>
    </div>

    <div class="loading" id="loading">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div>Loading crash data...</div>
        </div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Leaflet MarkerCluster -->
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

    <!-- Leaflet Heat (for Density Map) -->
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>

    <!-- noUiSlider JS -->
    <script src="https://unpkg.com/nouislider@15.7.1/dist/nouislider.min.js"></script>

    <!-- PapaParse for CSV -->
    <script src="https://unpkg.com/papaparse@5.4.1/papaparse.min.js"></script>

    <!-- Proj4js for coordinate conversion -->
    <script src="https://unpkg.com/proj4@2.9.0/dist/proj4.js"></script>

    <!-- Turf.js for geospatial operations (point-in-polygon) -->
    <script src="https://unpkg.com/@turf/turf@6.5.0/turf.min.js"></script>

    <!-- Chart.js for analytics -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <!-- Service Worker Registration -->
    <script src="sw-register.js"></script>

    <!-- Main Application -->
    <script src="app.js"></script>

    <!-- Analytics Panel -->
    <div class="analytics-panel collapsed" id="analyticsPanel">
        <div class="analytics-header" onclick="toggleAnalyticsPanel()">
            <h3>üìä Analytics Dashboard</h3>
            <span class="analytics-toggle">‚ñº</span>
            <button class="analytics-close-btn" onclick="closeAnalyticsPanel(event)" title="Close">‚úï</button>
        </div>
        <div class="analytics-content">
            <div class="chart-container">
                <div class="chart-header">
                    <h4>Crashes Over Time</h4>
                    <div class="chart-header-right">
                        <div class="chart-toggle-btns">
                            <button id="btnYearly" class="chart-toggle-btn active" onclick="setOverTimeMode('yearly')">Yearly</button>
                            <button id="btnMonthly" class="chart-toggle-btn" onclick="setOverTimeMode('monthly')">Monthly</button>
                        </div>
                        <span class="chart-info-icon">i<span class="chart-info-tooltip">Total crashes per year or month. In Yearly mode, click a point to filter to that year. Toggle between Yearly and Monthly views using the buttons.</span></span>
                    </div>
                </div>
                <div id="yearFilterBanner" class="year-filter-banner" style="display:none">
                    <span><strong id="yearBannerLabel"></strong> only</span>
                    <button onclick="clearYearChip()">Remove Filter &times;</button>
                </div>
                <div class="chart-wrapper">
                    <canvas id="crashesOverTimeChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <h4>Crashes by Day of Week</h4>
                    <span class="chart-info-icon">i<span class="chart-info-tooltip">Total crashes for each day of the week. Orange bars highlight weekends (Sat &amp; Sun). The dashed line shows the daily average.</span></span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="crashesByDayChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <h4>Crashes by Hour</h4>
                    <span class="chart-info-icon">i<span class="chart-info-tooltip">Total crashes by hour of day (12am‚Äì11pm). Bars graduate from blue (fewer) to red (more). The dashed line shows the hourly average.</span></span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="crashesByHourChart"></canvas>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-header">
                    <h4>Severity Distribution</h4>
                    <span class="chart-info-icon">i<span class="chart-info-tooltip">Breakdown of crashes by severity. Click a segment to filter the map and graphs to that severity only. Click the same segment again to restore.</span></span>
                </div>
                <div class="chart-wrapper">
                    <canvas id="severityDistributionChart"></canvas>
                </div>
                <p class="chart-click-hint">Click a segment to filter by severity</p>
            </div>
        </div>
    </div>

    <!-- Disclaimer Modal -->
    <div id="disclaimerModal" class="info-modal">
        <div class="info-modal-header">
            <h1>Disclaimer</h1>
            <button class="info-modal-close" onclick="closeInfoModal('disclaimerModal')">Close</button>
        </div>
        <div class="info-modal-container">
            <div class="important-notice">
                <h3>‚ö†Ô∏è Important Notice</h3>
                <p><strong>This website is provided for informational and visualisation purposes only. It must not be relied upon for legal, insurance, regulatory, enforcement, property, safety, or emergency decision-making.</strong></p>
            </div>

            <div class="info-modal-section">
                <h2>Data Source</h2>
                <p>All crash data displayed on this website is sourced from publicly available datasets published by <strong>Data SA</strong> (Government of South Australia).</p>
                <p>The original datasets can be accessed at: <a href="https://data.sa.gov.au" target="_blank" rel="noopener noreferrer">data.sa.gov.au</a></p>
            </div>

            <div class="info-modal-section">
                <h2>Data Processing</h2>
                <p>The datasets have been cleaned and standardised across yearly releases (2012‚Äì2024) to ensure consistent formatting and comparability. No material alterations have been made to the original published records beyond necessary formatting and structural adjustments.</p>
            </div>

            <div class="info-modal-section">
                <h2>Accuracy & Limitations</h2>
                <p>While reasonable care has been taken to ensure accurate representation of the source data, <strong>no guarantee is provided</strong> regarding the completeness, accuracy, reliability, or timeliness of the information displayed.</p>
                <p>Users should verify information against official government sources where required. The data may contain errors, omissions, or outdated information.</p>
                <p>Geographic coordinates and location information may be approximate and should not be considered precise.</p>
            </div>

            <div class="info-modal-section">
                <h2>Informational Use Only</h2>
                <p>This website is provided for <strong>informational and visualisation purposes only</strong>. The information presented here must not be relied upon for:</p>
                <ul>
                    <li>Legal proceedings or decisions</li>
                    <li>Insurance claims or assessments</li>
                    <li>Regulatory compliance or reporting</li>
                    <li>Law enforcement activities</li>
                    <li>Property valuations or real estate decisions</li>
                    <li>Safety assessments or emergency planning</li>
                    <li>Any other critical or official purpose</li>
                </ul>
                <p>For official information, please consult the relevant South Australian Government agencies and authorities.</p>
            </div>

            <div class="info-modal-section">
                <h2>No Government Affiliation</h2>
                <p>This is an <strong>independent project</strong> and is not affiliated with, endorsed by, or representing the Government of South Australia, Data SA, or any other government agency.</p>
                <p>This website is not an official government resource. All official inquiries should be directed to the appropriate South Australian Government departments.</p>
            </div>

            <div class="info-modal-section">
                <h2>Privacy & Data Protection</h2>
                <p>This website only displays aggregated crash statistics from publicly available datasets. No personal information or identifiable data about individuals involved in crashes is displayed or stored.</p>
                <p>The website does not collect personal information from users beyond standard web server logs.</p>
            </div>

            <div class="info-modal-section">
                <h2>Limitation of Liability</h2>
                <p><strong>Use of this website is at your own risk.</strong> The site owner, contributors, and data providers accept no liability for any loss, damage, injury, or consequences arising directly or indirectly from:</p>
                <ul>
                    <li>The use of this website or its content</li>
                    <li>Reliance on information displayed on this website</li>
                    <li>Errors, omissions, or inaccuracies in the data</li>
                    <li>Unavailability or interruption of service</li>
                    <li>Any decisions made based on information from this website</li>
                </ul>
                <p>To the maximum extent permitted by law, all warranties, express or implied, are excluded.</p>
            </div>

            <div class="info-modal-section">
                <h2>Third-Party Services</h2>
                <p>This website uses third-party services and libraries including Leaflet (mapping), OpenStreetMap (map tiles), and various JavaScript libraries. The site owner is not responsible for the availability, accuracy, or content provided by these third-party services.</p>
            </div>

            <div class="info-modal-section">
                <h2>Changes to This Disclaimer</h2>
                <p>This disclaimer may be updated from time to time without notice. Continued use of this website constitutes acceptance of any changes to this disclaimer.</p>
                <p class="last-updated-text">Last Updated: February 2026</p>
            </div>
        </div>
    </div>

    <!-- Methodology Modal -->
    <div id="methodologyModal" class="info-modal">
        <div class="info-modal-header">
            <h1>Data Processing Methodology</h1>
            <button class="info-modal-close" onclick="closeInfoModal('methodologyModal')">Close</button>
        </div>
        <div class="info-modal-container">
            <div class="info-modal-section">
                <h2>Overview</h2>
                <p>This page documents the data processing methodology used to prepare the South Australian crash data for visualization on this website. The goal is to provide transparency about how the raw data has been transformed and to help users understand any limitations or considerations when interpreting the visualizations.</p>
            </div>

            <div class="info-modal-section">
                <h2>Data Sources</h2>
                <p>All data is sourced from publicly available datasets published by <strong>Data SA</strong> (Government of South Australia):</p>
                <ul>
                    <li><strong>Primary Dataset:</strong> Road Crash Data (2012-2024)</li>
                    <li><strong>Source URL:</strong> <a href="https://data.sa.gov.au" target="_blank" rel="noopener noreferrer">data.sa.gov.au</a></li>
                    <li><strong>Data Format:</strong> CSV (Comma-Separated Values)</li>
                    <li><strong>Update Frequency:</strong> Periodically updated by Data SA</li>
                    <li><strong>Coverage Period:</strong> January 1, 2012 to December 31, 2024</li>
                </ul>
                <div class="info-box">
                    <strong>Note:</strong> The datasets are published by the South Australian Government under open data licensing terms. Please refer to Data SA for the most current and official data.
                </div>
            </div>

            <div class="info-modal-section">
                <h2>Data Processing Steps</h2>

                <h3>1. Data Collection & Consolidation</h3>
                <p>Yearly crash data files (2012-2024) were collected from Data SA and consolidated into a single unified dataset. This process involved:</p>
                <ul>
                    <li>Downloading individual yearly CSV files from Data SA</li>
                    <li>Merging multiple datasets while preserving all original records</li>
                    <li>Creating a combined dataset for efficient querying and visualization</li>
                </ul>

                <h3>2. Data Cleaning & Standardization</h3>
                <p>To ensure consistency across different yearly releases, the following standardization procedures were applied:</p>

                <h4>Column Name Standardization</h4>
                <ul>
                    <li>Inconsistent column names across years were normalized to a common schema</li>
                    <li>Whitespace and special characters in column headers were standardized</li>
                    <li>Column names were made case-consistent for reliable programmatic access</li>
                </ul>

                <h4>Data Type Validation</h4>
                <ul>
                    <li>Numeric fields (e.g., year, casualty counts) validated and converted to appropriate types</li>
                    <li>Date and time fields parsed and standardized to ISO 8601 format where applicable</li>
                    <li>Text fields trimmed of leading/trailing whitespace</li>
                </ul>

                <h4>Missing Data Handling</h4>
                <ul>
                    <li>Empty fields preserved as empty strings (not converted to null/undefined arbitrarily)</li>
                    <li>No imputation or artificial data generation performed</li>
                    <li>Missing geographic coordinates excluded from mapping visualizations</li>
                </ul>

                <h3>3. Geographic Coordinate Processing</h3>
                <p>The crash data includes geographic coordinates that enable map-based visualization:</p>
                <ul>
                    <li><strong>Coordinate System:</strong> Original data uses GDA2020 / MGA Zone 54 (EPSG:7854)</li>
                    <li><strong>Conversion:</strong> Coordinates converted to WGS84 (latitude/longitude) using Proj4js library for web mapping compatibility</li>
                    <li><strong>Validation:</strong> Records with missing or invalid coordinates excluded from map layers</li>
                    <li><strong>Precision:</strong> Coordinates displayed with standard precision; exact crash locations may be approximate</li>
                </ul>

                <div class="info-box">
                    <strong>Important:</strong> Geographic coordinates should be considered approximate. They are suitable for visualization and general analysis but not for precise location-based decisions.
                </div>

                <h3>4. Categorical Data Harmonization</h3>
                <p>Categorical fields (e.g., crash severity, weather conditions, crash type) were standardized:</p>
                <ul>
                    <li>Consistent encoding of categories across years</li>
                    <li>Removal of redundant or duplicate category labels</li>
                    <li>Preservation of original category meanings without reclassification</li>
                </ul>

                <h3>5. Temporal Data Processing</h3>
                <ul>
                    <li>Crash dates and times preserved in original form where available</li>
                    <li>Year extracted and validated for filtering purposes</li>
                    <li>Time-of-day filters support 24-hour format</li>
                </ul>
            </div>

            <div class="info-modal-section">
                <h2>Data Schema</h2>
                <p>The consolidated dataset includes the following key fields:</p>
                <table>
                    <thead>
                        <tr>
                            <th>Field Category</th>
                            <th>Example Fields</th>
                            <th>Description</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td><strong>Temporal</strong></td>
                            <td>Year, Date, Time, Day/Night</td>
                            <td>When the crash occurred</td>
                        </tr>
                        <tr>
                            <td><strong>Geographic</strong></td>
                            <td>Latitude, Longitude, Area/LGA, Suburb</td>
                            <td>Where the crash occurred</td>
                        </tr>
                        <tr>
                            <td><strong>Severity</strong></td>
                            <td>Crash Severity, Casualties, Fatalities</td>
                            <td>Impact and outcomes</td>
                        </tr>
                        <tr>
                            <td><strong>Crash Characteristics</strong></td>
                            <td>Crash Type, Weather, Road Surface</td>
                            <td>Conditions and type of crash</td>
                        </tr>
                        <tr>
                            <td><strong>Vehicles & Units</strong></td>
                            <td>Vehicle Type, Heavy Vehicle, Unit Count</td>
                            <td>Vehicles involved in crash</td>
                        </tr>
                        <tr>
                            <td><strong>Casualties</strong></td>
                            <td>Road User Type, Age, Sex, Injury Extent</td>
                            <td>People affected by crash</td>
                        </tr>
                        <tr>
                            <td><strong>Contributing Factors</strong></td>
                            <td>DUI, Drugs, Speed, Seat Belt</td>
                            <td>Factors related to crash occurrence</td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="info-modal-section">
                <h2>Visualization Processing</h2>

                <h3>Marker Clustering</h3>
                <ul>
                    <li>Individual crash points clustered using Leaflet MarkerCluster library</li>
                    <li>Clustering performed client-side for responsive interaction</li>
                    <li>Cluster size indicates number of crashes in geographic proximity</li>
                </ul>

                <h3>Density Map Visualization</h3>
                <ul>
                    <li>Point density layer generated using Leaflet.heat library with tight radius settings</li>
                    <li>Individual crashes rendered with minimal blur for precise location visualization</li>
                    <li>Color intensity represents both crash density and severity weighting</li>
                    <li>Severity-weighted: Fatal (4x), Serious Injury (3x), Minor Injury (2x), PDO (1x)</li>
                    <li>Radius and blur scale with zoom level for optimal viewing at all scales</li>
                    <li>Follows road patterns naturally, creating linear density corridors</li>
                </ul>

                <h3>Choropleth Mapping</h3>
                <ul>
                    <li>LGA (Local Government Area) boundaries used for choropleth visualization</li>
                    <li>Crash counts aggregated by geographic region</li>
                    <li>Color intensity proportional to crash frequency</li>
                </ul>
            </div>

            <div class="info-modal-section">
                <h2>Filtering & Aggregation</h2>
                <p>The website provides extensive filtering capabilities. All filters are applied client-side:</p>
                <ul>
                    <li><strong>Temporal Filters:</strong> Year range, date range, time of day</li>
                    <li><strong>Severity Filters:</strong> Crash severity levels, injury extent</li>
                    <li><strong>Geographic Filters:</strong> LGA/area, location search with radius</li>
                    <li><strong>Condition Filters:</strong> Weather, road surface, day/night</li>
                    <li><strong>Vehicle Filters:</strong> Vehicle type, heavy vehicle involvement</li>
                    <li><strong>Casualty Filters:</strong> Age group, road user type, safety equipment usage</li>
                </ul>
                <p>Statistics are recalculated dynamically based on active filters to show relevant totals and counts.</p>
            </div>

            <div class="info-modal-section">
                <h2>Data Integrity & Quality Assurance</h2>

                <h3>Validation Checks</h3>
                <ul>
                    <li>Record count verification against source datasets</li>
                    <li>Coordinate validity checks (within South Australia bounds)</li>
                    <li>Date and time range validation</li>
                    <li>Categorical value consistency checks</li>
                </ul>

                <h3>Known Limitations</h3>
                <ul>
                    <li>Some records may have incomplete data fields</li>
                    <li>Geographic coordinates are approximate and may not reflect exact crash locations</li>
                    <li>Data is dependent on reporting accuracy and completeness in source datasets</li>
                    <li>Historical data may have different collection or reporting standards than recent data</li>
                    <li>Not all crashes may be represented in the dataset</li>
                </ul>
            </div>

            <div class="info-modal-section">
                <h2>Tools & Technologies</h2>
                <p>The following tools and libraries were used in data processing and visualization:</p>
                <ul>
                    <li><strong>Python:</strong> Data cleaning and consolidation (pandas, csv libraries)</li>
                    <li><strong>Leaflet.js:</strong> Interactive mapping library</li>
                    <li><strong>Proj4js:</strong> Coordinate system transformation</li>
                    <li><strong>PapaParse:</strong> CSV parsing in browser</li>
                    <li><strong>Turf.js:</strong> Geospatial analysis and calculations</li>
                    <li><strong>noUiSlider:</strong> Range filter controls</li>
                </ul>
            </div>

            <div class="info-modal-section">
                <h2>Updates & Versioning</h2>
                <p>As new data becomes available from Data SA, the dataset may be updated. Major updates will be documented here with version information and change notes.</p>
                <p><strong>Current Version:</strong> 2012-2024 Dataset (February 2026)</p>
            </div>

            <div class="info-modal-section">
                <h2>Reproducibility & Transparency</h2>
                <p>This project aims to maintain transparency in data processing. Users who wish to verify the processing methodology or reproduce the dataset can:</p>
                <ul>
                    <li>Access the original source data from Data SA</li>
                    <li>Review the processing scripts (available in project repository if open-sourced)</li>
                    <li>Contact the project maintainer with questions or concerns</li>
                </ul>
                <p class="last-updated-text">Last Updated: February 2026</p>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="page-footer">
        <div class="footer-links">
            <a href="#" onclick="openInfoModal('disclaimerModal'); return false;">Disclaimer</a>
            <a href="#" onclick="openInfoModal('methodologyModal'); return false;">Data Methodology</a>
            <a href="LICENSE" target="_blank">MIT License</a>
        </div>
        <div class="footer-center">
            Developed by <a href="https://github.com/jameson-dev" target="_blank" rel="noopener noreferrer">Jameson Bell</a>
        </div>
        <div class="footer-attribution">
            Data: <a href="https://data.sa.gov.au" target="_blank" rel="noopener noreferrer">Data SA</a> | &copy; 2026
        </div>
    </footer>

    <script>
        // Info modal functions
        function openInfoModal(modalId) {
            document.getElementById(modalId).classList.add('show');
            document.body.style.overflow = 'hidden';
        }

        function closeInfoModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            document.body.style.overflow = 'auto';
        }

        // Close modal when clicking outside
        window.addEventListener('click', function(event) {
            if (event.target.classList.contains('info-modal')) {
                closeInfoModal(event.target.id);
            }
        });

        // Close modal with Escape key
        window.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                document.querySelectorAll('.info-modal.show').forEach(modal => {
                    closeInfoModal(modal.id);
                });
                // Also close analytics fullscreen
                const analyticsPanel = document.getElementById('analyticsPanel');
                if (analyticsPanel && analyticsPanel.classList.contains('fullscreen')) {
                    analyticsPanel.classList.remove('fullscreen');
                    analyticsPanel.classList.add('collapsed');
                }
            }
        });

        // Checkbox filter functions
        function selectAllCheckboxes(groupName) {
            const checkboxes = document.querySelectorAll(`#${groupName}Checkboxes input[type="checkbox"]`);
            checkboxes.forEach(cb => {
                cb.checked = true;
            });
        }

        function clearAllCheckboxes(groupName) {
            const checkboxes = document.querySelectorAll(`#${groupName}Checkboxes input[type="checkbox"]`);
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
        }

        // Checkbox dropdown functions
        function toggleCheckboxDropdown(dropdownId) {
            const menu = document.getElementById(`${dropdownId}Menu`);
            const trigger = menu.previousElementSibling;
            const arrow = trigger.querySelector('.dropdown-arrow');

            // Close all other dropdowns and clear their searches
            document.querySelectorAll('.checkbox-dropdown-menu').forEach(m => {
                if (m !== menu && m.classList.contains('show')) {
                    m.classList.remove('show');
                    const otherArrow = m.previousElementSibling.querySelector('.dropdown-arrow');
                    if (otherArrow) otherArrow.style.transform = 'rotate(0deg)';
                    // Clear search in the closed dropdown
                    const otherSearch = m.querySelector('.dropdown-search');
                    if (otherSearch && otherSearch.value) {
                        otherSearch.value = '';
                        m.querySelectorAll('.checkbox-dropdown-item').forEach(item => item.style.display = '');
                    }
                }
            });

            // Toggle current dropdown
            if (menu.classList.contains('show')) {
                menu.classList.remove('show');
                arrow.style.transform = 'rotate(0deg)';
                // Clear search when closing
                const search = menu.querySelector('.dropdown-search');
                if (search && search.value) {
                    search.value = '';
                    menu.querySelectorAll('.checkbox-dropdown-item').forEach(item => item.style.display = '');
                }
            } else {
                menu.classList.add('show');
                arrow.style.transform = 'rotate(180deg)';
                // Focus search input when opening
                const search = menu.querySelector('.dropdown-search');
                if (search) setTimeout(() => search.focus(), 50);
            }
        }

        function filterDropdownItems(dropdownId, query) {
            const menu = document.getElementById(`${dropdownId}Menu`);
            if (!menu) return;
            const q = query.trim().toLowerCase();
            menu.querySelectorAll('.checkbox-dropdown-item').forEach(function(item) {
                const label = item.querySelector('label');
                const text = label ? label.textContent.toLowerCase() : '';
                item.style.display = (q === '' || text.includes(q)) ? '' : 'none';
            });
        }

        function updateCheckboxDropdownDisplay(dropdownId) {
            const menu = document.getElementById(`${dropdownId}Menu`);
            const display = document.getElementById(`${dropdownId}Display`);
            const checkboxes = menu.querySelectorAll('input[type="checkbox"]:checked');

            if (checkboxes.length === 0 || checkboxes.length === menu.querySelectorAll('input[type="checkbox"]').length) {
                if (dropdownId === 'crashType') {
                    display.textContent = 'All Types';
                } else if (dropdownId === 'area') {
                    display.textContent = 'All Areas';
                } else if (dropdownId === 'severity') {
                    display.textContent = 'All Severities';
                }
            } else if (checkboxes.length === 1) {
                display.textContent = checkboxes[0].nextElementSibling.textContent;
            } else {
                display.textContent = `${checkboxes.length} selected`;
            }
        }

        function selectAllDropdownItems(dropdownId) {
            const menu = document.getElementById(`${dropdownId}Menu`);
            const checkboxes = menu.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = true;
            });
            updateCheckboxDropdownDisplay(dropdownId);
        }

        function clearAllDropdownItems(dropdownId) {
            const menu = document.getElementById(`${dropdownId}Menu`);
            const checkboxes = menu.querySelectorAll('input[type="checkbox"]');
            checkboxes.forEach(cb => {
                cb.checked = false;
            });
            updateCheckboxDropdownDisplay(dropdownId);
        }

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(event) {
            if (!event.target.closest('.checkbox-dropdown')) {
                document.querySelectorAll('.checkbox-dropdown-menu').forEach(menu => {
                    if (menu.classList.contains('show')) {
                        menu.classList.remove('show');
                        const arrow = menu.previousElementSibling.querySelector('.dropdown-arrow');
                        if (arrow) arrow.style.transform = 'rotate(0deg)';
                        // Clear search on close
                        const search = menu.querySelector('.dropdown-search');
                        if (search && search.value) {
                            search.value = '';
                            menu.querySelectorAll('.checkbox-dropdown-item').forEach(item => item.style.display = '');
                        }
                    }
                });
            }
        });

        // Placeholder for updateResultCount (can be implemented in app.js if needed)
        function updateResultCount() {
            // This can be implemented in app.js when crash data is loaded
        }

        // Analytics panel toggle - opens fullscreen
        function toggleAnalyticsPanel() {
            const panel = document.getElementById('analyticsPanel');
            if (panel.classList.contains('fullscreen')) return; // Click on header in fullscreen does nothing

            panel.classList.remove('collapsed');
            panel.classList.add('fullscreen');

            // Resize all charts after transition to fit new dimensions
            setTimeout(() => {
                Object.values(charts).forEach(chart => {
                    if (chart) chart.resize();
                });
            }, 50);
        }

        // Close analytics panel back to collapsed state
        function closeAnalyticsPanel(event) {
            event.stopPropagation(); // Prevent triggering toggleAnalyticsPanel
            const panel = document.getElementById('analyticsPanel');
            panel.classList.remove('fullscreen');
            panel.classList.add('collapsed');
        }

        // Chart instances
        let charts = {
            crashesOverTime: null,
            crashesByDay: null,
            crashesByHour: null,
            severityDistribution: null
        };

        // Current aggregation mode for Crashes Over Time
        let crashesOverTimeMode = 'yearly';

        // Show/hide the year filter banner based on whether the slider is on a single year
        function updateYearChip() {
            var banner = document.getElementById('yearFilterBanner');
            var label = document.getElementById('yearBannerLabel');
            if (!banner) return;
            var sliderEl = document.getElementById('yearRangeSlider');
            var slider = sliderEl && sliderEl.noUiSlider;
            if (!slider) { banner.style.display = 'none'; return; }
            var vals = slider.get();
            var from = parseInt(vals[0]), to = parseInt(vals[1]);
            if (from === to) {
                label.textContent = from;
                banner.style.display = 'flex';
            } else {
                banner.style.display = 'none';
            }
        }

        // Clear the year chip and restore full year range
        function clearYearChip() {
            var sliderEl = document.getElementById('yearRangeSlider');
            var slider = sliderEl && sliderEl.noUiSlider;
            if (slider) {
                slider.set([2012, 2024]);
                if (typeof applyFilters === 'function') applyFilters();
            }
        }

        // Toggle Crashes Over Time between yearly and monthly
        function setOverTimeMode(mode) {
            crashesOverTimeMode = mode;
            document.getElementById('btnYearly').classList.toggle('active', mode === 'yearly');
            document.getElementById('btnMonthly').classList.toggle('active', mode === 'monthly');
            if (window._lastCrashData) updateChartsWithData(window._lastCrashData);
        }

        // Format hour as "12am", "1am", "12pm", "1pm" etc.
        function formatHourLabel(h) {
            if (h === 0) return '12am';
            if (h < 12) return h + 'am';
            if (h === 12) return '12pm';
            return (h - 12) + 'pm';
        }

        // Interpolate between two hex colours (ratio 0‚Üí1)
        function interpolateColor(hex1, hex2, ratio) {
            const r1 = parseInt(hex1.slice(1,3),16), g1 = parseInt(hex1.slice(3,5),16), b1 = parseInt(hex1.slice(5,7),16);
            const r2 = parseInt(hex2.slice(1,3),16), g2 = parseInt(hex2.slice(3,5),16), b2 = parseInt(hex2.slice(5,7),16);
            return 'rgb(' + Math.round(r1+(r2-r1)*ratio) + ',' + Math.round(g1+(g2-g1)*ratio) + ',' + Math.round(b1+(b2-b1)*ratio) + ')';
        }

        // Gradient colour array from low‚Üíhigh colour based on relative values
        function gradientColors(data, lowHex, highHex) {
            const max = Math.max.apply(null, data) || 1;
            return data.map(function(v) { return interpolateColor(lowHex, highHex, v / max); });
        }

        // Tooltip callback: show count + % of dataset total (skip avg reference line)
        function pctTooltip(context) {
            if (context.dataset.label === 'Avg') {
                return ' Avg: ' + Math.round(context.raw).toLocaleString() + ' crashes';
            }
            const value = context.raw;
            const total = context.dataset.data.reduce(function(a, b) { return a + b; }, 0);
            const pct = total > 0 ? ((value / total) * 100).toFixed(1) : '0.0';
            return ' ' + value.toLocaleString() + ' crashes (' + pct + '%)';
        }

        const MONTH_ABBR = ['','Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];

        // Initialize charts
        function initializeCharts() {
            const tooltipPlugin = { tooltip: { callbacks: { label: pctTooltip } } };
            const baseScales  = { y: { beginAtZero: true } };

            // Crashes Over Time - line chart (click point in yearly mode ‚Üí jump to that year)
            const ctxTime = document.getElementById('crashesOverTimeChart');
            if (ctxTime) {
                charts.crashesOverTime = new Chart(ctxTime, {
                    type: 'line',
                    data: {
                        labels: [],
                        datasets: [{
                            label: 'Crashes',
                            data: [],
                            borderColor: '#4a90e2',
                            backgroundColor: 'rgba(74,144,226,0.1)',
                            tension: 0.4,
                            fill: true,
                            pointRadius: 4,
                            pointHoverRadius: 6
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, ...tooltipPlugin },
                        scales: baseScales,
                        interaction: { mode: 'nearest', intersect: false },
                        onHover: function(event, elements) {
                            event.native.target.style.cursor = (elements.length > 0 && crashesOverTimeMode === 'yearly') ? 'pointer' : 'default';
                        },
                        onClick: function(event, elements, chart) {
                            if (crashesOverTimeMode !== 'yearly') return;
                            // Use nearest-point detection so click doesn't have to land exactly on the dot
                            var nearest = chart.getElementsAtEventForMode(event, 'nearest', { intersect: false }, true);
                            if (nearest.length === 0) return;
                            var year = parseInt(chart.data.labels[nearest[0].index]);
                            if (isNaN(year)) return;
                            // Access the noUiSlider instance via the element's .noUiSlider property
                            // (window.yearRangeSlider would be the DOM element, not the slider API)
                            var sliderEl = document.getElementById('yearRangeSlider');
                            var slider = sliderEl && sliderEl.noUiSlider;
                            if (slider) {
                                if (currentYearRange[0] === year && currentYearRange[1] === year) {
                                    slider.set([2012, 2024]);
                                } else {
                                    slider.set([year, year]);
                                }
                                // Slider update event only refreshes the display ‚Äî trigger the filter manually
                                if (typeof applyFilters === 'function') applyFilters();
                            }
                        }
                    }
                });
            }

            // Crashes by Day of Week - weekend bars in amber, weekdays in blue
            const ctxDay = document.getElementById('crashesByDayChart');
            if (ctxDay) {
                const dayColors = ['#ffa726','#4a90e2','#4a90e2','#4a90e2','#4a90e2','#4a90e2','#ffa726'];
                const avgLineStyle = {
                    type: 'line', label: 'Avg',
                    data: Array(7).fill(0),
                    borderColor: 'rgba(140,140,140,0.65)',
                    borderDash: [5, 4], borderWidth: 1.5,
                    pointRadius: 0, fill: false, tension: 0
                };
                charts.crashesByDay = new Chart(ctxDay, {
                    type: 'bar',
                    data: {
                        labels: ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'],
                        datasets: [
                            { label: 'Crashes', data: [0,0,0,0,0,0,0], backgroundColor: dayColors },
                            avgLineStyle
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    generateLabels: function() {
                                        return [
                                            { text: 'Weekday', fillStyle: '#4a90e2', strokeStyle: '#4a90e2', lineWidth: 0 },
                                            { text: 'Weekend', fillStyle: '#ffa726', strokeStyle: '#ffa726', lineWidth: 0 }
                                        ];
                                    }
                                }
                            },
                            ...tooltipPlugin
                        },
                        scales: baseScales
                    }
                });
            }

            // Crashes by Hour - gradient blue‚Üíred, 12-hour labels, avg reference line
            const ctxHour = document.getElementById('crashesByHourChart');
            if (ctxHour) {
                charts.crashesByHour = new Chart(ctxHour, {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: 24}, function(_, i) { return formatHourLabel(i); }),
                        datasets: [
                            { label: 'Crashes', data: Array(24).fill(0), backgroundColor: Array(24).fill('#4a90e2') },
                            { type: 'line', label: 'Avg', data: Array(24).fill(0),
                              borderColor: 'rgba(140,140,140,0.65)', borderDash: [5,4],
                              borderWidth: 1.5, pointRadius: 0, fill: false, tension: 0 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, ...tooltipPlugin },
                        scales: baseScales
                    }
                });
            }

            // Severity Distribution - doughnut with legend + click-to-filter
            const ctxSeverity = document.getElementById('severityDistributionChart');
            if (ctxSeverity) {
                charts.severityDistribution = new Chart(ctxSeverity, {
                    type: 'doughnut',
                    data: {
                        labels: ['PDO', 'Minor Injury', 'Serious Injury', 'Fatal'],
                        datasets: [{ data: [0,0,0,0], backgroundColor: ['#90caf9','#ffa726','#ef5350','#ab47bc'] }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: true, position: 'bottom' }, ...tooltipPlugin },
                        onClick: function(event, elements) {
                            if (elements.length === 0) return;
                            var severityMap = ['1: PDO', '2: MI', '3: SI', '4: Fatal'];
                            var severityIds = ['severity-pdo', 'severity-mi', 'severity-si', 'severity-fatal'];
                            var clickedValue = severityMap[elements[0].index];
                            var checkboxes = severityIds.map(function(id) { return document.getElementById(id); }).filter(Boolean);
                            var checkedValues = checkboxes.filter(function(cb) { return cb.checked; }).map(function(cb) { return cb.value; });
                            // Toggle: if already solo-selected, restore all; otherwise solo-select
                            if (checkedValues.length === 1 && checkedValues[0] === clickedValue) {
                                checkboxes.forEach(function(cb) { cb.checked = true; });
                            } else {
                                checkboxes.forEach(function(cb) { cb.checked = (cb.value === clickedValue); });
                            }
                            if (typeof updateCheckboxDropdownDisplay === 'function') updateCheckboxDropdownDisplay('severity');
                            if (typeof applyFilters === 'function') applyFilters();
                        }
                    }
                });
            }
        }

        // Initialize charts when page loads
        window.addEventListener('load', function() {
            if (typeof Chart !== 'undefined') initializeCharts();
        });

        // Update charts with filtered data (called from app.js)
        function updateChartsWithData(crashData) {
            if (!crashData || crashData.length === 0) return;
            window._lastCrashData = crashData; // cache for toggle re-render
            updateYearChip(); // keep chip in sync with current slider state

            // ‚îÄ‚îÄ Crashes Over Time ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            if (crashesOverTimeMode === 'yearly') {
                const yearCounts = {};
                crashData.forEach(function(crash) {
                    var y = String(crash['Year']);
                    if (y) yearCounts[y] = (yearCounts[y] || 0) + 1;
                });
                var sortedYears = Object.keys(yearCounts).sort();
                if (charts.crashesOverTime && sortedYears.length > 0) {
                    charts.crashesOverTime.data.labels = sortedYears;
                    charts.crashesOverTime.data.datasets[0].data = sortedYears.map(function(y) { return yearCounts[y]; });
                    charts.crashesOverTime.update();
                }
            } else {
                // Monthly - zero-pad month so "2012-01" sorts before "2012-10"
                var monthCounts = {};
                crashData.forEach(function(crash) {
                    var dt = crash['Crash Date Time'];
                    if (dt) {
                        var dp = dt.split(' ')[0].split('/');
                        if (dp.length === 3) {
                            var key = dp[2] + '-' + String(parseInt(dp[1])).padStart(2, '0');
                            monthCounts[key] = (monthCounts[key] || 0) + 1;
                        }
                    }
                });
                var sortedKeys = Object.keys(monthCounts).sort();
                var labels = sortedKeys.map(function(k) {
                    var p = k.split('-');
                    return MONTH_ABBR[parseInt(p[1])] + " '" + p[0].slice(2);
                });
                if (charts.crashesOverTime && sortedKeys.length > 0) {
                    charts.crashesOverTime.data.labels = labels;
                    charts.crashesOverTime.data.datasets[0].data = sortedKeys.map(function(k) { return monthCounts[k]; });
                    charts.crashesOverTime.update();
                }
            }

            // ‚îÄ‚îÄ Crashes by Day of Week ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            // Use 'Day' column directly ‚Äî accurate for all years
            var dayNameToIndex = { 'Sunday':0,'Monday':1,'Tuesday':2,'Wednesday':3,'Thursday':4,'Friday':5,'Saturday':6 };
            var dayCounts = [0,0,0,0,0,0,0];
            crashData.forEach(function(crash) {
                var d = crash['Day'];
                if (d && dayNameToIndex.hasOwnProperty(d)) dayCounts[dayNameToIndex[d]]++;
            });
            if (charts.crashesByDay) {
                charts.crashesByDay.data.datasets[0].data = dayCounts;
                var dayAvg = Math.round(dayCounts.reduce(function(a,b){return a+b;},0) / 7);
                charts.crashesByDay.data.datasets[1].data = Array(7).fill(dayAvg);
                charts.crashesByDay.update();
            }

            // ‚îÄ‚îÄ Crashes by Hour ‚Äî gradient blue‚Üíred ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            var hourCounts = Array(24).fill(0);
            crashData.forEach(function(crash) {
                var dt = crash['Crash Date Time'];
                if (dt) {
                    var tp = dt.split(' ')[1];
                    if (tp) {
                        var h = parseInt(tp.split(':')[0]);
                        if (!isNaN(h) && h >= 0 && h < 24) hourCounts[h]++;
                    }
                }
            });
            if (charts.crashesByHour) {
                charts.crashesByHour.data.datasets[0].data = hourCounts;
                charts.crashesByHour.data.datasets[0].backgroundColor = gradientColors(hourCounts, '#4a90e2', '#ef5350');
                var hourAvg = Math.round(hourCounts.reduce(function(a,b){return a+b;},0) / 24);
                charts.crashesByHour.data.datasets[1].data = Array(24).fill(hourAvg);
                charts.crashesByHour.update();
            }

            // ‚îÄ‚îÄ Severity Distribution ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
            var sev = { PDO: 0, Minor: 0, Serious: 0, Fatal: 0 };
            crashData.forEach(function(crash) {
                var s = crash['CSEF Severity'] || '';
                if (s.includes('PDO') || s.includes('1:'))        sev.PDO++;
                else if (s.includes('MI') || s.includes('2:'))  sev.Minor++;
                else if (s.includes('SI') || s.includes('3:'))  sev.Serious++;
                else if (s.includes('Fatal') || s.includes('4:')) sev.Fatal++;
            });
            if (charts.severityDistribution) {
                charts.severityDistribution.data.datasets[0].data = [sev.PDO, sev.Minor, sev.Serious, sev.Fatal];
                charts.severityDistribution.update();
            }
        }

        // Make functions available globally for app.js
        window.updateChartsWithData = updateChartsWithData;
        window.updateResultCount = updateResultCount;
    </script>
</body>
</html>
